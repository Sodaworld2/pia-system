# PIA System Journal | 2026-02-12
## Session: Cross-Machine Communication & Alive Repos

---

## Who Is Reading This

If you are a Claude instance picking this up - READ THIS ENTIRE FILE before doing anything.
This journal contains the full context of what PIA is, what was built today, the architecture,
the user's vision, and what needs to happen next. The user (mic) wants you to have MAXIMUM
context before you start working.

---

## The Big Picture - What PIA Is

**PIA (Project Intelligence Agent)** is a multi-machine, multi-channel AI orchestration system.

The vision:
> "Each computer will have one of your descendants but you will help rule them all"

```
                    ┌─────────────────┐
                    │   YOU (Human)   │
                    │  Discord/Email  │
                    │   Web Chat      │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   ORCHESTRATOR  │
                    │  (Master Claude)│
                    │   PIA Hub       │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
 ┌──────▼──────┐     ┌──────▼──────┐     ┌──────▼──────┐
 │  MACHINE 1  │     │  MACHINE 2  │     │  MACHINE 3  │
 │   Claude    │     │   Claude    │     │   Claude    │
 │  (DAO)      │     │  (Wingspan) │     │  (Farcake)  │
 └─────────────┘     └─────────────┘     └─────────────┘
```

The user has MULTIPLE computers and MULTIPLE repositories. They want:
1. Every repo to be "alive" - it has an identity, knowledge base, task queue, and job history
2. Any repo can ask any other repo to do something ("DAO, deploy" or "Wingspan, update the deck")
3. PIA hub is the central controller that routes tasks and tracks everything
4. An n8n-like visual interface showing processes, machines, repos, and task flows
5. Always-on infrastructure - machines stay connected, repos stay alive

---

## What Exists - The Full System (84% Complete)

### Hub Machine: izzit7 (This Computer)
- **Tailscale IP**: 100.73.133.3
- **PIA API**: http://localhost:3000 (or http://100.73.133.3:3000 via Tailscale)
- **WebSocket**: ws://localhost:3001
- **API Token**: pia-local-dev-token-2024
- **OS**: Windows 11 Pro

### Core Infrastructure (All Built & Working)

| Component | File(s) | Status |
|-----------|---------|--------|
| Express API Server | `src/api/server.ts` | Complete |
| WebSocket Server | `src/tunnel/websocket-server.ts` | Complete |
| SQLite Database | `src/db/database.ts` | Complete |
| Auth + Rate Limiting | Helmet, JWT, express-rate-limit | Complete |
| Agent Management | `src/api/routes/agents.ts` | Complete |
| Machine Management | `src/api/routes/machines.ts` | Complete |
| Session Management (PTY) | `src/api/routes/sessions.ts` | Complete |
| Alert System | `src/api/routes/alerts.ts` | Complete |
| MCP Management | `src/api/routes/mcps.ts` | Complete |
| AI Router (cost-conscious) | `src/ai/ai-router.ts` | Complete |
| Cost Tracker | `src/ai/cost-tracker.ts` | Complete |
| Multi-Model Panel | `src/ai/multi-model-panel.ts` | Complete |
| Auto-Healer (Doctor) | `src/agents/doctor.ts` | Complete |
| Agent Factory | `src/agents/agent-factory.ts` | Complete |
| Task Queue | `src/orchestrator/task-queue.ts` | Complete |
| Execution Engine | `src/orchestrator/execution-engine.ts` | Complete |
| Heartbeat Service | `src/orchestrator/heartbeat.ts` | Complete |
| Hub Aggregator | `src/hub/aggregator.ts` | Complete |
| Hub Client (local mode) | `src/local/hub-client.ts` | Complete |
| Orchestrator | `src/comms/orchestrator.ts` | Complete |
| Discord Bot | `src/comms/discord-bot.ts` | Ready (needs token) |
| Agent Bus | `src/comms/agent-bus.ts` | Complete |
| PWA Support | `public/manifest.json`, `public/sw.js` | Complete |

### Dashboard (public/index.html + public/js/app.js)

11 views, all working:
1. **Fleet Matrix** - Visual grid of all agents with status tiles
2. **Command Center** - Web chat with Orchestrator
3. **CLI Tunnel** - Terminal sessions via xterm.js
4. **MCPs** - Install/manage MCP servers
5. **Hooks** - Lifecycle hooks dashboard
6. **Alerts** - System notifications (508 currently)
7. **AI Models** - Cost tracking, provider status (Ollama, Gemini, OpenAI, Grok)
8. **Tasks** - Task queue management
9. **Agent Bus** - Inter-agent messaging
10. **Doctor** - Auto-healing stuck agents
11. **Delegation** - Task delegation rules

### Database Schema (SQLite)
Tables: machines, agents, sessions, session_output, tasks, alerts, watched_docs, checkpoints

### Observed System State
```
Machines:        1 registered
Agents:          8 active
CLI Sessions:    38 available
MCPs Installed:  8
Alerts:          508 (need clearing)
WebSocket:       Connected
Ollama:          Available (qwen2.5-coder:7b)
AI Cost Today:   $0.00
```

---

## What Was Built TODAY (2026-02-12)

### 1. Cross-Machine Communication Layer

Four channels, all working:

#### Tailscale (Direct Private Network)
- Already installed on hub machine (v1.92.5)
- Hub Tailscale IP: `100.73.133.3`
- Devices on the network: izzit7 (online), 3 others (offline)
- Remote machines install Tailscale, login same account, instant access

#### Ngrok (Public Tunnel)
- Installed via winget (v3.3.1)
- Launch script: `scripts/start-tunnel.cmd`
- Creates a public URL that forwards to localhost:3000
- For machines that can't use Tailscale

#### WebSocket Relay
- **File**: `src/comms/cross-machine.ts` (CrossMachineRelay class)
- Added message types to WebSocket server: `relay:register`, `relay:send`, `relay:broadcast`
- Remote machines connect via WS to port 3001, authenticate, register, then send/receive messages in real-time
- **File**: `src/tunnel/websocket-server.ts` (updated with relay handlers)

#### REST API Relay
- **File**: `src/api/routes/relay.ts`
- Endpoints:
  - `POST /api/relay/register` - Register a remote machine
  - `POST /api/relay/send` - Send message to a machine
  - `POST /api/relay/broadcast` - Broadcast to all
  - `GET /api/relay/machines` - List connected machines
  - `GET /api/relay/messages` - Message history
  - `GET /api/relay/poll/:machineId` - HTTP polling fallback
  - `GET /api/relay/stats` - Relay statistics

### 2. Alive Repo System

The core concept: every repository becomes an autonomous agent.

#### The .pia/ Directory Pattern

Each repo that's "alive" has a `.pia/` directory:
```
my-repo/
  .pia/
    identity.json        # WHO this repo is (name, capabilities, tech stack)
    knowledge/           # WHAT it knows
      agent-identity.md  # Claude context doc
      readme-summary.md  # Auto-extracted from README
      dependencies.md    # Auto-extracted from package.json
      structure.md       # Auto-generated directory tree
      custom/            # Human-added knowledge
    jobs/
      history.jsonl      # EVERY job ever done (append-only log)
    queue/
      pending.json       # Incoming tasks waiting to be executed
    hooks/
      on-task.md         # How to handle incoming tasks
      on-health.md       # How to handle health checks
    state.json           # Current status (idle/working/error/offline)
    log/                 # Daily activity logs
```

#### identity.json Format
```json
{
  "name": "wingspan",
  "displayName": "Wingspan",
  "description": "Handles coding passwords and presentations",
  "capabilities": ["presentations", "passwords", "docs", "slides", "credentials"],
  "techStack": ["Node.js", "PowerPoint"],
  "hubUrl": "http://100.73.133.3:3000",
  "hubToken": "pia-local-dev-token-2024",
  "machineId": "machine-izzit7",
  "machineName": "izzit7",
  "port": 0,
  "acceptsTasksFrom": ["*"],
  "autoStart": true
}
```

#### Init Script: `scripts/init-repo.cjs`
- Run in any repo to create `.pia/`
- Auto-detects tech stack (Node.js, Next.js, React, Python, Rust, Solidity, etc.)
- Auto-generates knowledge base from README, package.json, directory structure
- Creates agent identity document for Claude context
- Interactive or CLI: `node init-repo.cjs --name dao --capabilities "deploy,test"`

#### Repo Agent: `scripts/repo-agent.cjs`
- Runs inside a repo with `.pia/`
- Registers with PIA hub on startup
- Polls hub for assigned tasks every 5 seconds
- Watches `.pia/queue/pending.json` for local tasks
- Executes tasks and logs to `.pia/jobs/history.jsonl`
- Reports state back to hub continuously
- Optional local HTTP API on a configurable port
- Graceful shutdown (marks as offline)

#### Repo Router (Hub Side): `src/comms/repo-router.ts`
- RepoRouter class - registry and task routing
- Registers repos by identity
- Routes tasks to repos (via cross-machine relay or agent bus)
- Tracks ALL jobs globally with full history
- Capability-based discovery ("who can deploy?" → DAO, Farcake)
- Real-time event subscriptions
- Counters per repo (jobs completed, jobs failed)

#### Repos API: `src/api/routes/repos.ts`
- `POST /api/repos/register` - Register a repo
- `GET /api/repos` - List all alive repos
- `GET /api/repos/stats` - Global statistics
- `GET /api/repos/:name` - Repo details + recent jobs
- `GET /api/repos/:name/state` - Repo state
- `PUT /api/repos/:name/state` - Update state (heartbeat)
- `POST /api/repos/:name/task` - Send a task to a repo
- `GET /api/repos/:name/jobs` - Job history
- `GET /api/repos/:name/jobs/:jobId` - Specific job
- `PUT /api/repos/:name/jobs/:jobId` - Update job status (repo reports back)
- `GET /api/repos/jobs/all` - All jobs across all repos
- `GET /api/repos/find/:capability` - Find repos by capability

### 3. Scripts for Remote Machines

| Script | Purpose |
|--------|---------|
| `scripts/remote-connect.cjs` | Interactive terminal connector (WebSocket + HTTP polling) |
| `scripts/start-tunnel.cmd` | One-click ngrok tunnel launcher |
| `scripts/init-repo.cjs` | Initialize .pia/ in any repo |
| `scripts/repo-agent.cjs` | Run the alive agent in a repo |

### 4. Documentation

| File | Purpose |
|------|---------|
| `REMOTE_SETUP.md` | Human-readable setup guide for other machines |
| `REMOTE-CLAUDE-SETUP.md` | Instructions for Claude on other machines (read & execute) |
| `JOURNAL_2026-02-12.md` | This file - full session context |

---

## Live Test Results

Everything was tested and confirmed working:

### Repos Registered
```json
{
  "totalRepos": 3,
  "repos": [
    {"name": "wingspan", "displayName": "Wingspan", "machine": "izzit7",
     "capabilities": ["presentations","passwords","docs","slides","credentials"]},
    {"name": "dao", "displayName": "DAO", "machine": "DAO Machine",
     "capabilities": ["smart-contracts","deploy","test","governance","tokenomics"]},
    {"name": "farcake", "displayName": "Farcake", "machine": "izzit7",
     "capabilities": ["deploy","build","test","social-features","ai-generation"]}
  ]
}
```

### Jobs Queued
```json
[
  {"repoName": "wingspan", "action": "update-credentials",
   "description": "Put the new API keys on the presentation deck",
   "requestedBy": "human", "status": "queued"},
  {"repoName": "farcake", "action": "deploy",
   "description": "Deploy latest changes to Vercel staging",
   "requestedBy": "dao", "status": "queued"}
]
```

### Capability Search Working
- "Who can deploy?" → DAO, Farcake
- "Who handles presentations?" → Wingspan

### Relay Working
```json
{
  "thisMachine": {"id": "hub-izzit7", "name": "Main PC"},
  "connectedMachines": 0,
  "totalMessages": 0
}
```

### Dashboard Confirmed Live
- Fleet Matrix showing 8 agents
- WebSocket connected
- All 11 views accessible
- Screenshot taken: `pia-dashboard-live.png`

---

## The User's Vision (In Their Words)

> "what im starting to realise is that each computer i have and each repository i want them to be alive.
> so another app can for example ask farcake to do something and farcake will cue that.
> our central controller PIA can also have always on computers.
> each repository will have an entire Agent knowledge base.
> but also we need an n8n like interface that shows us what processes are happening where and what machines."

> "for example wingspan puts coding and password on presentation, it tracks it. etc,
> i want to just be able to send it to wingspan, i want wingspan to record all the jobs it has done."

This means:
1. **Every repo is a worker with personality** - Wingspan knows about presentations and credentials.
   DAO knows about smart contracts. Farcake knows about social features.
2. **Job history is sacred** - Every task a repo executes is logged forever in `.pia/jobs/history.jsonl`.
   You can always ask "what has Wingspan done?" and get a complete answer.
3. **Inter-repo delegation** - "Hey Farcake, deploy" is a real API call that gets queued and executed.
4. **Central visibility** - PIA hub sees everything. The dashboard (and soon, the n8n-style view)
   shows all repos, all machines, all task flows, all job histories.
5. **Always on** - Machines stay connected via Tailscale. Repo agents keep running. The hub
   is the persistent brain.

---

## Architecture Overview

### Data Flow: Sending a Task

```
Human types: "Wingspan, update the deck with new API keys"
    │
    ▼
PIA Hub API: POST /api/repos/wingspan/task
    │
    ▼
Repo Router: Looks up Wingspan → machine: izzit7, status: idle
    │
    ▼
Cross-Machine Relay: Routes to Wingspan's machine via WebSocket
    │                  (or Tailscale direct, or Ngrok tunnel, or API polling)
    ▼
Repo Agent (Wingspan): Receives task, writes to .pia/queue/pending.json
    │
    ▼
Repo Agent: Dequeues task, loads .pia/knowledge/*, executes
    │
    ▼
Repo Agent: Logs result to .pia/jobs/history.jsonl
    │
    ▼
Repo Agent: Reports back to hub: PUT /api/repos/wingspan/jobs/:jobId
    │
    ▼
Hub: Updates job status, repo state, notifies dashboard via WebSocket
```

### Network Topology

```
┌─────────────────────────────────────────────────┐
│              PIA HUB (izzit7)                    │
│              100.73.133.3                        │
│                                                   │
│  ┌──────────┐  ┌───────────┐  ┌──────────────┐  │
│  │ API :3000│  │ WS :3001  │  │ Dashboard    │  │
│  │ 16 routes│  │ Relay     │  │ 11 views     │  │
│  └──────────┘  └───────────┘  └──────────────┘  │
│                                                   │
│  ┌──────────┐  ┌───────────┐  ┌──────────────┐  │
│  │ Repo     │  │ Cross-    │  │ Agent Bus    │  │
│  │ Router   │  │ Machine   │  │              │  │
│  │          │  │ Relay     │  │              │  │
│  └──────────┘  └───────────┘  └──────────────┘  │
│                                                   │
│  ┌──────────┐  ┌───────────┐  ┌──────────────┐  │
│  │ SQLite   │  │ Task      │  │ Doctor       │  │
│  │ Database │  │ Queue     │  │ (auto-heal)  │  │
│  └──────────┘  └───────────┘  └──────────────┘  │
└───────────┬─────────────────────────┬────────────┘
            │ Tailscale / Ngrok / WS  │
            │                         │
┌───────────▼──────────┐  ┌──────────▼───────────┐
│  MACHINE 2 (DAO)     │  │  MACHINE 3 (future)  │
│                      │  │                      │
│  ┌────────────────┐  │  │  ┌────────────────┐  │
│  │ DAO Repo       │  │  │  │ Another Repo   │  │
│  │ .pia/          │  │  │  │ .pia/          │  │
│  │ repo-agent.cjs │  │  │  │ repo-agent.cjs │  │
│  └────────────────┘  │  │  └────────────────┘  │
│                      │  │                      │
│  ┌────────────────┐  │  │                      │
│  │ Other Repo     │  │  │                      │
│  │ .pia/          │  │  │                      │
│  │ repo-agent.cjs │  │  │                      │
│  └────────────────┘  │  │                      │
└──────────────────────┘  └──────────────────────┘
```

---

## File Map (What's Where)

### New Files Created Today
```
src/comms/cross-machine.ts       # Cross-machine relay (machine registry, message routing)
src/comms/repo-router.ts         # Repo registry, task routing, job tracking
src/api/routes/relay.ts          # REST API for cross-machine messaging
src/api/routes/repos.ts          # REST API for alive repos
scripts/init-repo.cjs            # Initialize .pia/ in any repo
scripts/repo-agent.cjs           # Run alive agent in a repo
scripts/remote-connect.cjs       # Interactive relay connector
scripts/start-tunnel.cmd         # Ngrok tunnel launcher
REMOTE_SETUP.md                  # Human setup guide
REMOTE-CLAUDE-SETUP.md           # Claude setup instructions
JOURNAL_2026-02-12.md            # This file
```

### Modified Files Today
```
src/tunnel/websocket-server.ts   # Added relay:register/send/broadcast handlers
src/api/server.ts                # Added relay + repos routes
src/index.ts                     # Added CrossMachineRelay + RepoRouter init
```

### Key Existing Files
```
src/api/server.ts                # Main Express server (16 route groups)
src/tunnel/websocket-server.ts   # WebSocket server (terminal + relay)
src/comms/agent-bus.ts           # Inter-agent messaging
src/comms/orchestrator.ts        # Master Claude logic
src/comms/discord-bot.ts         # Discord bot (ready, needs token)
src/orchestrator/task-queue.ts   # Priority task queue (SQLite-backed)
src/orchestrator/execution-engine.ts # Task execution
src/agents/doctor.ts             # Auto-healer
src/agents/agent-factory.ts      # Template-based agent creation
src/hub/aggregator.ts            # Hub-side machine/agent aggregation
src/local/hub-client.ts          # Local machine → Hub connection
src/local/service.ts             # PIA local service
src/db/database.ts               # SQLite init + migrations
src/config.ts                    # Configuration from .env
public/index.html                # Dashboard HTML
public/js/app.js                 # Dashboard JavaScript (~1200 lines)
public/css/styles.css            # Dashboard styles (~1500 lines)
.env                             # Environment config
```

---

## What's NOT Built Yet

### Priority 1 (Next Session)
- [ ] **n8n-style Workflow Dashboard View** - Visual node map of repos with task flow edges
- [ ] **Process Timeline View** - Gantt-like view of job execution across repos
- [ ] **Actually connect the DAO machine** - User is going to clone PIA there

### Priority 2
- [ ] **Discord Bot wiring** - Code exists (`src/comms/discord-bot.ts`), needs DISCORD_TOKEN in .env
- [ ] **Repo Agent → Claude execution** - Currently repo-agent.cjs acknowledges tasks but doesn't invoke Claude. Need to wire up actual execution (spawn Claude with knowledge base context)
- [ ] **Clear 508 alerts** - Dashboard shows 508 accumulated alerts

### Priority 3
- [ ] **PM2 / Windows Service** - Always-on process management
- [ ] **Email integration** - AgentMail for async communication
- [ ] **Knowledge base sync** - When repo code changes, auto-update .pia/knowledge/

---

## Git Status

Branch: master
Last commit: `0addf0c izzit`

Uncommitted changes: 21 modified + 50+ untracked files including all the new cross-machine and alive repo code.

### Recent Commit History
```
0addf0c izzit
d3c2107 feat(PIA-025): Complete Documentation
cb77767 feat(PIA-024): Security Hardening
35fc5a8 feat(PIA-019 to PIA-021): Complete Auto-Healer System
befb614 feat(PIA-016, PIA-017): Complete Mobile PWA Support
80928ad feat(PIA-012 to PIA-015): Complete Phase 3 - Multi-Machine Support
c710cce docs: Add PROGRESS.md tracking development status
e1b82b4 docs: Update ticket tracker - Phase 1 & 2 complete
cc7376e feat: Implement PIA core backend and dashboard (PIA-001 to PIA-011)
```

---

## How To Start Working

### On the Hub Machine (izzit7)
```bash
cd C:\Users\mic\Downloads\pia-system
npm run build
npm start
# Dashboard at http://localhost:3000
# API at http://localhost:3000/api
# WebSocket at ws://localhost:3001
```

### On a Remote Machine
```bash
# Read REMOTE-CLAUDE-SETUP.md and follow steps
# Or quick start:
npm install && npm run build
node scripts/init-repo.cjs --name <repo-name> --capabilities "<caps>"
node scripts/repo-agent.cjs
```

### Test Everything
```bash
TOKEN="pia-local-dev-token-2024"

# Health
curl -H "X-Api-Token: $TOKEN" http://localhost:3000/api/health

# List repos
curl -H "X-Api-Token: $TOKEN" http://localhost:3000/api/repos

# Send task
curl -X POST http://localhost:3000/api/repos/wingspan/task \
  -H "X-Api-Token: $TOKEN" -H "Content-Type: application/json" \
  -d '{"action":"test","description":"Test task"}'

# Check jobs
curl -H "X-Api-Token: $TOKEN" http://localhost:3000/api/repos/wingspan/jobs

# Relay stats
curl -H "X-Api-Token: $TOKEN" http://localhost:3000/api/relay/stats
```

---

## User Notes

- **User**: mic
- **Working style**: Prefers ACTION, wants to SEE results, values journaling
- **OS**: Windows 11 Pro on all machines
- **GPU**: RTX 3070 Ti (8GB VRAM) - runs qwen2.5-coder:7b via Ollama
- **Tailscale account**: mic@ (shared across machines)
- **Active projects**: PIA, DAO, Farcake, Wingspan, and others
- **Goal**: Every repo alive, every machine connected, full visibility of all processes

---

*Journal by Claude Opus 4.6 | Hub Machine: izzit7 | 2026-02-12*
