<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIA Visor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a1a;
      color: #e0e0ff;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Header ── */
    .visor-header {
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      border-bottom: 1px solid #30363d;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .visor-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .visor-title h1 {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #58a6ff, #bc8cff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .visor-title .machine-name {
      color: #8b949e;
      font-size: 13px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f85149;
      animation: pulse 2s infinite;
    }

    .status-dot.connected { background: #3fb950; }
    .status-dot.connecting { background: #d29922; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ── Layout ── */
    .visor-body {
      display: grid;
      grid-template-columns: 1fr 350px;
      grid-template-rows: auto 1fr;
      gap: 0;
      height: calc(100vh - 52px);
    }

    /* ── Stats Bar ── */
    .stats-bar {
      grid-column: 1 / -1;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 10px 20px;
      display: flex;
      gap: 24px;
      overflow-x: auto;
    }

    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #58a6ff;
    }

    .stat-label {
      font-size: 11px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value.green { color: #3fb950; }
    .stat-value.orange { color: #d29922; }
    .stat-value.red { color: #f85149; }
    .stat-value.purple { color: #bc8cff; }

    /* ── Message Feed ── */
    .message-feed {
      padding: 16px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px 16px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.incoming { border-left: 3px solid #58a6ff; }
    .message.outgoing { border-left: 3px solid #3fb950; }
    .message.system { border-left: 3px solid #d29922; }
    .message.task { border-left: 3px solid #bc8cff; }
    .message.error { border-left: 3px solid #f85149; }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .message-from {
      font-weight: 600;
      font-size: 13px;
      color: #58a6ff;
    }

    .message-time {
      font-size: 11px;
      color: #484f58;
    }

    .message-content {
      font-size: 14px;
      line-height: 1.5;
      color: #c9d1d9;
      word-break: break-word;
    }

    .message-meta {
      margin-top: 6px;
      font-size: 11px;
      color: #484f58;
    }

    /* ── Input Bar ── */
    .input-bar {
      padding: 12px 20px;
      background: #161b22;
      border-top: 1px solid #30363d;
      display: flex;
      gap: 8px;
    }

    .input-bar input {
      flex: 1;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px 14px;
      color: #c9d1d9;
      font-size: 14px;
      outline: none;
    }

    .input-bar input:focus { border-color: #58a6ff; }

    .input-bar button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .input-bar button:hover { background: #2ea043; }

    /* ── Sidebar: Repos & Machines ── */
    .sidebar {
      background: #0d1117;
      border-left: 1px solid #30363d;
      overflow-y: auto;
      padding: 16px;
    }

    .sidebar h3 {
      font-size: 12px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .repo-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .repo-card:hover { border-color: #58a6ff; }

    .repo-card .repo-name {
      font-weight: 600;
      font-size: 14px;
      color: #e6edf3;
    }

    .repo-card .repo-desc {
      font-size: 12px;
      color: #8b949e;
      margin-top: 4px;
    }

    .repo-card .repo-status {
      display: inline-block;
      margin-top: 6px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .repo-status.idle { background: #1b3a2d; color: #3fb950; }
    .repo-status.working { background: #2a1f0f; color: #d29922; }
    .repo-status.error { background: #3d1418; color: #f85149; }
    .repo-status.offline { background: #1c1c2e; color: #484f58; }

    .repo-card .repo-jobs {
      font-size: 11px;
      color: #484f58;
      margin-top: 4px;
    }

    .repo-card .repo-caps {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .cap-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #1c2333;
      color: #58a6ff;
    }

    .machine-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .machine-card .machine-name {
      font-weight: 600;
      font-size: 13px;
    }

    .machine-card .machine-info {
      font-size: 11px;
      color: #8b949e;
    }

    .empty-state {
      text-align: center;
      color: #484f58;
      padding: 20px;
      font-size: 13px;
    }

    /* ── Notification toast ── */
    .toast {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #1f2937;
      border: 1px solid #58a6ff;
      border-radius: 8px;
      padding: 12px 20px;
      color: #e6edf3;
      font-size: 14px;
      z-index: 1000;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 4.7s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .visor-body { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>

  <div class="visor-header">
    <div class="visor-title">
      <h1>PIA VISOR</h1>
      <span class="machine-name" id="machineName">Connecting...</span>
    </div>
    <div class="connection-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
  </div>

  <div class="stats-bar" id="statsBar">
    <div class="stat"><span class="stat-value green" id="statRepos">0</span><span class="stat-label">Repos</span></div>
    <div class="stat"><span class="stat-value" id="statMachines">0</span><span class="stat-label">Machines</span></div>
    <div class="stat"><span class="stat-value purple" id="statJobs">0</span><span class="stat-label">Jobs</span></div>
    <div class="stat"><span class="stat-value orange" id="statQueued">0</span><span class="stat-label">Queued</span></div>
    <div class="stat"><span class="stat-value green" id="statCompleted">0</span><span class="stat-label">Done</span></div>
    <div class="stat"><span class="stat-value" id="statMessages">0</span><span class="stat-label">Messages</span></div>
    <div class="stat"><span class="stat-value" id="statAgents">0</span><span class="stat-label">Agents</span></div>
  </div>

  <div class="visor-body">
    <div style="display:flex;flex-direction:column;overflow:hidden;">
      <div class="message-feed" id="messageFeed">
        <div class="empty-state">Waiting for messages...</div>
      </div>
      <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Type a message to broadcast..." autocomplete="off">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <div class="sidebar">
      <h3>Alive Repos</h3>
      <div id="repoList"><div class="empty-state">Loading...</div></div>

      <h3 style="margin-top:20px;">Machines</h3>
      <div id="machineList"><div class="empty-state">Loading...</div></div>

      <h3 style="margin-top:20px;">Recent Jobs</h3>
      <div id="jobList"><div class="empty-state">Loading...</div></div>
    </div>
  </div>

<script>
// ── Config ──
const HUB_URL = location.origin;
const WS_URL = HUB_URL.replace(/^http/, 'ws').replace(/:3000/, ':3001');
const TOKEN = 'pia-local-dev-token-2024';
let ws = null;
let connected = false;
let messageCount = 0;

// ── API Helper ──
async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'X-Api-Token': TOKEN, 'Content-Type': 'application/json' },
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(HUB_URL + path, opts);
  return res.json();
}

// ── WebSocket ──
function connectWS() {
  setStatus('connecting');
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'auth', payload: { token: TOKEN } }));
  };

  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);

      if (msg.type === 'auth' && msg.success) {
        setStatus('connected');
        addMessage('system', 'PIA Visor', 'Connected to PIA Hub', 'system');
        return;
      }

      if (msg.type === 'relay:message') {
        const relay = msg.payload;
        const from = relay?.from?.machineName || 'unknown';
        const content = relay?.content || '';
        const type = relay?.type || 'chat';
        addMessage('incoming', from, content, type);
        showToast(`${from}: ${content.substring(0, 80)}`);
        return;
      }

      if (msg.type === 'agent:update') {
        addMessage('system', 'Agent Update', JSON.stringify(msg.payload), 'status');
        return;
      }

      if (msg.type === 'alert') {
        addMessage('error', 'Alert', JSON.stringify(msg.payload), 'alert');
        return;
      }
    } catch { /* ignore */ }
  };

  ws.onclose = () => {
    setStatus('disconnected');
    addMessage('error', 'System', 'Disconnected from hub. Reconnecting in 5s...', 'system');
    setTimeout(connectWS, 5000);
  };

  ws.onerror = () => { /* onclose will fire */ };
}

function setStatus(state) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  connected = state === 'connected';
  dot.className = 'status-dot ' + (state === 'connected' ? 'connected' : state === 'connecting' ? 'connecting' : '');
  text.textContent = state === 'connected' ? 'Connected' : state === 'connecting' ? 'Connecting...' : 'Disconnected';
}

// ── Messages ──
function addMessage(direction, from, content, type) {
  const feed = document.getElementById('messageFeed');
  if (feed.querySelector('.empty-state')) feed.innerHTML = '';

  const div = document.createElement('div');
  div.className = `message ${direction}`;
  if (type === 'task') div.className += ' task';
  if (type === 'error' || type === 'alert') div.className += ' error';

  const time = new Date().toLocaleTimeString();
  div.innerHTML = `
    <div class="message-header">
      <span class="message-from">${escHtml(from)}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-content">${escHtml(content)}</div>
    <div class="message-meta">${type}</div>
  `;

  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
  messageCount++;
  document.getElementById('statMessages').textContent = messageCount;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Send Message ──
function sendMessage() {
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  if (!content) return;

  api('POST', '/api/relay/broadcast', { content, type: 'chat' });
  addMessage('outgoing', 'You', content, 'chat');
  input.value = '';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && document.activeElement.id === 'messageInput') {
    sendMessage();
  }
});

// ── Toast Notifications ──
function showToast(text) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = text;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);

  // Browser notification
  if (Notification.permission === 'granted') {
    new Notification('PIA Visor', { body: text, icon: '/icons/icon-192.png' });
  }
}

// ── Polling for stats ──
async function refreshStats() {
  try {
    const [repoStats, relayStats, sysStats] = await Promise.all([
      api('GET', '/api/repos/stats'),
      api('GET', '/api/relay/stats'),
      api('GET', '/api/stats'),
    ]);

    document.getElementById('statRepos').textContent = repoStats.totalRepos || 0;
    document.getElementById('statJobs').textContent = repoStats.totalJobs || 0;
    document.getElementById('statQueued').textContent = repoStats.jobsByStatus?.queued || 0;
    document.getElementById('statCompleted').textContent = repoStats.jobsByStatus?.completed || 0;
    document.getElementById('statMachines').textContent = relayStats.connectedMachines || 0;
    document.getElementById('statAgents').textContent = sysStats.agents?.total || 0;
    document.getElementById('machineName').textContent = relayStats.thisMachine?.name || 'Unknown';

    // Update repos sidebar
    renderRepos(repoStats.repos || []);

    // Update machines sidebar
    renderMachines(relayStats.machines || []);

    // Update jobs sidebar
    const jobsRes = await api('GET', '/api/repos/jobs/all?limit=10');
    renderJobs(jobsRes.jobs || []);
  } catch { /* hub unreachable */ }
}

function renderRepos(repos) {
  const el = document.getElementById('repoList');
  if (repos.length === 0) { el.innerHTML = '<div class="empty-state">No repos registered</div>'; return; }

  el.innerHTML = repos.map(r => `
    <div class="repo-card" onclick="sendTaskToRepo('${r.name}')">
      <div class="repo-name">${escHtml(r.displayName)}</div>
      <div class="repo-desc">${escHtml(r.machine)}</div>
      <span class="repo-status ${r.status}">${r.status}</span>
      <div class="repo-jobs">${r.jobsCompleted} done, ${r.jobsFailed} failed</div>
      <div class="repo-caps">${(r.capabilities||[]).map(c => `<span class="cap-tag">${c}</span>`).join('')}</div>
    </div>
  `).join('');
}

function renderMachines(machines) {
  const el = document.getElementById('machineList');
  if (machines.length === 0) { el.innerHTML = '<div class="empty-state">No remote machines</div>'; return; }

  el.innerHTML = machines.map(m => {
    const ago = Math.floor((Date.now() - m.lastSeen) / 1000);
    return `
      <div class="machine-card">
        <div class="machine-name">${escHtml(m.name)}</div>
        <div class="machine-info">${m.project || 'unknown'} | ${ago}s ago</div>
      </div>
    `;
  }).join('');
}

function renderJobs(jobs) {
  const el = document.getElementById('jobList');
  if (jobs.length === 0) { el.innerHTML = '<div class="empty-state">No jobs yet</div>'; return; }

  el.innerHTML = jobs.map(j => `
    <div class="repo-card" style="padding:8px 12px;">
      <div style="display:flex;justify-content:space-between;">
        <span style="font-weight:600;font-size:12px;color:#bc8cff;">${escHtml(j.repoName)}</span>
        <span class="repo-status ${j.status}" style="font-size:10px;">${j.status}</span>
      </div>
      <div style="font-size:12px;color:#c9d1d9;margin-top:4px;">${escHtml(j.action)}: ${escHtml(j.description||'')}</div>
      <div style="font-size:10px;color:#484f58;margin-top:2px;">by ${j.requestedBy}${j.duration ? ' | '+j.duration+'ms' : ''}</div>
    </div>
  `).join('');
}

async function sendTaskToRepo(repoName) {
  const action = prompt(`Send task to ${repoName}.\nAction (e.g., build, deploy, test):`);
  if (!action) return;
  const description = prompt('Description:') || action;

  const res = await api('POST', `/api/repos/${repoName}/task`, {
    action,
    description,
    requestedBy: 'visor',
  });

  addMessage('task', 'You → ' + repoName, `Task: ${action} - ${description}`, 'task');
  showToast(`Task sent to ${repoName}: ${action}`);
  refreshStats();
}

// ── Init ──
async function init() {
  // Request notification permission
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  connectWS();
  await refreshStats();
  setInterval(refreshStats, 5000);
}

init();
</script>

</body>
</html>
