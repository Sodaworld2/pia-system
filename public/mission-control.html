<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIA Mission Control</title>
  <link rel="stylesheet" href="/css/xterm.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #050508;
      color: #e2e8f0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    .mc-header {
      background: linear-gradient(135deg, #0a0a12 0%, #12121e 100%);
      border-bottom: 1px solid #1e1e2e;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .mc-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mc-title h1 {
      font-size: 18px;
      font-weight: 800;
      background: linear-gradient(135deg, #9b4dca, #58a6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
    }

    .mc-title .subtitle {
      color: #64748b;
      font-size: 12px;
      font-weight: 400;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .global-mode-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #0f0f18;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      padding: 5px 12px;
      font-size: 12px;
    }

    .mode-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mode-btn.manual { background: #1a3a5c; color: #58a6ff; }
    .mode-btn.manual.active { background: #58a6ff; color: #000; }
    .mode-btn.auto { background: #1a2e1a; color: #3fb950; }
    .mode-btn.auto.active { background: #3fb950; color: #000; }

    .ws-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #64748b;
    }

    .ws-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #3fb950;
      animation: pulse 2s infinite;
    }

    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

    /* ── Stats Bar ── */
    .stats-bar {
      background: #0a0a12;
      border-bottom: 1px solid #1a1a2a;
      padding: 6px 20px;
      display: flex;
      gap: 24px;
      flex-shrink: 0;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 16px;
    }

    .stat-label { color: #64748b; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value.green { color: #3fb950; }
    .stat-value.orange { color: #d29922; }
    .stat-value.red { color: #f85149; }
    .stat-value.blue { color: #58a6ff; }
    .stat-value.purple { color: #bc8cff; }

    /* ── Main Layout ── */
    .mc-main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ── Left Panel: Machine Grid ── */
    .machine-panel {
      width: 320px;
      background: #0a0a10;
      border-right: 1px solid #1a1a2a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .panel-header {
      padding: 10px 16px;
      border-bottom: 1px solid #1a1a2a;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header .count {
      background: #1a1a2e;
      color: #bc8cff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
    }

    .machine-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .machine-tile {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .machine-tile:hover { border-color: #9b4dca; transform: translateY(-1px); }
    .machine-tile.selected { border-color: #9b4dca; background: #12101e; box-shadow: 0 0 20px rgba(155,77,202,0.15); }
    .machine-tile.has-prompt { border-left: 3px solid #d29922; }
    .machine-tile.has-prompt::after {
      content: '!';
      position: absolute;
      top: 8px;
      right: 10px;
      background: #d29922;
      color: #000;
      width: 18px; height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
      animation: pulse 1.5s infinite;
    }

    .machine-name {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .machine-status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }

    .machine-status-dot.online { background: #3fb950; }
    .machine-status-dot.busy { background: #d29922; }
    .machine-status-dot.offline { background: #484f58; }
    .machine-status-dot.error { background: #f85149; }

    .machine-meta {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: #64748b;
    }

    .machine-ip { font-family: 'JetBrains Mono', monospace; }

    .machine-agents {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .agent-chip {
      font-size: 9px;
      padding: 2px 7px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .agent-chip.idle { background: #0d2818; color: #3fb950; }
    .agent-chip.working { background: #2a1f0f; color: #d29922; }
    .agent-chip.waiting { background: #2a0f0f; color: #f85149; animation: pulse 1.5s infinite; }
    .agent-chip.done { background: #1a1a2e; color: #8b949e; }

    .machine-mode {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mode-indicator {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .mode-indicator.manual { background: #0d1830; color: #58a6ff; }
    .mode-indicator.auto { background: #0d2818; color: #3fb950; }

    /* ── Center: Agent Detail / Terminal ── */
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .agent-detail-header {
      background: #0d0d15;
      border-bottom: 1px solid #1a1a2a;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .agent-detail-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .agent-detail-title h2 {
      font-size: 15px;
      font-weight: 700;
    }

    .agent-detail-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn:hover { filter: brightness(1.2); }
    .btn.green { background: #238636; color: white; }
    .btn.purple { background: #8957e5; color: white; }
    .btn.blue { background: #1f6feb; color: white; }
    .btn.red { background: #da3633; color: white; }
    .btn.ghost { background: #1a1a2e; color: #c9d1d9; border: 1px solid #2a2a3e; }

    .agent-tabs {
      display: flex;
      background: #0a0a12;
      border-bottom: 1px solid #1a1a2a;
      padding: 0 16px;
      flex-shrink: 0;
    }

    .agent-tab {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .agent-tab:hover { color: #c9d1d9; }
    .agent-tab.active { color: #bc8cff; border-bottom-color: #bc8cff; }

    /* Terminal View */
    .terminal-view {
      flex: 1;
      background: #080810;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .terminal-output {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #c9d1d9;
    }

    .term-line { margin-bottom: 2px; white-space: pre-wrap; word-break: break-word; }
    .term-line.system { color: #64748b; }
    .term-line.tool { color: #bc8cff; }
    .term-line.output { color: #c9d1d9; }
    .term-line.error { color: #f85149; }
    .term-line.success { color: #3fb950; }
    .term-line.prompt { color: #d29922; font-weight: 700; }

    .tool-call {
      background: #0f0f1a;
      border: 1px solid #1e1e30;
      border-left: 3px solid #bc8cff;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 6px 0;
      font-size: 12px;
    }

    .tool-call .tool-name { color: #bc8cff; font-weight: 700; }
    .tool-call .tool-args { color: #64748b; margin-top: 2px; }
    .tool-call .tool-result { color: #3fb950; margin-top: 4px; border-top: 1px solid #1e1e30; padding-top: 4px; }

    /* Journal View */
    .journal-view {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: none;
    }

    .journal-view.active { display: block; }

    .journal-entry {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 6px;
    }

    .journal-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .journal-time { font-size: 10px; color: #484f58; }
    .journal-type {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .journal-type.tool_call { background: #1f0d2a; color: #bc8cff; }
    .journal-type.output { background: #0d1830; color: #58a6ff; }
    .journal-type.prompt { background: #2a1f0f; color: #d29922; }
    .journal-type.response { background: #0d2818; color: #3fb950; }
    .journal-type.auto_approved { background: #0d2818; color: #3fb950; border: 1px solid #1a3a2d; }
    .journal-type.error { background: #2a0f0f; color: #f85149; }
    .journal-type.cost { background: #1a1a2e; color: #8b949e; }

    .journal-content {
      font-size: 13px;
      color: #c9d1d9;
      line-height: 1.5;
    }

    /* ── Right Panel: Prompt Queue ── */
    .prompt-panel {
      width: 360px;
      background: #0a0a10;
      border-left: 1px solid #1a1a2a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .prompt-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .prompt-card {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .prompt-card.urgent { border-color: #d29922; border-left: 3px solid #d29922; }
    .prompt-card.active { border-color: #9b4dca; background: #12101e; }
    .prompt-card.resolved { opacity: 0.5; border-color: #1a3a2d; }

    .prompt-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .prompt-agent-name {
      font-weight: 700;
      font-size: 13px;
      color: #bc8cff;
    }

    .prompt-machine-tag {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #1c2333;
      color: #58a6ff;
      font-weight: 600;
    }

    .prompt-time {
      font-size: 10px;
      color: #484f58;
    }

    .prompt-question {
      font-size: 13px;
      color: #e2e8f0;
      line-height: 1.5;
      margin-bottom: 10px;
      padding: 8px 10px;
      background: #0a0a15;
      border-radius: 6px;
      border-left: 3px solid #d29922;
    }

    .prompt-options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .prompt-option-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #12121e;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .prompt-option-btn:hover { border-color: #9b4dca; background: #1a1a2e; }
    .prompt-option-btn.selected { border-color: #3fb950; background: #0d2818; color: #3fb950; }

    .prompt-option-num {
      background: #2a2a3e;
      color: #bc8cff;
      width: 22px; height: 22px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .prompt-text-input {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .prompt-text-input input {
      flex: 1;
      background: #0a0a15;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 7px 10px;
      color: #c9d1d9;
      font-size: 12px;
      outline: none;
    }

    .prompt-text-input input:focus { border-color: #9b4dca; }

    .prompt-text-input button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ── Spawn Modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.visible { display: flex; }

    .modal {
      background: #12121e;
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 24px;
      width: 460px;
      max-width: 90vw;
    }

    .modal h2 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #e6edf3;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal input, .modal select, .modal textarea {
      width: 100%;
      background: #0a0a15;
      border: 1px solid #2a2a3e;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    .modal textarea { min-height: 80px; resize: vertical; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .modal input:focus, .modal textarea:focus, .modal select:focus { border-color: #9b4dca; }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-cancel {
      background: #1a1a2e;
      color: #c9d1d9;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
    }

    /* ── Toast ── */
    .toast-container {
      position: fixed;
      top: 60px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: #1f2937;
      border: 1px solid #9b4dca;
      border-radius: 8px;
      padding: 10px 16px;
      color: #e6edf3;
      font-size: 13px;
      animation: toastIn 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 350px;
    }

    @keyframes toastIn { from { opacity:0; transform:translateX(100px); } to { opacity:1; transform:translateX(0); } }

    /* ── Grid View (multi-terminal) ── */
    .grid-view {
      flex: 1;
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      grid-template-rows: repeat(auto-fit, minmax(250px, 1fr));
      gap: 6px;
      padding: 6px;
      overflow-y: auto;
      background: #050508;
    }

    .grid-view.active { display: grid; }

    .grid-tile {
      background: #0a0a12;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 0;
    }

    .grid-tile:hover { border-color: #9b4dca; box-shadow: 0 0 15px rgba(155,77,202,0.15); }
    .grid-tile.waiting { border-color: #d29922; border-left: 3px solid #d29922; }
    .grid-tile.selected { border-color: #9b4dca; border-width: 2px; }

    .grid-tile-header {
      padding: 6px 10px;
      background: #0d0d18;
      border-bottom: 1px solid #1a1a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .grid-tile-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .grid-tile-title .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .grid-tile-title .dot.working { background: #3fb950; }
    .grid-tile-title .dot.waiting { background: #d29922; animation: pulse 1.5s infinite; }
    .grid-tile-title .dot.idle { background: #484f58; }

    .grid-tile-badges {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .grid-tile-badges .badge {
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 8px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .grid-tile-badges .badge.machine { background: #1c2333; color: #58a6ff; }
    .grid-tile-badges .badge.mode-m { background: #0d1830; color: #58a6ff; }
    .grid-tile-badges .badge.mode-a { background: #0d2818; color: #3fb950; }
    .grid-tile-badges .badge.cost { background: #1a1a2e; color: #8b949e; }

    .grid-tile-body {
      flex: 1;
      overflow-y: auto;
      padding: 6px 10px;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #8b949e;
      min-height: 0;
    }

    .grid-tile-body .gl { white-space: pre-wrap; word-break: break-word; margin-bottom: 1px; }
    .grid-tile-body .gl.system { color: #484f58; }
    .grid-tile-body .gl.tool { color: #bc8cff; }
    .grid-tile-body .gl.output { color: #c9d1d9; }
    .grid-tile-body .gl.error { color: #f85149; }
    .grid-tile-body .gl.success { color: #3fb950; }
    .grid-tile-body .gl.prompt { color: #d29922; font-weight: 700; }

    .grid-tile-footer {
      padding: 4px 10px;
      border-top: 1px solid #1a1a2a;
      font-size: 10px;
      color: #484f58;
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* View Toggle Button */
    .view-toggle {
      display: flex;
      align-items: center;
      background: #0f0f18;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      overflow: hidden;
    }

    .view-toggle-btn {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: #64748b;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .view-toggle-btn:hover { color: #c9d1d9; }
    .view-toggle-btn.active { background: #9b4dca; color: white; }

    /* ── Cost Tracker ── */
    .cost-tracker {
      padding: 8px 16px;
      border-top: 1px solid #1a1a2a;
      background: #0a0a10;
      font-size: 11px;
      color: #64748b;
      display: flex;
      gap: 16px;
      flex-shrink: 0;
    }

    .cost-item { display: flex; gap: 4px; align-items: center; }
    .cost-value { color: #3fb950; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

    /* ── Terminal Input Bar ── */
    .terminal-input-bar {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: #0d0d18;
      border-top: 1px solid #1e1e30;
      flex-shrink: 0;
    }

    .terminal-input-bar input {
      flex: 1;
      background: #080810;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 8px 12px;
      color: #c9d1d9;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 13px;
      outline: none;
    }

    .terminal-input-bar input:focus { border-color: #9b4dca; }

    .terminal-input-bar input::placeholder { color: #484f58; }

    .terminal-input-bar button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .terminal-input-bar button:hover { background: #2ea043; }
    .terminal-input-bar button:disabled { background: #333; color: #666; cursor: not-allowed; }

    /* ── Agent Status Banner ── */
    .agent-status-banner {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.5px;
      flex-shrink: 0;
      border-bottom: 1px solid #1a1a2a;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
    }

    .agent-status-banner .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-status-banner.working {
      background: linear-gradient(90deg, #0a1a0a, #0d0d18);
      color: #3fb950;
      border-bottom-color: #1a3a1a;
    }
    .agent-status-banner.working .status-dot {
      background: #3fb950;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px #3fb95066;
    }

    .agent-status-banner.waiting {
      background: linear-gradient(90deg, #1a1500, #0d0d18);
      color: #d29922;
      border-bottom-color: #3a2a0a;
    }
    .agent-status-banner.waiting .status-dot {
      background: #d29922;
      animation: pulse 0.8s infinite;
      box-shadow: 0 0 8px #d2992266;
    }

    .agent-status-banner.done {
      background: linear-gradient(90deg, #0a0a1a, #0d0d18);
      color: #58a6ff;
      border-bottom-color: #1a1a3a;
    }
    .agent-status-banner.done .status-dot {
      background: #58a6ff;
      box-shadow: 0 0 8px #58a6ff66;
    }

    .agent-status-banner.error {
      background: linear-gradient(90deg, #1a0a0a, #0d0d18);
      color: #f85149;
      border-bottom-color: #3a1a1a;
    }
    .agent-status-banner.error .status-dot {
      background: #f85149;
      box-shadow: 0 0 8px #f8514966;
    }

    .agent-status-banner.idle {
      background: linear-gradient(90deg, #0a1a0a, #0d0d18);
      color: #3fb950;
      border-bottom-color: #1a3a1a;
    }
    .agent-status-banner.idle .status-dot {
      background: #3fb950;
      box-shadow: 0 0 8px #3fb95066;
    }

    .agent-status-banner .status-text { flex: 1; }
    .agent-status-banner .status-detail {
      font-size: 11px;
      font-weight: 400;
      color: #64748b;
    }

    /* ── Responsive ── */
    @media (max-width: 1200px) {
      .machine-panel { width: 260px; }
      .prompt-panel { width: 300px; }
    }
    @media (max-width: 900px) {
      .prompt-panel { display: none; }
    }
    @media (max-width: 700px) {
      .machine-panel { display: none; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="mc-header">
    <div class="mc-title">
      <h1>PIA MISSION CONTROL</h1>
      <span class="subtitle">Claude Code Fleet Manager</span>
    </div>
    <div class="header-controls">
      <div class="global-mode-toggle">
        <span style="color:#64748b;font-size:11px;">Global:</span>
        <button class="mode-btn manual active" onclick="setGlobalMode('manual')">Manual</button>
        <button class="mode-btn auto" onclick="setGlobalMode('auto')">Auto</button>
      </div>
      <div class="view-toggle">
        <button class="view-toggle-btn active" onclick="setView('single')" id="viewSingle">Single</button>
        <button class="view-toggle-btn" onclick="setView('grid')" id="viewGrid">Grid</button>
      </div>
      <button class="btn purple" onclick="openSpawnModal()">+ Spawn Agent</button>
      <div class="ws-status">
        <div class="ws-dot"></div>
        <span>Connected</span>
      </div>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat"><span class="stat-value blue">6</span><span class="stat-label">Machines</span></div>
    <div class="stat"><span class="stat-value purple">4</span><span class="stat-label">Agents</span></div>
    <div class="stat"><span class="stat-value green">2</span><span class="stat-label">Working</span></div>
    <div class="stat"><span class="stat-value orange" id="statWaiting">2</span><span class="stat-label">Waiting</span></div>
    <div class="stat"><span class="stat-value" style="color:#c9d1d9;">1</span><span class="stat-label">Idle</span></div>
    <div class="stat"><span class="stat-value green">12</span><span class="stat-label">Done Today</span></div>
    <div class="stat"><span class="stat-value red">1</span><span class="stat-label">Errors</span></div>
    <div class="stat" style="margin-left:auto;"><span class="stat-label">Cost Today</span><span class="stat-value green" style="font-size:14px;">$2.47</span></div>
    <div class="stat"><span class="stat-label">Tokens</span><span class="stat-value" style="font-size:14px;color:#bc8cff;">184K</span></div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="mc-main">

    <!-- LEFT: Machine Grid -->
    <div class="machine-panel">
      <div class="panel-header">
        Machines <span class="count">6 online</span>
      </div>
      <div class="machine-list" id="machineList"></div>
    </div>

    <!-- CENTER: Agent Detail -->
    <div class="center-panel">
      <div class="agent-detail-header">
        <div class="agent-detail-title">
          <h2 id="centerTitle">Select a machine to view agents</h2>
          <span class="mode-indicator manual" id="centerMode" style="display:none;">Manual</span>
        </div>
        <div class="agent-detail-actions" id="centerActions" style="display:none;">
          <button class="btn ghost" onclick="toggleMode()">Toggle Mode</button>
          <button class="btn blue" onclick="openSpawnModal()">+ Spawn</button>
          <button class="btn red" onclick="killAgent()">Kill</button>
        </div>
      </div>

      <div class="agent-tabs" id="agentTabs" style="display:none;">
        <div class="agent-tab active" data-tab="terminal" onclick="switchAgentTab('terminal')">Terminal</div>
        <div class="agent-tab" data-tab="journal" onclick="switchAgentTab('journal')">Journal</div>
        <div class="agent-tab" data-tab="cost" onclick="switchAgentTab('cost')">Cost</div>
      </div>

      <!-- Agent Status Banner -->
      <div class="agent-status-banner" id="agentStatusBanner">
        <div class="status-dot"></div>
        <span class="status-text" id="statusText">CLAUDE RUNNING</span>
        <span class="status-detail" id="statusDetail"></span>
      </div>

      <!-- Terminal Output -->
      <div class="terminal-view" id="terminalView">
        <div class="terminal-output" id="terminalOutput">
          <div class="term-line system">Welcome to PIA Mission Control.</div>
          <div class="term-line system">Click a machine tile on the left to view its agent sessions.</div>
          <div class="term-line system">Use "+ Spawn Agent" to start a new Claude Code agent on any machine.</div>
          <div class="term-line system">Prompts requiring your input appear in the right panel.</div>
        </div>
      </div>

      <!-- Terminal Input Bar -->
      <div class="terminal-input-bar" id="terminalInputBar" style="display:none;">
        <input type="text" id="terminalInput" placeholder="Type a message to the agent..."
               onkeydown="if(event.key==='Enter')sendTerminalInput()">
        <button onclick="sendTerminalInput()" id="terminalSendBtn">Send</button>
      </div>

      <!-- Grid View (all agents tiled) -->
      <div class="grid-view" id="gridView"></div>

      <!-- Journal View (hidden by default) -->
      <div class="journal-view" id="journalView"></div>

      <!-- Cost footer -->
      <div class="cost-tracker" id="costTracker" style="display:none;">
        <div class="cost-item">Session: <span class="cost-value" id="costSession">$0.00</span></div>
        <div class="cost-item">Tokens in: <span class="cost-value" id="costIn">0</span></div>
        <div class="cost-item">Tokens out: <span class="cost-value" id="costOut">0</span></div>
        <div class="cost-item">Tool calls: <span class="cost-value" id="costTools">0</span></div>
        <div class="cost-item">Duration: <span class="cost-value" id="costDuration">0m</span></div>
      </div>
    </div>

    <!-- RIGHT: Prompt Queue -->
    <div class="prompt-panel">
      <div class="panel-header">
        Prompt Queue <span class="count" id="promptCount">2 pending</span>
      </div>
      <div class="prompt-list" id="promptList"></div>
    </div>

  </div>

  <!-- SPAWN MODAL -->
  <div class="modal-overlay" id="spawnModal">
    <div class="modal">
      <h2>Spawn New Agent</h2>
      <label>Target Machine</label>
      <select id="spawnMachine">
        <option value="machine-1">DESKTOP-PIA (local)</option>
        <option value="machine-2">TOWER-DEV (100.64.1.2)</option>
        <option value="machine-3">MACBOOK-PRO (100.64.1.3)</option>
        <option value="machine-4">CLOUD-GPU (100.64.1.4)</option>
        <option value="machine-5">MINI-BUILD (100.64.1.5)</option>
        <option value="machine-6">NUC-TEST (100.64.1.6)</option>
      </select>
      <label>Mode</label>
      <select id="spawnMode">
        <option value="api">API Mode (PIA drives Claude API)</option>
        <option value="pty">PTY Mode (spawn real Claude CLI)</option>
      </select>
      <label>Working Directory</label>
      <input type="text" id="spawnCwd" placeholder="C:\Users\mic\Projects\my-app" value="C:\Users\mic\Downloads\pia-system">
      <label>Initial Task</label>
      <textarea id="spawnTask" placeholder="Describe what this agent should work on...">Fix the failing unit tests in src/api/routes/</textarea>
      <label>Initial Mode</label>
      <select id="spawnInitMode">
        <option value="manual">Manual (approve every action)</option>
        <option value="auto">Auto (safety policy decides)</option>
      </select>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSpawnModal()">Cancel</button>
        <button class="btn purple" onclick="spawnAgent()">Spawn Agent</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

<script>
// ═══════════════════════════════════════════════════════════════════
// PIA Mission Control — LIVE (wired to real API + WebSocket)
// ═══════════════════════════════════════════════════════════════════

const API_BASE = '';  // same origin
const API_TOKEN = 'pia-local-dev-token-2024';
const WS_URL = `ws://${location.hostname}:3001`;

// ── STATE ──
let machines = [];        // from /api/machines
let agents = [];          // from /api/mc/agents
let prompts = [];         // from /api/mc/prompts + WebSocket
let outputBuffers = {};   // agentId -> [{type, text}]
let selectedMachine = null;
let selectedAgent = null;
let activeAgentTab = 'terminal';
let currentView = 'single';
let ws = null;
let wsConnected = false;

// ── API HELPERS ──
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    ...opts,
    headers: {
      'x-api-token': API_TOKEN,
      'Content-Type': 'application/json',
      ...(opts.headers || {}),
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`API ${res.status}: ${err}`);
  }
  return res.json();
}

// ── FETCH DATA ──
async function fetchMachines() {
  try {
    const data = await api('/api/machines');
    machines = (data.machines || data || []).map(m => ({
      id: m.id || m.name,
      name: (m.name || m.hostname || 'Unknown').toUpperCase(),
      ip: m.ip_address || m.ipAddress || 'local',
      status: m.status || 'online',
      mode: 'manual',
    }));
  } catch (e) {
    // If no machines registered, show local machine
    machines = [];
  }
  // Always include local machine
  if (!machines.find(m => m.ip === 'local' || m.name === location.hostname.toUpperCase())) {
    machines.unshift({ id: 'local', name: 'LOCAL', ip: location.hostname, status: 'online', mode: 'manual' });
  }
}

async function fetchAgents() {
  try {
    const data = await api('/api/mc/agents');
    agents = (data.agents || []).map(a => ({
      id: a.id,
      name: a.id.substring(0, 8),
      status: mapStatus(a.status),
      task: a.task || '',
      mode: a.approvalMode || 'manual',
      machineId: a.machineId || 'local',
      cost: a.cost || 0,
      tokensIn: a.tokensIn || 0,
      tokensOut: a.tokensOut || 0,
      toolCalls: a.toolCalls || 0,
      createdAt: a.createdAt || Date.now(),
      errorMessage: a.errorMessage,
    }));
  } catch (e) {
    console.error('Failed to fetch agents:', e);
  }
}

async function fetchPrompts() {
  try {
    const data = await api('/api/mc/prompts');
    prompts = (data.prompts || []).map(p => ({
      id: p.id,
      agentId: p.agentId,
      agentName: p.agentId?.substring(0, 8) || 'Agent',
      machine: 'LOCAL',
      timestamp: (p.timestamp || 0) * 1000 || Date.now(),
      question: p.question || '',
      options: p.options || ['Allow', 'Deny', 'Skip'],
      type: p.type || 'tool_approval',
      status: p.status || 'pending',
      resolved: p.status !== 'pending',
      resolvedWith: p.response,
    }));
  } catch (e) {
    console.error('Failed to fetch prompts:', e);
  }
}

async function fetchAgentDetail(agentId) {
  try {
    const data = await api(`/api/mc/agents/${agentId}`);
    if (data.buffer) {
      // Parse output buffer into lines
      const lines = data.buffer.split('\n').filter(l => l.trim());
      outputBuffers[agentId] = lines.map(l => classifyLine(l));
    }
    // Update agent in list
    if (data.agent) {
      const idx = agents.findIndex(a => a.id === agentId);
      if (idx >= 0) {
        agents[idx].cost = data.agent.cost || 0;
        agents[idx].tokensIn = data.agent.tokensIn || 0;
        agents[idx].tokensOut = data.agent.tokensOut || 0;
        agents[idx].toolCalls = data.agent.toolCalls || 0;
        agents[idx].status = mapStatus(data.agent.status);
      }
    }
  } catch (e) {
    console.error('Failed to fetch agent detail:', e);
  }
}

async function fetchJournal(agentId) {
  try {
    const data = await api(`/api/mc/agents/${agentId}/journal`);
    return data.journal || [];
  } catch (e) {
    console.error('Failed to fetch journal:', e);
    return [];
  }
}

function mapStatus(s) {
  if (s === 'working' || s === 'starting') return 'working';
  if (s === 'waiting_for_input') return 'waiting';
  if (s === 'done') return 'done';
  if (s === 'error') return 'error';
  if (s === 'idle') return 'idle';
  return s || 'idle';
}

function stripAnsi(str) {
  // Strip ANSI escape codes (colors, cursor movement, terminal control sequences)
  return str.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')
            .replace(/\x1b\][^\x07]*\x07/g, '')     // OSC sequences
            .replace(/\x1b\[\?[0-9;]*[a-zA-Z]/g, '') // Private sequences like ?25l
            .replace(/\x1b[()][A-Z0-9]/g, '')        // Character set selection
            .replace(/[\x00-\x08\x0e-\x1f]/g, '');   // Other control chars (keep \t \n \r)
}

function classifyLine(text) {
  const t = stripAnsi(text).trim();
  if (t.startsWith('Read ') || t.startsWith('Glob ') || t.startsWith('Grep ') ||
      t.startsWith('Edit ') || t.startsWith('Write ') || t.startsWith('Bash ')) {
    return { type: 'tool', text: t };
  }
  if (t.startsWith('FAIL') || t.startsWith('Error') || t.startsWith('error')) return { type: 'error', text: t };
  if (t.startsWith('PASS') || t.startsWith('Success') || t.startsWith('Applied') || t.startsWith('Created')) return { type: 'success', text: t };
  if (t.startsWith('WAITING') || t.startsWith('Agent needs')) return { type: 'prompt', text: t };
  if (t.startsWith('Agent ') || t.startsWith('Task:') || t === '────────────────────────────────────────') return { type: 'system', text: t };
  return { type: 'output', text: t };
}

// ── WEBSOCKET ──
function connectWebSocket() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    // Authenticate
    ws.send(JSON.stringify({ type: 'auth', payload: { token: API_TOKEN } }));
    // Subscribe to mission control events
    setTimeout(() => {
      ws.send(JSON.stringify({ type: 'mc:subscribe' }));
    }, 500);
    wsConnected = true;
    updateWsStatus(true);
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleWsMessage(msg);
    } catch (e) { /* ignore non-JSON */ }
  };

  ws.onclose = () => {
    wsConnected = false;
    updateWsStatus(false);
    // Reconnect after 3s
    setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {
    wsConnected = false;
    updateWsStatus(false);
  };
}

function handleWsMessage(msg) {
  switch (msg.type) {
    case 'mc:output': {
      const { sessionId, data } = msg.payload || {};
      if (!sessionId || !data) return;
      if (!outputBuffers[sessionId]) outputBuffers[sessionId] = [];
      // Split into lines, classify each
      data.split('\n').filter(l => l.trim()).forEach(line => {
        outputBuffers[sessionId].push(classifyLine(line));
      });
      // If this agent is selected, update the terminal live
      if (selectedAgent === sessionId && activeAgentTab === 'terminal') {
        renderTerminal(sessionId);
      }
      // Update grid view if active
      if (currentView === 'grid') renderGridView();
      break;
    }
    case 'mc:prompt': {
      const p = msg.payload;
      if (!p) return;
      // Add to prompt list if not already there
      if (!prompts.find(pp => pp.id === p.id)) {
        prompts.push({
          id: p.id,
          agentId: p.agentId,
          agentName: (p.agentId || '').substring(0, 8),
          machine: 'LOCAL',
          timestamp: Date.now(),
          question: p.question || '',
          options: p.options || ['Allow', 'Deny', 'Skip'],
          type: p.type || 'tool_approval',
          resolved: false,
        });
        renderPrompts();
        // Update agent status to waiting
        const agent = agents.find(a => a.id === p.agentId);
        if (agent) {
          agent.status = 'waiting';
          renderAll();
          if (selectedAgent === p.agentId) {
            updateAgentStatusUI(agent);
          }
        }
        showToast(`New prompt from ${(p.agentId || '').substring(0, 8)}`);
      }
      break;
    }
    case 'mc:status': {
      const { sessionId, status, error } = msg.payload || {};
      if (!sessionId) return;
      const agent = agents.find(a => a.id === sessionId);
      if (agent) {
        agent.status = mapStatus(status);
        if (error) agent.errorMessage = error;
        renderAll();
        // Update status banner + input bar for the selected agent
        if (selectedAgent === sessionId) {
          updateAgentStatusUI(agent);
        }
        if (status === 'done') {
          showToast(`Agent ${sessionId.substring(0, 8)} completed`);
          // Fetch full output buffer from API now that agent is done
          fetchAgentDetail(sessionId).then(() => {
            if (selectedAgent === sessionId && activeAgentTab === 'terminal') {
              renderTerminal(sessionId);
            }
          });
        }
        if (status === 'error') showToast(`Agent ${sessionId.substring(0, 8)} error: ${error || 'unknown'}`);
      } else {
        // New agent we haven't seen yet — refresh
        fetchAgents().then(renderAll);
      }
      break;
    }
    case 'authenticated':
      // Good, now subscribe
      break;
  }
}

function updateWsStatus(connected) {
  const dot = document.querySelector('.ws-dot');
  const text = document.querySelector('.ws-status span');
  if (dot) dot.style.background = connected ? '#3fb950' : '#f85149';
  if (text) text.textContent = connected ? 'Connected' : 'Disconnected';
}

// ── RENDER FUNCTIONS ──

function getAgentsForMachine(machineId) {
  return agents.filter(a => a.machineId === machineId || (machineId === 'local' && (!a.machineId || a.machineId === 'local')));
}

function renderAll() {
  renderMachines();
  renderPrompts();
  renderStats();
  if (currentView === 'grid') renderGridView();
}

function renderStats() {
  const working = agents.filter(a => a.status === 'working').length;
  const waiting = agents.filter(a => a.status === 'waiting').length;
  const done = agents.filter(a => a.status === 'done').length;
  const errors = agents.filter(a => a.status === 'error').length;
  const idle = agents.filter(a => a.status === 'idle').length;
  const totalCost = agents.reduce((s, a) => s + (a.cost || 0), 0);
  const totalTokens = agents.reduce((s, a) => s + (a.tokensIn || 0) + (a.tokensOut || 0), 0);

  const statsBar = document.querySelector('.stats-bar');
  statsBar.innerHTML = `
    <div class="stat"><span class="stat-value blue">${machines.length}</span><span class="stat-label">Machines</span></div>
    <div class="stat"><span class="stat-value purple">${agents.length}</span><span class="stat-label">Agents</span></div>
    <div class="stat"><span class="stat-value green">${working}</span><span class="stat-label">Working</span></div>
    <div class="stat"><span class="stat-value orange" id="statWaiting">${waiting}</span><span class="stat-label">Waiting</span></div>
    <div class="stat"><span class="stat-value" style="color:#c9d1d9;">${idle}</span><span class="stat-label">Idle</span></div>
    <div class="stat"><span class="stat-value green">${done}</span><span class="stat-label">Done</span></div>
    <div class="stat"><span class="stat-value red">${errors}</span><span class="stat-label">Errors</span></div>
    <div class="stat" style="margin-left:auto;"><span class="stat-label">Cost</span><span class="stat-value green" style="font-size:14px;">$${totalCost.toFixed(2)}</span></div>
    <div class="stat"><span class="stat-label">Tokens</span><span class="stat-value" style="font-size:14px;color:#bc8cff;">${totalTokens > 1000 ? (totalTokens/1000).toFixed(0) + 'K' : totalTokens}</span></div>
  `;
}

function renderMachines() {
  const list = document.getElementById('machineList');
  list.innerHTML = machines.map(m => {
    const mAgents = getAgentsForMachine(m.id);
    const hasPrompt = mAgents.some(a => a.status === 'waiting');
    const isSelected = selectedMachine === m.id;
    return `
      <div class="machine-tile ${isSelected ? 'selected' : ''} ${hasPrompt ? 'has-prompt' : ''}"
           onclick="selectMachine('${esc(m.id)}')">
        <div class="machine-name">
          <div class="machine-status-dot ${m.status === 'online' ? (mAgents.some(a => a.status === 'working') ? 'busy' : 'online') : m.status}"></div>
          ${esc(m.name)}
        </div>
        <div class="machine-meta">
          <span class="machine-ip">${esc(m.ip)}</span>
          <span>${mAgents.length} agent${mAgents.length !== 1 ? 's' : ''}</span>
        </div>
        ${mAgents.length > 0 ? `
          <div class="machine-agents">
            ${mAgents.map(a => `<span class="agent-chip ${a.status}">${esc(a.name)}: ${a.status}</span>`).join('')}
          </div>
        ` : ''}
        <div class="machine-mode">
          <span class="mode-indicator ${m.mode}">${m.mode}</span>
        </div>
      </div>
    `;
  }).join('');

  // Update machine dropdown in spawn modal
  const sel = document.getElementById('spawnMachine');
  sel.innerHTML = machines.map(m =>
    `<option value="${esc(m.id)}">${esc(m.name)} (${esc(m.ip)})</option>`
  ).join('');
}

function selectMachine(machineId) {
  selectedMachine = machineId;
  const machine = machines.find(m => m.id === machineId);
  if (!machine) return;

  const mAgents = getAgentsForMachine(machineId);
  if (mAgents.length > 0) {
    selectAgent(mAgents[0].id);
  } else {
    selectedAgent = null;
    document.getElementById('centerTitle').textContent = machine.name + ' — No agents running';
    document.getElementById('centerMode').style.display = 'none';
    document.getElementById('centerActions').style.display = 'flex';
    document.getElementById('agentTabs').style.display = 'none';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('terminalOutput').innerHTML = `
      <div class="term-line system">Machine: ${esc(machine.name)} (${esc(machine.ip)})</div>
      <div class="term-line system">Status: ${machine.status}</div>
      <div class="term-line system">No agents running. Click "+ Spawn Agent" to start one.</div>
    `;
  }
  renderMachines();
}

// ── UPDATE AGENT STATUS BANNER + INPUT BAR ──
function updateAgentStatusUI(agent) {
  if (!agent) {
    document.getElementById('agentStatusBanner').style.display = 'none';
    document.getElementById('terminalInputBar').style.display = 'none';
    return;
  }

  const banner = document.getElementById('agentStatusBanner');
  const inputBar = document.getElementById('terminalInputBar');
  const statusText = document.getElementById('statusText');
  const statusDetail = document.getElementById('statusDetail');
  const isAlive = (agent.status === 'working' || agent.status === 'waiting' || agent.status === 'idle' || agent.status === 'starting');

  // Status banner — always visible when agent selected
  banner.style.display = 'flex';
  banner.className = 'agent-status-banner ' + (agent.status || 'working');

  if (agent.status === 'working' || agent.status === 'starting') {
    statusText.textContent = 'CLAUDE IS RUNNING';
    statusDetail.textContent = agent.mode === 'auto' ? 'Auto-approve mode — agent runs autonomously' : 'Manual mode — approve each tool call';
  } else if (agent.status === 'waiting') {
    statusText.textContent = 'WAITING FOR YOUR INPUT';
    statusDetail.textContent = 'Type your response below and press Enter or click Send';
  } else if (agent.status === 'done') {
    statusText.textContent = 'COMPLETED — Session finished';
    statusDetail.textContent = `Cost: $${(agent.cost || 0).toFixed(2)} | Tools: ${agent.toolCalls || 0} — Click "+ Spawn" for a new task`;
  } else if (agent.status === 'error') {
    statusText.textContent = 'ERROR';
    statusDetail.textContent = agent.errorMessage || 'Agent encountered an error';
  } else if (agent.status === 'idle') {
    statusText.textContent = 'READY — Type a follow-up message';
    statusDetail.textContent = 'Claude finished the task. Send a message to continue the conversation.';
  }

  // Input bar — show when agent is alive
  if (isAlive) {
    inputBar.style.display = 'flex';
    document.getElementById('terminalInput').placeholder = `Type a message to agent ${agent.name || 'unknown'}...`;
  } else {
    inputBar.style.display = 'none';
  }
}

async function selectAgent(agentId) {
  const agent = agents.find(a => a.id === agentId);
  if (!agent) return;

  selectedAgent = agentId;
  selectedMachine = agent.machineId || 'local';
  const machine = machines.find(m => m.id === selectedMachine) || { name: 'LOCAL' };

  document.getElementById('centerTitle').textContent = `${machine.name} / ${agent.name} — ${agent.task.substring(0, 80)}`;
  document.getElementById('centerMode').style.display = '';
  document.getElementById('centerMode').textContent = agent.mode;
  document.getElementById('centerMode').className = 'mode-indicator ' + agent.mode;
  document.getElementById('centerActions').style.display = 'flex';
  document.getElementById('agentTabs').style.display = 'flex';
  document.getElementById('costTracker').style.display = 'flex';

  // Update status banner + input bar
  updateAgentStatusUI(agent);

  // Fetch agent detail if we don't have real output yet (startup lines don't count)
  const buf = outputBuffers[agentId] || [];
  const hasRealOutput = buf.some(l => l.type !== 'system');
  if (buf.length === 0 || (!hasRealOutput && agent.status === 'done')) {
    await fetchAgentDetail(agentId);
  }

  updateCostFooter(agent);
  switchAgentTab('terminal');
  renderTerminal(agentId);
  renderMachines();
}

function updateCostFooter(agent) {
  document.getElementById('costSession').textContent = '$' + (agent.cost || 0).toFixed(2);
  document.getElementById('costIn').textContent = (agent.tokensIn || 0) > 1000 ? ((agent.tokensIn/1000).toFixed(1) + 'K') : (agent.tokensIn || 0);
  document.getElementById('costOut').textContent = (agent.tokensOut || 0) > 1000 ? ((agent.tokensOut/1000).toFixed(1) + 'K') : (agent.tokensOut || 0);
  document.getElementById('costTools').textContent = agent.toolCalls || 0;
  const elapsed = agent.createdAt ? Math.floor((Date.now() - agent.createdAt) / 60000) : 0;
  document.getElementById('costDuration').textContent = elapsed + 'm';
}

function renderTerminal(agentId) {
  const output = document.getElementById('terminalOutput');
  const lines = outputBuffers[agentId] || [];

  if (lines.length === 0) {
    output.innerHTML = '<div class="term-line system">Waiting for agent output...</div>';
    return;
  }

  output.innerHTML = lines.map(l => {
    if (l.type === 'tool') {
      return `<div class="tool-call"><span class="tool-name">${esc(l.text)}</span></div>`;
    }
    return `<div class="term-line ${l.type}">${esc(l.text)}</div>`;
  }).join('');

  output.scrollTop = output.scrollHeight;
}

async function renderJournal(agentId) {
  const view = document.getElementById('journalView');
  const entries = await fetchJournal(agentId);

  if (entries.length === 0) {
    view.innerHTML = '<div style="color:#64748b;text-align:center;padding:40px;">No journal entries yet.</div>';
    return;
  }

  view.innerHTML = entries.map(e => {
    const time = e.createdAt ? new Date(e.createdAt * 1000).toLocaleTimeString() : '';
    return `
      <div class="journal-entry">
        <div class="journal-entry-header">
          <span class="journal-type ${esc(e.type)}">${esc((e.type || '').replace('_', ' '))}</span>
          <span class="journal-time">${esc(time)}</span>
        </div>
        <div class="journal-content">${esc(e.content || '')}</div>
      </div>
    `;
  }).join('');
}

function renderPrompts() {
  const list = document.getElementById('promptList');
  const count = document.getElementById('promptCount');
  const pending = prompts.filter(p => !p.resolved);
  count.textContent = pending.length + ' pending';

  if (prompts.length === 0) {
    list.innerHTML = '<div style="color:#64748b;text-align:center;padding:40px;font-size:13px;">No prompts. Agents running in auto mode or idle.</div>';
    return;
  }

  list.innerHTML = prompts.map(p => `
    <div class="prompt-card ${!p.resolved ? 'urgent' : 'resolved'}" id="prompt-${esc(p.id)}">
      <div class="prompt-card-header">
        <div>
          <div class="prompt-agent-name">${esc(p.agentName)}</div>
          <span class="prompt-machine-tag">${esc(p.machine)}</span>
        </div>
        <div class="prompt-time">${formatAgo(p.timestamp)}</div>
      </div>
      <div class="prompt-question">${esc(p.question)}</div>
      ${p.resolved ? '<div style="color:#3fb950;font-size:12px;font-weight:600;">Responded: ' + esc(p.resolvedWith || p.status) + '</div>' : `
        <div class="prompt-options">
          ${p.options.map((opt, i) => `
            <div class="prompt-option-btn" onclick="respondToPrompt('${esc(p.id)}', ${i + 1}, '${esc(p.agentId)}', this)">
              <span class="prompt-option-num">${i + 1}</span>
              <span>${esc(opt)}</span>
            </div>
          `).join('')}
        </div>
        <div class="prompt-text-input">
          <input type="text" placeholder="Or type a custom response..." id="promptInput-${esc(p.id)}"
                 onkeydown="if(event.key==='Enter')respondCustom('${esc(p.id)}','${esc(p.agentId)}')">
          <button onclick="respondCustom('${esc(p.id)}','${esc(p.agentId)}')">Send</button>
        </div>
      `}
    </div>
  `).join('');
}

// ── RESPOND TO PROMPT (REAL API) ──
async function respondToPrompt(promptId, choice, agentId, el) {
  if (el) el.classList.add('selected');

  try {
    // Send via REST API
    await api(`/api/mc/agents/${agentId}/respond`, {
      method: 'POST',
      body: { promptId, choice },
    });

    // Also send via WebSocket for faster delivery
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'mc:respond', payload: { promptId, choice } }));
    }

    // Update local state
    const prompt = prompts.find(p => p.id === promptId);
    if (prompt) {
      prompt.resolved = true;
      prompt.resolvedWith = prompt.options[choice - 1] || `Option ${choice}`;
    }

    showToast(`Responded: Option ${choice}`);
    renderPrompts();

    // Refresh agent status
    await fetchAgents();
    renderAll();
  } catch (e) {
    showToast(`Failed to respond: ${e.message}`);
  }
}

async function respondCustom(promptId, agentId) {
  const input = document.getElementById('promptInput-' + promptId);
  const text = input?.value?.trim();
  if (!text) return;

  try {
    await api(`/api/mc/agents/${agentId}/respond`, {
      method: 'POST',
      body: { promptId, choice: text },
    });

    const prompt = prompts.find(p => p.id === promptId);
    if (prompt) {
      prompt.resolved = true;
      prompt.resolvedWith = text;
    }

    showToast(`Responded: "${text}"`);
    renderPrompts();
    await fetchAgents();
    renderAll();
  } catch (e) {
    showToast(`Failed to respond: ${e.message}`);
  }
}

// ── SPAWN AGENT (REAL API) ──
async function spawnAgent() {
  const machineId = document.getElementById('spawnMachine').value;
  const mode = document.getElementById('spawnMode').value;
  const task = document.getElementById('spawnTask').value.trim();
  const approvalMode = document.getElementById('spawnInitMode').value;
  const cwd = document.getElementById('spawnCwd').value.trim();

  if (!task) { showToast('Please enter a task'); return; }
  if (!cwd) { showToast('Please enter a working directory'); return; }

  closeSpawnModal();
  showToast('Spawning agent...');

  try {
    const data = await api('/api/mc/agents', {
      method: 'POST',
      body: { machineId, mode, task, cwd, approvalMode },
    });

    showToast(`Agent spawned: ${data.id?.substring(0, 8)}`);

    // Refresh agents and select the new one
    await fetchAgents();
    renderAll();
    if (data.id) {
      outputBuffers[data.id] = [
        { type: 'system', text: `Agent ${data.id.substring(0, 8)} started (${mode} mode, ${approvalMode})` },
        { type: 'system', text: `Task: ${task}` },
        { type: 'system', text: '────────────────────────────────────────' },
      ];
      selectAgent(data.id);
    }
  } catch (e) {
    showToast(`Failed to spawn: ${e.message}`);
  }
}

// ── SEND INPUT TO PTY AGENT ──
async function sendTerminalInput() {
  if (!selectedAgent) return;
  const input = document.getElementById('terminalInput');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';

  // Show what we sent in the terminal
  if (!outputBuffers[selectedAgent]) outputBuffers[selectedAgent] = [];
  outputBuffers[selectedAgent].push({ type: 'prompt', text: '> ' + text });
  renderTerminal(selectedAgent);

  try {
    await api(`/api/mc/agents/${selectedAgent}/respond`, {
      method: 'POST',
      body: { choice: text },
    });
  } catch (e) {
    outputBuffers[selectedAgent].push({ type: 'error', text: 'Failed to send: ' + e.message });
    renderTerminal(selectedAgent);
  }
}

// ── TOGGLE MODE (REAL API) ──
async function toggleMode() {
  if (!selectedAgent) return;
  const agent = agents.find(a => a.id === selectedAgent);
  if (!agent) return;

  const newMode = agent.mode === 'manual' ? 'auto' : 'manual';

  try {
    await api(`/api/mc/agents/${selectedAgent}/mode`, {
      method: 'POST',
      body: { mode: newMode },
    });

    agent.mode = newMode;
    document.getElementById('centerMode').textContent = newMode;
    document.getElementById('centerMode').className = 'mode-indicator ' + newMode;
    showToast(`Switched to ${newMode} mode`);
    renderMachines();
  } catch (e) {
    showToast(`Failed to toggle mode: ${e.message}`);
  }
}

// ── KILL AGENT (REAL API) ──
async function killAgent() {
  if (!selectedAgent) return;
  if (!confirm('Kill this agent session?')) return;

  try {
    await api(`/api/mc/agents/${selectedAgent}`, { method: 'DELETE' });
    showToast('Agent killed');

    await fetchAgents();
    selectedAgent = null;
    renderAll();

    document.getElementById('centerTitle').textContent = 'Agent killed';
    document.getElementById('centerActions').style.display = 'none';
    document.getElementById('agentTabs').style.display = 'none';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Agent session terminated.</div>';
  } catch (e) {
    showToast(`Failed to kill: ${e.message}`);
  }
}

// ── GLOBAL MODE ──
function setGlobalMode(mode) {
  document.querySelectorAll('.mode-btn.manual').forEach(b => b.classList.toggle('active', mode === 'manual'));
  document.querySelectorAll('.mode-btn.auto').forEach(b => b.classList.toggle('active', mode === 'auto'));
  // Toggle all agents
  agents.forEach(a => {
    api(`/api/mc/agents/${a.id}/mode`, { method: 'POST', body: { mode } }).catch(() => {});
    a.mode = mode;
  });
  machines.forEach(m => m.mode = mode);
  showToast(`Global mode: ${mode}`);
  renderAll();
}

// ── SWITCH AGENT TAB ──
function switchAgentTab(tab) {
  activeAgentTab = tab;
  document.querySelectorAll('.agent-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));

  document.getElementById('terminalView').style.display = tab === 'terminal' || tab === 'cost' ? 'flex' : 'none';
  document.getElementById('journalView').style.display = tab === 'journal' ? 'block' : 'none';
  document.getElementById('journalView').classList.toggle('active', tab === 'journal');

  if (tab === 'journal' && selectedAgent) {
    renderJournal(selectedAgent);
  }

  if (tab === 'cost' && selectedAgent) {
    const agent = agents.find(a => a.id === selectedAgent);
    if (agent) {
      const elapsed = agent.createdAt ? Math.floor((Date.now() - agent.createdAt) / 60000) : 0;
      document.getElementById('terminalOutput').innerHTML = `
        <div class="term-line system">Cost Breakdown for ${esc(agent.name)}</div>
        <div class="term-line system">────────────────────────────────────────</div>
        <div class="term-line output">  Total Cost:     $${(agent.cost || 0).toFixed(4)}</div>
        <div class="term-line output">  Tokens In:      ${(agent.tokensIn || 0).toLocaleString()}</div>
        <div class="term-line output">  Tokens Out:     ${(agent.tokensOut || 0).toLocaleString()}</div>
        <div class="term-line output">  Tool Calls:     ${agent.toolCalls || 0}</div>
        <div class="term-line output">  Duration:       ${elapsed}m</div>
        <div class="term-line system">────────────────────────────────────────</div>
        <div class="term-line output">  Avg cost/tool:  $${((agent.cost || 0) / Math.max(agent.toolCalls || 1, 1)).toFixed(4)}</div>
      `;
    }
  }
}

// ── MODAL ──
function openSpawnModal() {
  document.getElementById('spawnModal').classList.add('visible');
  if (selectedMachine) {
    document.getElementById('spawnMachine').value = selectedMachine;
  }
}

function closeSpawnModal() {
  document.getElementById('spawnModal').classList.remove('visible');
}

// ── VIEW TOGGLE ──
function setView(view) {
  currentView = view;
  document.getElementById('viewSingle').classList.toggle('active', view === 'single');
  document.getElementById('viewGrid').classList.toggle('active', view === 'grid');

  if (view === 'grid') {
    document.getElementById('terminalView').style.display = 'none';
    document.getElementById('journalView').style.display = 'none';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('agentTabs').style.display = 'none';
    document.getElementById('gridView').classList.add('active');
    document.getElementById('centerTitle').textContent = 'All Active Agents';
    document.getElementById('centerMode').style.display = 'none';
    document.getElementById('centerActions').style.display = 'none';
    renderGridView();
  } else {
    document.getElementById('gridView').classList.remove('active');
    if (selectedAgent) {
      selectAgent(selectedAgent);
    } else if (selectedMachine) {
      selectMachine(selectedMachine);
    } else {
      document.getElementById('terminalView').style.display = 'flex';
      document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Select a machine or spawn an agent.</div>';
    }
  }
}

function renderGridView() {
  const grid = document.getElementById('gridView');

  if (agents.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#64748b;padding:60px;font-size:14px;">No active agents. Click "+ Spawn Agent" to start one.</div>';
    return;
  }

  grid.innerHTML = agents.map(a => {
    const machine = machines.find(m => m.id === a.machineId) || { name: 'LOCAL' };
    const lines = (outputBuffers[a.id] || []).slice(-8);
    const elapsed = a.createdAt ? Math.floor((Date.now() - a.createdAt) / 60000) : 0;
    return `
      <div class="grid-tile ${a.status === 'waiting' ? 'waiting' : ''} ${selectedAgent === a.id ? 'selected' : ''}"
           onclick="gridTileClick('${esc(a.id)}')">
        <div class="grid-tile-header">
          <div class="grid-tile-title">
            <div class="dot ${a.status}"></div>
            <span>${esc(a.name)}</span>
          </div>
          <div class="grid-tile-badges">
            <span class="badge machine">${esc(machine.name)}</span>
            <span class="badge ${a.mode === 'auto' ? 'mode-a' : 'mode-m'}">${a.mode}</span>
            <span class="badge cost">$${(a.cost || 0).toFixed(2)}</span>
          </div>
        </div>
        <div class="grid-tile-body">
          <div class="gl system" style="color:#64748b;margin-bottom:4px;">${esc(a.task.substring(0, 100))}</div>
          ${lines.map(l => `<div class="gl ${l.type}">${l.type === 'tool' ? '<span style="color:#bc8cff;">' + esc(l.text) + '</span>' : esc(l.text)}</div>`).join('')}
        </div>
        <div class="grid-tile-footer">
          <span>${a.status.toUpperCase()}</span>
          <span>${(a.tokensIn/1000).toFixed(0)}K in</span>
          <span>${elapsed}m</span>
        </div>
      </div>
    `;
  }).join('');
}

function gridTileClick(agentId) {
  if (selectedAgent === agentId && currentView === 'grid') {
    setView('single');
    return;
  }
  selectedAgent = agentId;
  const agent = agents.find(a => a.id === agentId);
  if (agent) selectedMachine = agent.machineId || 'local';
  renderGridView();
  renderMachines();
}

// ── UTILITIES ──
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatAgo(ts) {
  const seconds = Math.floor((Date.now() - ts) / 1000);
  if (seconds < 0) return 'just now';
  if (seconds < 60) return seconds + 's ago';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  return Math.floor(seconds / 3600) + 'h ago';
}

function showToast(text) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = text;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// ── KEYBOARD SHORTCUTS ──
document.addEventListener('keydown', (e) => {
  if (['1','2','3'].includes(e.key) && !e.ctrlKey && !e.altKey &&
      document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const pending = prompts.find(p => !p.resolved);
    if (pending && pending.options[parseInt(e.key) - 1]) {
      const btn = document.querySelector(`#prompt-${pending.id} .prompt-option-btn:nth-child(${e.key})`);
      respondToPrompt(pending.id, parseInt(e.key), pending.agentId, btn);
    }
  }
  // Escape to close modal
  if (e.key === 'Escape') closeSpawnModal();
});

// ── INIT ──
async function init() {
  // Show loading
  document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Connecting to PIA...</div>';

  // Connect WebSocket
  connectWebSocket();

  // Fetch initial data
  await Promise.all([fetchMachines(), fetchAgents(), fetchPrompts()]);
  renderAll();

  document.getElementById('terminalOutput').innerHTML = `
    <div class="term-line system">PIA Mission Control connected.</div>
    <div class="term-line system">${machines.length} machine(s), ${agents.length} agent(s) active.</div>
    <div class="term-line system">────────────────────────────────────────</div>
    <div class="term-line system">Click a machine or "+ Spawn Agent" to begin.</div>
  `;

  // Refresh agents every 5s
  setInterval(async () => {
    await fetchAgents();
    await fetchPrompts();
    renderStats();
    // Refresh selected agent detail
    if (selectedAgent) {
      const agent = agents.find(a => a.id === selectedAgent);
      if (agent) updateCostFooter(agent);
    }
  }, 5000);

  // Refresh timestamps
  setInterval(() => renderPrompts(), 10000);
}

init();
</script>

</body>
</html>
