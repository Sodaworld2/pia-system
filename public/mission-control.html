<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIA Mission Control</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/xterm.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #050508;
      color: #e2e8f0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    .mc-header {
      background: linear-gradient(135deg, #0a0a12 0%, #12121e 100%);
      border-bottom: 1px solid #1e1e2e;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .mc-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mc-title h1 {
      font-size: 18px;
      font-weight: 800;
      background: linear-gradient(135deg, #9b4dca, #58a6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
    }

    .mc-title .subtitle {
      color: #64748b;
      font-size: 12px;
      font-weight: 400;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .global-mode-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #0f0f18;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      padding: 5px 12px;
      font-size: 12px;
    }

    .mode-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mode-btn.manual { background: #1a3a5c; color: #58a6ff; }
    .mode-btn.manual.active { background: #58a6ff; color: #000; }
    .mode-btn.auto { background: #1a2e1a; color: #3fb950; }
    .mode-btn.auto.active { background: #3fb950; color: #000; }

    .ws-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #64748b;
    }

    .ws-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #3fb950;
      animation: pulse 2s infinite;
    }

    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

    /* ── Stats Bar ── */
    .stats-bar {
      background: #0a0a12;
      border-bottom: 1px solid #1a1a2a;
      padding: 6px 20px;
      display: flex;
      gap: 24px;
      flex-shrink: 0;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 16px;
    }

    .stat-label { color: #64748b; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value.green { color: #3fb950; }
    .stat-value.orange { color: #d29922; }
    .stat-value.red { color: #f85149; }
    .stat-value.blue { color: #58a6ff; }
    .stat-value.purple { color: #bc8cff; }

    /* ── Main Layout ── */
    .mc-main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ── Left Panel: Machine Grid ── */
    .machine-panel {
      width: 320px;
      background: #0a0a10;
      border-right: 1px solid #1a1a2a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .panel-header {
      padding: 10px 16px;
      border-bottom: 1px solid #1a1a2a;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header .count {
      background: #1a1a2e;
      color: #bc8cff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
    }

    .machine-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .machine-tile {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .machine-tile:hover { border-color: #9b4dca; transform: translateY(-1px); }
    .machine-tile.selected { border-color: #9b4dca; background: #12101e; box-shadow: 0 0 20px rgba(155,77,202,0.15); }
    .machine-tile.has-prompt { border-left: 3px solid #d29922; }
    .machine-tile.has-prompt::after {
      content: '!';
      position: absolute;
      top: 8px;
      right: 10px;
      background: #d29922;
      color: #000;
      width: 18px; height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
      animation: pulse 1.5s infinite;
    }

    .machine-name {
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .machine-status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }

    .machine-status-dot.online { background: #3fb950; }
    .machine-status-dot.busy { background: #d29922; }
    .machine-status-dot.offline { background: #484f58; }
    .machine-status-dot.error { background: #f85149; }

    .machine-meta {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: #64748b;
    }

    .machine-ip { font-family: 'JetBrains Mono', monospace; }

    .machine-agents {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .agent-chip {
      font-size: 9px;
      padding: 2px 7px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .agent-chip.idle { background: #0d2818; color: #3fb950; }
    .agent-chip.working { background: #2a1f0f; color: #d29922; }
    .agent-chip.waiting { background: #2a0f0f; color: #f85149; animation: pulse 1.5s infinite; }
    .agent-chip.done { background: #1a1a2e; color: #8b949e; }

    .machine-mode {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mode-indicator {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .mode-indicator.manual { background: #0d1830; color: #58a6ff; }
    .mode-indicator.auto { background: #0d2818; color: #3fb950; }
    .mode-indicator.yolo { background: #2d1a0d; color: #f0883e; }
    .mode-indicator.plan { background: #1a0d2d; color: #bc8cff; }

    /* ── Center: Agent Detail / Terminal ── */
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .agent-detail-header {
      background: #0d0d15;
      border-bottom: 1px solid #1a1a2a;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .agent-detail-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .agent-detail-title h2 {
      font-size: 15px;
      font-weight: 700;
    }

    .agent-detail-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn:hover { filter: brightness(1.2); }
    .btn.green { background: #238636; color: white; }
    .btn.purple { background: #8957e5; color: white; }
    .btn.blue { background: #1f6feb; color: white; }
    .btn.red { background: #da3633; color: white; }
    .btn.ghost { background: #1a1a2e; color: #c9d1d9; border: 1px solid #2a2a3e; }

    .agent-tabs {
      display: flex;
      background: #0a0a12;
      border-bottom: 1px solid #1a1a2a;
      padding: 0 16px;
      flex-shrink: 0;
    }

    .agent-tab {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .agent-tab:hover { color: #c9d1d9; }
    .agent-tab.active { color: #bc8cff; border-bottom-color: #bc8cff; }

    /* Terminal View */
    .terminal-view {
      flex: 1;
      background: #080810;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .terminal-output {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #c9d1d9;
    }

    .term-line { margin-bottom: 2px; white-space: pre-wrap; word-break: break-word; }
    .term-line.system { color: #64748b; }
    .term-line.tool { color: #bc8cff; }
    .term-line.output { color: #c9d1d9; }
    .term-line.error { color: #f85149; }
    .term-line.success { color: #3fb950; }
    .term-line.prompt { color: #d29922; font-weight: 700; }

    .tool-call {
      background: #0f0f1a;
      border: 1px solid #1e1e30;
      border-left: 3px solid #bc8cff;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 6px 0;
      font-size: 12px;
    }

    .tool-call .tool-name { color: #bc8cff; font-weight: 700; }
    .tool-call .tool-args { color: #64748b; margin-top: 2px; }
    .tool-call .tool-result { color: #3fb950; margin-top: 4px; border-top: 1px solid #1e1e30; padding-top: 4px; }

    /* Journal View */
    .journal-view {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: none;
    }

    .journal-view.active { display: block; }

    .journal-entry {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 6px;
    }

    .journal-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .journal-time { font-size: 10px; color: #484f58; }
    .journal-type {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .journal-type.tool_call { background: #1f0d2a; color: #bc8cff; }
    .journal-type.output { background: #0d1830; color: #58a6ff; }
    .journal-type.prompt { background: #2a1f0f; color: #d29922; }
    .journal-type.response { background: #0d2818; color: #3fb950; }
    .journal-type.auto_approved { background: #0d2818; color: #3fb950; border: 1px solid #1a3a2d; }
    .journal-type.error { background: #2a0f0f; color: #f85149; }
    .journal-type.cost { background: #1a1a2e; color: #8b949e; }

    .journal-content {
      font-size: 13px;
      color: #c9d1d9;
      line-height: 1.5;
    }

    /* ── Machine Messages View ── */
    .messages-view {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: none;
      flex-direction: column;
    }
    .messages-view.active { display: flex; }

    .messages-compose {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .messages-compose select,
    .messages-compose input {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      color: #c9d1d9;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    .messages-compose select { width: 160px; }
    .messages-compose input { flex: 1; }
    .messages-compose button {
      background: #9b4dca;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .messages-compose button:hover { background: #b065e0; }

    .msg-card {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 6px;
    }
    .msg-card.unread { border-left: 3px solid #9b4dca; }
    .msg-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .msg-from { font-size: 12px; font-weight: 700; color: #bc8cff; }
    .msg-time { font-size: 10px; color: #484f58; }
    .msg-type-badge {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
      display: inline-block;
      margin-left: 8px;
    }
    .msg-type-badge.chat { background: #0d1830; color: #58a6ff; }
    .msg-type-badge.command { background: #1f0d2a; color: #bc8cff; }
    .msg-type-badge.status { background: #0d2818; color: #3fb950; }
    .msg-type-badge.task { background: #2a1f0f; color: #d29922; }
    .msg-type-badge.file { background: #1a1a2e; color: #8b949e; }
    .msg-type-badge.heartbeat { background: #0f0f18; color: #484f58; }
    .msg-content {
      font-size: 13px;
      color: #c9d1d9;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg-card .msg-mark-read {
      font-size: 10px;
      color: #484f58;
      cursor: pointer;
      float: right;
      margin-top: 4px;
    }
    .msg-card .msg-mark-read:hover { color: #9b4dca; }
    .messages-empty {
      color: #484f58;
      text-align: center;
      padding: 40px 0;
      font-size: 13px;
    }
    .msg-unread-badge {
      background: #9b4dca;
      color: #fff;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: 700;
    }

    /* ── Right Panel: Prompt Queue ── */
    .prompt-panel {
      width: 360px;
      background: #0a0a10;
      border-left: 1px solid #1a1a2a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .prompt-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .prompt-card {
      background: #0f0f18;
      border: 1px solid #1e1e30;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .prompt-card.urgent { border-color: #d29922; border-left: 3px solid #d29922; }
    .prompt-card.active { border-color: #9b4dca; background: #12101e; }
    .prompt-card.resolved { opacity: 0.5; border-color: #1a3a2d; }
    .prompt-card.auto-approved { border-color: #1a3a2d; background: #0a1a12; border-left: 3px solid #3fb950; opacity: 0.8; }
    .prompt-card.auto-approved .prompt-question { color: #8b949e; }
    .auto-badge { display: inline-block; background: #1a3a2d; color: #3fb950; font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 3px; margin-left: 8px; }

    .prompt-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .prompt-agent-name {
      font-weight: 700;
      font-size: 13px;
      color: #bc8cff;
    }

    .prompt-machine-tag {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #1c2333;
      color: #58a6ff;
      font-weight: 600;
    }

    .prompt-time {
      font-size: 10px;
      color: #484f58;
    }

    .prompt-question {
      font-size: 13px;
      color: #e2e8f0;
      line-height: 1.5;
      margin-bottom: 10px;
      padding: 8px 10px;
      background: #0a0a15;
      border-radius: 6px;
      border-left: 3px solid #d29922;
    }

    .prompt-options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .prompt-option-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #12121e;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .prompt-option-btn:hover { border-color: #9b4dca; background: #1a1a2e; }
    .prompt-option-btn.selected { border-color: #3fb950; background: #0d2818; color: #3fb950; }

    .prompt-option-num {
      background: #2a2a3e;
      color: #bc8cff;
      width: 22px; height: 22px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .prompt-text-input {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .prompt-text-input input {
      flex: 1;
      background: #0a0a15;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 7px 10px;
      color: #c9d1d9;
      font-size: 12px;
      outline: none;
    }

    .prompt-text-input input:focus { border-color: #9b4dca; }

    .prompt-text-input button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ── Spawn Modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.visible { display: flex; }

    .modal {
      background: #12121e;
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 24px;
      width: 460px;
      max-width: 90vw;
    }

    .modal h2 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #e6edf3;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal input, .modal select, .modal textarea {
      width: 100%;
      background: #0a0a15;
      border: 1px solid #2a2a3e;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    .modal textarea { min-height: 80px; resize: vertical; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .modal input:focus, .modal textarea:focus, .modal select:focus { border-color: #9b4dca; }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-cancel {
      background: #1a1a2e;
      color: #c9d1d9;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
    }

    /* ── Toast ── */
    .toast-container {
      position: fixed;
      top: 60px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: #1f2937;
      border: 1px solid #9b4dca;
      border-radius: 8px;
      padding: 10px 16px;
      color: #e6edf3;
      font-size: 13px;
      animation: toastIn 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 350px;
    }

    @keyframes toastIn { from { opacity:0; transform:translateX(100px); } to { opacity:1; transform:translateX(0); } }

    /* ── Grid View (multi-terminal) ── */
    .grid-view {
      flex: 1;
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      grid-template-rows: repeat(auto-fit, minmax(350px, 1fr));
      gap: 6px;
      padding: 6px;
      overflow-y: auto;
      background: #050508;
    }

    .grid-view.active { display: grid; }

    .grid-tile {
      background: #0a0a12;
      border: 1px solid #1e1e30;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 0;
    }

    .grid-tile:hover { border-color: #9b4dca; box-shadow: 0 0 15px rgba(155,77,202,0.15); }
    .grid-tile.waiting { border-color: #d29922; border-left: 3px solid #d29922; }
    .grid-tile.selected { border-color: #9b4dca; border-width: 2px; }

    .grid-tile-header {
      padding: 6px 10px;
      background: #0d0d18;
      border-bottom: 1px solid #1a1a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .grid-tile-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .grid-tile-title .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .grid-tile-title .dot.working { background: #3fb950; animation: pulse 1.5s infinite; box-shadow: 0 0 6px #3fb95066; }
    .grid-tile-title .dot.waiting { background: #d29922; animation: pulse 0.8s infinite; box-shadow: 0 0 6px #d2992266; }
    .grid-tile-title .dot.starting { background: #58a6ff; animation: pulse 0.6s infinite; box-shadow: 0 0 6px #58a6ff66; }
    .grid-tile-title .dot.idle { background: #484f58; }
    .grid-tile-title .dot.done { background: #58a6ff; box-shadow: 0 0 4px #58a6ff44; }
    .grid-tile-title .dot.error { background: #f85149; box-shadow: 0 0 6px #f8514966; }

    .grid-tile-badges {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .grid-tile-badges .badge {
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 8px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .grid-tile-badges .badge.machine { background: #1c2333; color: #58a6ff; }
    .grid-tile-badges .badge.mode-m { background: #0d1830; color: #58a6ff; }
    .grid-tile-badges .badge.mode-a { background: #0d2818; color: #3fb950; }
    .grid-tile-badges .badge.mode-y { background: #2d1a0d; color: #f0883e; }
    .grid-tile-badges .badge.mode-p { background: #1a0d2d; color: #bc8cff; }
    .grid-tile-badges .badge.cost { background: #1a1a2e; color: #8b949e; }

    .grid-tile-body {
      flex: 1;
      overflow-y: auto;
      padding: 6px 10px;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #8b949e;
      min-height: 0;
    }

    .grid-tile-body .gl { white-space: pre-wrap; word-break: break-word; margin-bottom: 1px; }
    .grid-tile-body .gl.system { color: #484f58; }
    .grid-tile-body .gl.tool { color: #bc8cff; }
    .grid-tile-body .gl.output { color: #c9d1d9; }
    .grid-tile-body .gl.error { color: #f85149; }
    .grid-tile-body .gl.success { color: #3fb950; }
    .grid-tile-body .gl.prompt { color: #d29922; font-weight: 700; }

    .grid-tile-footer {
      padding: 4px 10px;
      border-top: 1px solid #1a1a2a;
      font-size: 10px;
      color: #484f58;
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .grid-tile-input {
      display: flex;
      padding: 4px 6px;
      border-top: 1px solid #1a1a2a;
      background: #0d0d18;
      flex-shrink: 0;
    }

    .grid-tile-input input {
      flex: 1;
      background: #0a0a12;
      border: 1px solid #2a2a3a;
      border-radius: 4px;
      color: #e6edf3;
      padding: 4px 8px;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
    }

    .grid-tile-input input:focus { border-color: #9b4dca; }

    .grid-tile-input button {
      background: #9b4dca;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      margin-left: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    /* View Toggle Button */
    .view-toggle {
      display: flex;
      align-items: center;
      background: #0f0f18;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      overflow: hidden;
    }

    .view-toggle-btn {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: #64748b;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .view-toggle-btn:hover { color: #c9d1d9; }
    .view-toggle-btn.active { background: #9b4dca; color: white; }

    /* ── Cost Tracker ── */
    .cost-tracker {
      padding: 8px 16px;
      border-top: 1px solid #1a1a2a;
      background: #0a0a10;
      font-size: 11px;
      color: #64748b;
      display: flex;
      gap: 16px;
      flex-shrink: 0;
    }

    .cost-item { display: flex; gap: 4px; align-items: center; }
    .cost-value { color: #3fb950; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

    /* ── Terminal Input Bar ── */
    .terminal-input-bar {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: #0d0d18;
      border-top: 1px solid #1e1e30;
      flex-shrink: 0;
    }

    .terminal-input-bar input {
      flex: 1;
      background: #080810;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      padding: 8px 12px;
      color: #c9d1d9;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
      font-size: 13px;
      outline: none;
    }

    .terminal-input-bar input:focus { border-color: #9b4dca; }

    .terminal-input-bar input::placeholder { color: #484f58; }

    .terminal-input-bar button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .terminal-input-bar button:hover { background: #2ea043; }
    .terminal-input-bar button:disabled { background: #333; color: #666; cursor: not-allowed; }

    /* ── Agent Status Banner ── */
    .agent-status-banner {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.5px;
      flex-shrink: 0;
      border-bottom: 1px solid #1a1a2a;
      font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
    }

    .agent-status-banner .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-status-banner.working {
      background: linear-gradient(90deg, #0a1a0a, #0d0d18);
      color: #3fb950;
      border-bottom-color: #1a3a1a;
    }
    .agent-status-banner.working .status-dot {
      background: #3fb950;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px #3fb95066;
    }

    .agent-status-banner.waiting {
      background: linear-gradient(90deg, #1a1500, #0d0d18);
      color: #d29922;
      border-bottom-color: #3a2a0a;
    }
    .agent-status-banner.waiting .status-dot {
      background: #d29922;
      animation: pulse 0.8s infinite;
      box-shadow: 0 0 8px #d2992266;
    }

    .agent-status-banner.done {
      background: linear-gradient(90deg, #0a0a1a, #0d0d18);
      color: #58a6ff;
      border-bottom-color: #1a1a3a;
    }
    .agent-status-banner.done .status-dot {
      background: #58a6ff;
      box-shadow: 0 0 8px #58a6ff66;
    }

    .agent-status-banner.error {
      background: linear-gradient(90deg, #1a0a0a, #0d0d18);
      color: #f85149;
      border-bottom-color: #3a1a1a;
    }
    .agent-status-banner.error .status-dot {
      background: #f85149;
      box-shadow: 0 0 8px #f8514966;
    }

    .agent-status-banner.idle {
      background: linear-gradient(90deg, #0a1a0a, #0d0d18);
      color: #3fb950;
      border-bottom-color: #1a3a1a;
    }
    .agent-status-banner.idle .status-dot {
      background: #3fb950;
      box-shadow: 0 0 8px #3fb95066;
    }

    .agent-status-banner.starting {
      background: linear-gradient(90deg, #0a0a1a, #0d0d18);
      color: #58a6ff;
      border-bottom-color: #1a1a3a;
    }
    .agent-status-banner.starting .status-dot {
      background: #58a6ff;
      animation: pulse 0.6s infinite;
      box-shadow: 0 0 8px #58a6ff66;
    }

    .agent-status-banner .status-text { flex: 1; }
    .agent-status-banner .status-detail {
      font-size: 11px;
      font-weight: 400;
      color: #64748b;
    }

    /* ── Power State ── */
    .power-dot {
      width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px;
    }
    .power-dot.off { background: #f85149; }
    .power-dot.awake { background: #d29922; animation: pulse 1.5s infinite; }
    .power-dot.online { background: #3fb950; }
    .power-dot.unknown { background: #484f58; }

    .power-actions { display: flex; gap: 4px; margin-top: 6px; }
    .power-actions button {
      font-size: 10px; padding: 2px 8px; border-radius: 4px; cursor: pointer;
      border: 1px solid #2a2a3e; background: #1a1a2e; color: #c9d1d9;
    }
    .power-actions button:hover { border-color: #9b4dca; color: #bc8cff; }
    .power-actions button.wake-btn { border-color: #d29922; color: #d29922; }
    .power-actions button.wake-btn:hover { background: #d2992220; }
    .power-actions button.boot-btn { border-color: #3fb950; color: #3fb950; }
    .power-actions button.boot-btn:hover { background: #3fb95020; }
    .power-actions button.gear-btn { border-color: #484f58; font-size: 12px; padding: 2px 6px; }

    .power-progress-toast {
      position: fixed; bottom: 20px; right: 20px; z-index: 300;
      background: #12121e; border: 1px solid #2a2a3e; border-radius: 10px;
      padding: 16px 20px; min-width: 300px; max-width: 400px;
      display: none; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .power-progress-toast.visible { display: block; }
    .power-progress-toast .ppt-title { font-size: 13px; font-weight: 600; color: #e6edf3; margin-bottom: 8px; }
    .power-progress-toast .ppt-message { font-size: 12px; color: #8b949e; margin-bottom: 8px; }
    .power-progress-toast .ppt-bar { height: 4px; background: #1a1a2e; border-radius: 2px; overflow: hidden; }
    .power-progress-toast .ppt-bar-fill { height: 100%; background: linear-gradient(90deg, #9b4dca, #bc8cff); transition: width 0.5s; }
    .power-progress-toast .ppt-close { position: absolute; top: 8px; right: 12px; cursor: pointer; color: #484f58; font-size: 14px; }

    /* ── Responsive ── */
    @media (max-width: 1200px) {
      .machine-panel { width: 260px; }
      .prompt-panel { width: 300px; }
    }
    @media (max-width: 900px) {
      .prompt-panel { display: none; }
    }
    @media (max-width: 700px) {
      .machine-panel { display: none; }
    }

    /* ── Context Bar (Change 2) ── */
    .ctx-bar { height: 3px; border-radius: 2px; margin-top: 6px; background: #1e1e30; overflow: hidden; }
    .ctx-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
    .ctx-bar-fill.ctx-low { background: #3fb950; }
    .ctx-bar-fill.ctx-med { background: #f59e0b; }
    .ctx-bar-fill.ctx-high { background: #ef4444; }
    .ctx-label { font-size: 10px; color: #64748b; margin-top: 2px; }

    /* ── Branch Badge (Change 6) ── */
    .branch-badge { font-size: 9px; padding: 1px 6px; border-radius: 8px; background: #1c2333; color: #58a6ff; font-weight: 600; white-space: nowrap; }

    /* ── Kill buttons in stats bar (Change 4) ── */
    .kill-btn { font-size: 10px; padding: 2px 10px; border-radius: 4px; cursor: pointer; border: 1px solid; font-weight: 700; transition: all 0.15s; }
    .kill-btn:hover { filter: brightness(1.3); }
    .kill-btn.kill-all { border-color: #f85149; color: #f85149; background: #2a0f0f; }
    .kill-btn.kill-done { border-color: #484f58; color: #8b949e; background: #1a1a2e; }
    .kill-btn.kill-errors { border-color: #d29922; color: #d29922; background: #2a1f0f; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="mc-header">
    <div class="mc-title">
      <h1>PIA MISSION CONTROL</h1>
      <span class="subtitle">Claude Code Fleet Manager</span>
    </div>
    <div class="header-controls">
      <div class="global-mode-toggle">
        <span style="color:#64748b;font-size:11px;">Global:</span>
        <button class="mode-btn manual active" onclick="setGlobalMode('manual')">Manual</button>
        <button class="mode-btn auto" onclick="setGlobalMode('auto')">Auto</button>
      </div>
      <div class="view-toggle">
        <button class="view-toggle-btn active" onclick="setView('single')" id="viewSingle">Single</button>
        <button class="view-toggle-btn" onclick="setView('grid')" id="viewGrid">Grid</button>
      </div>
      <button class="btn purple" onclick="openSpawnModal()">+ Spawn Agent</button>
      <a href="/pia-admin.html" style="color:#58a6ff;font-size:12px;text-decoration:none;padding:5px 12px;border:1px solid #2a2a3e;border-radius:6px;transition:all 0.2s;">PIA Admin</a>
      <div class="ws-status">
        <div class="ws-dot"></div>
        <span>Connected</span>
      </div>
      <div class="ws-status" id="waStatus" style="cursor:pointer;" onclick="toggleWhatsApp()" title="Click to connect/disconnect WhatsApp">
        <div class="ws-dot" id="waDot" style="background:#484f58;"></div>
        <span id="waLabel">WhatsApp</span>
      </div>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat"><span class="stat-value blue">6</span><span class="stat-label">Machines</span></div>
    <div class="stat"><span class="stat-value purple">4</span><span class="stat-label">Agents</span></div>
    <div class="stat"><span class="stat-value green">2</span><span class="stat-label">Working</span></div>
    <div class="stat"><span class="stat-value orange" id="statWaiting">2</span><span class="stat-label">Waiting</span></div>
    <div class="stat"><span class="stat-value" style="color:#c9d1d9;">1</span><span class="stat-label">Idle</span></div>
    <div class="stat"><span class="stat-value green">12</span><span class="stat-label">Done Today</span></div>
    <div class="stat"><span class="stat-value red">1</span><span class="stat-label">Errors</span></div>
    <div class="stat" style="margin-left:auto;"><span class="stat-label">Cost Today</span><span class="stat-value green" style="font-size:14px;">$2.47</span></div>
    <div class="stat"><span class="stat-label">Tokens</span><span class="stat-value" style="font-size:14px;color:#bc8cff;">184K</span></div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="mc-main">

    <!-- LEFT: Machine Grid -->
    <div class="machine-panel">
      <div class="panel-header">
        Machines <span class="count">6 online</span>
      </div>
      <div class="machine-list" id="machineList"></div>

      <!-- Browser Controller Panel -->
      <div id="bcPanel" style="border-top:1px solid #1a1a2a;margin-top:auto;padding:0;">
        <div onclick="document.getElementById('bcBody').style.display=document.getElementById('bcBody').style.display==='none'?'block':'none'" style="padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;">
          <span>Browser Controller</span>
          <span id="bcDot" style="width:8px;height:8px;border-radius:50%;background:#484f58;display:inline-block;"></span>
        </div>
        <div id="bcBody" style="display:none;padding:8px 12px;font-size:11px;">
          <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">Status</span><span id="bcStatus" style="color:#e2e8f0;">stopped</span></div>
            <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">URL</span><span id="bcUrl" style="color:#e2e8f0;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="">-</span></div>
            <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">Commands</span><span id="bcCommands" style="color:#e2e8f0;">0</span></div>
            <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">Gemini</span><span id="bcGemini" style="color:#e2e8f0;">0 calls</span></div>
          </div>
          <div id="bcScreenshot" style="text-align:center;margin-bottom:8px;"></div>
          <div style="display:flex;gap:8px;">
            <button id="bcStartBtn" onclick="startBrowserController()" style="flex:1;padding:4px 8px;border:1px solid #2a2a3a;border-radius:4px;background:#0f0f18;color:#e2e8f0;font-size:11px;cursor:pointer;">Start</button>
            <button id="bcStopBtn" onclick="stopBrowserController()" disabled style="flex:1;padding:4px 8px;border:1px solid #2a2a3a;border-radius:4px;background:#0f0f18;color:#e2e8f0;font-size:11px;cursor:pointer;opacity:0.4;">Stop</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER: Agent Detail -->
    <div class="center-panel">
      <div class="agent-detail-header">
        <div class="agent-detail-title">
          <h2 id="centerTitle">Select a machine to view agents</h2>
          <span class="mode-indicator manual" id="centerMode" style="display:none;">Manual</span>
        </div>
        <div class="agent-detail-actions" id="centerActions" style="display:none;">
          <button class="btn ghost" onclick="toggleMode()">Toggle Mode</button>
          <button class="btn blue" onclick="openSpawnModal()">+ Spawn</button>
          <button class="btn red" onclick="killAgent()">Kill</button>
        </div>
      </div>

      <div class="agent-tabs" id="agentTabs" style="display:none;">
        <div class="agent-tab active" data-tab="terminal" onclick="switchAgentTab('terminal')">Terminal</div>
        <div class="agent-tab" data-tab="journal" onclick="switchAgentTab('journal')">Journal</div>
        <div class="agent-tab" data-tab="cost" onclick="switchAgentTab('cost')">Cost</div>
        <div class="agent-tab" data-tab="messages" onclick="switchAgentTab('messages')">Messages <span id="msgUnreadBadge" class="msg-unread-badge" style="display:none;">0</span></div>
      </div>

      <!-- Agent Status Banner -->
      <div class="agent-status-banner" id="agentStatusBanner">
        <div class="status-dot"></div>
        <span class="status-text" id="statusText">CLAUDE RUNNING</span>
        <span class="status-detail" id="statusDetail"></span>
      </div>

      <!-- Terminal Output -->
      <div class="terminal-view" id="terminalView">
        <div class="terminal-output" id="terminalOutput">
          <div class="term-line system">Welcome to PIA Mission Control.</div>
          <div class="term-line system">Click a machine tile on the left to view its agent sessions.</div>
          <div class="term-line system">Use "+ Spawn Agent" to start a new Claude Code agent on any machine.</div>
          <div class="term-line system">Prompts requiring your input appear in the right panel.</div>
        </div>
      </div>

      <!-- Terminal Input Bar -->
      <div class="terminal-input-bar" id="terminalInputBar" style="display:none;">
        <input type="text" id="terminalInput" placeholder="Type a message to the agent..."
               onkeydown="if(event.key==='Enter')sendTerminalInput()">
        <button onclick="sendTerminalInput()" id="terminalSendBtn">Send</button>
      </div>

      <!-- Grid View (all agents tiled) -->
      <div class="grid-view" id="gridView"></div>

      <!-- Journal View (hidden by default) -->
      <div class="journal-view" id="journalView"></div>

      <!-- Messages View (hidden by default) -->
      <div class="messages-view" id="messagesView">
        <div class="messages-compose">
          <select id="msgTargetMachine">
            <option value="*">All Machines</option>
          </select>
          <input type="text" id="msgContent" placeholder="Type a message..."
                 onkeydown="if(event.key==='Enter')sendBoardMessage()">
          <button onclick="sendBoardMessage()">Send</button>
        </div>
        <div id="messagesListContainer"></div>
      </div>

      <!-- Cost footer -->
      <div class="cost-tracker" id="costTracker" style="display:none;">
        <div class="cost-item">Session: <span class="cost-value" id="costSession">$0.00</span></div>
        <div class="cost-item">Tokens in: <span class="cost-value" id="costIn">0</span></div>
        <div class="cost-item">Tokens out: <span class="cost-value" id="costOut">0</span></div>
        <div class="cost-item">Tool calls: <span class="cost-value" id="costTools">0</span></div>
        <div class="cost-item">Duration: <span class="cost-value" id="costDuration">0m</span></div>
      </div>
    </div>

    <!-- RIGHT: Prompt Queue -->
    <div class="prompt-panel">
      <div class="panel-header">
        Prompt Queue <span class="count" id="promptCount">2 pending</span>
      </div>
      <div class="prompt-list" id="promptList"></div>
    </div>

  </div>

  <!-- SPAWN MODAL -->
  <!-- WhatsApp QR Modal -->
  <div class="modal-overlay" id="waModal">
    <div class="modal" style="max-width:400px;text-align:center;">
      <h2>WhatsApp Pairing</h2>
      <div id="waModalBody">
        <p style="color:#8b949e;font-size:13px;">Starting WhatsApp... Check server terminal for QR code.</p>
        <p style="color:#8b949e;font-size:12px;margin-top:12px;">Or scan the QR code below when it appears:</p>
        <div id="waQrDisplay" style="margin:16px auto;padding:16px;background:#fff;border-radius:8px;display:inline-block;min-height:60px;">
          <span style="color:#484f58;font-size:12px;">Waiting for QR...</span>
        </div>
        <p style="color:#484f58;font-size:11px;">Open WhatsApp on your phone &rarr; Settings &rarr; Linked Devices &rarr; Link a Device</p>
      </div>
      <button class="btn ghost" onclick="document.getElementById('waModal').classList.remove('visible')" style="margin-top:12px;">Close</button>
    </div>
  </div>

  <div class="modal-overlay" id="spawnModal">
    <div class="modal" style="max-width:520px;max-height:90vh;overflow-y:auto;">
      <h2>Spawn New Agent</h2>

      <label>Template (optional)</label>
      <select id="spawnTemplate" onchange="applyTemplate()" style="margin-bottom:6px;">
        <option value="">— No template (manual config) —</option>
      </select>

      <label>Soul (optional personality)</label>
      <select id="soul-select" style="margin-bottom:4px;" onchange="onSoulSelect()">
        <option value="">No soul (vanilla)</option>
      </select>
      <div id="soul-preview" style="font-size:11px; color: #64748b; margin-top:4px; margin-bottom:8px;"></div>

      <label>Project</label>
      <select id="spawnProject" onchange="onProjectSelect()" style="margin-bottom:6px;">
        <option value="">Loading projects...</option>
      </select>

      <label id="spawnCwdLabel">Working Directory</label>
      <div id="spawnCwdRow" style="display:flex;gap:6px;">
        <input type="text" id="spawnCwd" placeholder="C:\Users\mic\Projects\my-app" value="C:\Users\mic\Downloads\pia-system" style="flex:1;" onchange="suggestAdditionalDirs(this.value)">
        <button class="btn purple" onclick="openFolderBrowser()" style="white-space:nowrap;padding:8px 12px;">Browse</button>
      </div>
      <div id="folderBrowser" style="display:none;background:#0a0a14;border:1px solid #2a2a3a;border-radius:6px;margin-top:4px;">
        <div id="folderNav" style="display:flex;gap:4px;padding:6px 8px;background:#12121e;border-bottom:1px solid #1a1a2a;flex-wrap:wrap;align-items:center;"></div>
        <div style="display:flex;gap:4px;padding:4px 8px;border-bottom:1px solid #1a1a2a;background:#0d0d16;">
          <input type="text" id="folderSearchInput" placeholder="Search folders..." onkeydown="if(event.key==='Enter')searchFolders()" style="flex:1;font-size:11px;padding:3px 8px;background:#0a0a14;border:1px solid #2a2a3a;border-radius:4px;color:#e2e8f0;">
          <button onclick="searchFolders()" style="font-size:10px;padding:3px 8px;background:#1a1a2e;color:#9b4dca;border:1px solid #2a2a3a;border-radius:4px;cursor:pointer;">Search</button>
          <button onclick="clearFolderSearch()" id="folderSearchClear" style="display:none;font-size:10px;padding:3px 8px;background:#2a1a1a;color:#f85149;border:1px solid #3a2a2a;border-radius:4px;cursor:pointer;">Clear</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border-bottom:1px solid #1a1a2a;background:#0d0d16;">
          <div style="display:flex;gap:4px;">
            <button onclick="setFolderSort('name')" id="sortName" class="fb-sort active" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#1a1a2e;color:#9b4dca;cursor:pointer;">Name</button>
            <button onclick="setFolderSort('date')" id="sortDate" class="fb-sort" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#0a0a14;color:#64748b;cursor:pointer;">Date</button>
            <button onclick="setFolderSort('type')" id="sortType" class="fb-sort" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#0a0a14;color:#64748b;cursor:pointer;">Type</button>
          </div>
          <label style="font-size:10px;color:#64748b;display:flex;align-items:center;gap:4px;">
            <input type="checkbox" id="folderShowHidden" onchange="reloadFolderList()" style="width:12px;height:12px;"> Hidden
          </label>
        </div>
        <div id="folderList" style="font-size:12px;font-family:monospace;max-height:250px;overflow-y:auto;"></div>
      </div>

      <label>Additional Directories (agent can access files here too)</label>
      <div style="display:flex;gap:6px;">
        <input type="text" id="spawnAdditionalDirs" placeholder="e.g. C:\Users\mic\Downloads, C:\Users\mic\shared-libs" style="font-size:12px;flex:1;">
        <button class="btn purple" onclick="openAddDirBrowser()" style="white-space:nowrap;padding:8px 12px;">Browse</button>
      </div>
      <div id="addDirBrowser" style="display:none;background:#0a0a14;border:1px solid #2a2a3a;border-radius:6px;margin-top:4px;">
        <div id="addDirNav" style="display:flex;gap:4px;padding:6px 8px;background:#12121e;border-bottom:1px solid #1a1a2a;flex-wrap:wrap;align-items:center;"></div>
        <div style="display:flex;gap:4px;padding:4px 8px;border-bottom:1px solid #1a1a2a;background:#0d0d16;">
          <input type="text" id="addDirSearchInput" placeholder="Search folders..." onkeydown="if(event.key==='Enter')searchAddDirs()" style="flex:1;font-size:11px;padding:3px 8px;background:#0a0a14;border:1px solid #2a2a3a;border-radius:4px;color:#e2e8f0;">
          <button onclick="searchAddDirs()" style="font-size:10px;padding:3px 8px;background:#1a1a2e;color:#9b4dca;border:1px solid #2a2a3a;border-radius:4px;cursor:pointer;">Search</button>
          <button onclick="clearAddDirSearch()" id="addDirSearchClear" style="display:none;font-size:10px;padding:3px 8px;background:#2a1a1a;color:#f85149;border:1px solid #3a2a2a;border-radius:4px;cursor:pointer;">Clear</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border-bottom:1px solid #1a1a2a;background:#0d0d16;">
          <div style="display:flex;gap:4px;">
            <button onclick="setAddDirSort('name')" id="addSortName" class="adb-sort active" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#1a1a2e;color:#9b4dca;cursor:pointer;">Name</button>
            <button onclick="setAddDirSort('date')" id="addSortDate" class="adb-sort" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#0a0a14;color:#64748b;cursor:pointer;">Date</button>
            <button onclick="setAddDirSort('type')" id="addSortType" class="adb-sort" style="font-size:10px;padding:2px 8px;border:1px solid #2a2a3a;border-radius:3px;background:#0a0a14;color:#64748b;cursor:pointer;">Type</button>
          </div>
          <label style="font-size:10px;color:#64748b;display:flex;align-items:center;gap:4px;">
            <input type="checkbox" id="addDirShowHidden" onchange="reloadAddDirList()" style="width:12px;height:12px;"> Hidden
          </label>
        </div>
        <div id="addDirList" style="font-size:12px;font-family:monospace;max-height:250px;overflow-y:auto;"></div>
      </div>
      <div style="font-size:10px;color:#64748b;margin-top:4px;margin-bottom:8px;">Comma-separated paths. Agent can read/write files here in addition to the working directory.</div>

      <label>Initial Task (optional — leave blank to start chatting)</label>
      <textarea id="spawnTask" placeholder="Leave empty to start a conversation, or describe a task..."></textarea>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>Approval Mode</label>
          <select id="spawnInitMode">
            <option value="auto">Auto (approve unless dangerous)</option>
            <option value="manual">Manual (approve every action)</option>
            <option value="yolo">Yolo (approve EVERYTHING)</option>
            <option value="plan">Plan Only (read-only, no execution)</option>
          </select>
        </div>
        <div>
          <label>Model</label>
          <select id="spawnModel">
            <option value="claude-opus-4-6" selected>Opus 4.6 (most capable)</option>
            <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 (fast + capable)</option>
            <option value="claude-haiku-4-5-20251001">Haiku 4.5 (fastest, cheapest)</option>
          </select>
        </div>
        <div>
          <label>Effort Level</label>
          <select id="spawnEffort">
            <option value="">Default</option>
            <option value="max">Max (deepest reasoning)</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low (fastest)</option>
          </select>
        </div>
        <div>
          <label>Max Budget ($)</label>
          <input type="number" id="spawnBudget" value="5" min="0.5" max="100" step="0.5" style="width:100%;">
        </div>
      </div>

      <!-- Advanced Options (collapsible) -->
      <div style="margin-top:10px;">
        <div onclick="document.getElementById('advancedOpts').style.display = document.getElementById('advancedOpts').style.display === 'none' ? 'block' : 'none'; this.querySelector('span').textContent = document.getElementById('advancedOpts').style.display === 'none' ? '+' : '-';"
             style="cursor:pointer;color:#9b4dca;font-size:12px;font-weight:600;padding:4px 0;">
          <span>+</span> Advanced Options
        </div>
        <div id="advancedOpts" style="display:none;">
          <label>System Prompt (instructions for the agent)</label>
          <textarea id="spawnSystemPrompt" placeholder="e.g. You are a senior developer. Always write tests. Never modify package.json without asking." style="height:60px;font-size:11px;"></textarea>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <label>Max Turns</label>
              <input type="number" id="spawnMaxTurns" placeholder="Unlimited" min="1" max="200" style="width:100%;">
            </div>
            <div>
              <label>Target Machine</label>
              <select id="spawnMachine">
                <option value="local">LOCAL</option>
              </select>
            </div>
          </div>

          <label>Blocked Tools (comma-separated)</label>
          <input type="text" id="spawnDisallowedTools" placeholder="e.g. Bash, Write (leave empty for all tools)">

          <label>Allowed Tools Only (comma-separated — overrides blocklist)</label>
          <input type="text" id="spawnAllowedTools" placeholder="e.g. Read, Grep, Glob, Edit (empty = all allowed)">

          <!-- Additional Directories moved to main section above -->

          <label style="margin-top:8px;font-weight:600;color:#9b4dca;">Security (inspired by gh-aw)</label>
          <div style="margin-bottom:6px;">
            <label style="font-size:11px;color:#8892b0;">Network Ecosystems (allowed domains)</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:2px;">
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="ecoNpm" checked> npm
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="ecoPip"> pip
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="ecoGithub" checked> GitHub
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="ecoAnthropic" checked> Anthropic
              </label>
            </div>
          </div>
          <label style="font-size:11px;color:#8892b0;">Additional Allowed Domains</label>
          <input type="text" id="spawnAllowedDomains" placeholder="e.g. api.openai.com, registry.npmjs.org" style="font-size:11px;">
          <label style="font-size:11px;color:#8892b0;">Blocked Domains</label>
          <input type="text" id="spawnBlockedDomains" placeholder="e.g. evil.com, malware.net" style="font-size:11px;">

          <label style="margin-top:8px;font-weight:600;color:#9b4dca;">Stability</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;">
              <input type="checkbox" id="spawnCheckpointing" checked> File Checkpointing
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;">
              <input type="checkbox" id="spawnProjectSettings" checked> Load CLAUDE.md
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;">
              <input type="checkbox" id="spawnAutoRestart" checked> Auto-Restart on Error
            </label>
            <div>
              <label style="font-size:11px;">Fallback Model</label>
              <select id="spawnFallbackModel" style="font-size:11px;padding:2px 4px;">
                <option value="claude-sonnet-4-5-20250929">Sonnet 4.5 (default)</option>
                <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
                <option value="">None</option>
              </select>
            </div>
          </div>

          <label>Engine</label>
          <select id="spawnMode">
            <option value="sdk" selected>SDK Mode (Claude Agent SDK)</option>
            <option value="api">API Mode (PIA drives Claude API)</option>
            <option value="pty">PTY Mode (spawn real Claude CLI)</option>
          </select>

          <label style="margin-top:8px;font-weight:600;color:#9b4dca;">MCP Servers</label>
          <textarea id="spawnMcpServers" placeholder='[{"name":"playwright","transport":"stdio","command":"npx","args":["@anthropic-ai/mcp-server-playwright"]}]' style="height:60px;font-size:10px;font-family:monospace;"></textarea>
          <div style="font-size:10px;color:#64748b;margin-top:2px;">JSON array of MCP server configs. Each needs: name, transport (stdio/sse/http), and command+args or url.</div>
        </div>
      </div>

      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn-cancel" onclick="closeSpawnModal()">Cancel</button>
        <button class="btn purple" onclick="spawnAgent()">Spawn Agent</button>
      </div>
    </div>
  </div>

  <!-- Machine Settings Modal -->
  <div class="modal-overlay" id="machineSettingsModal">
    <div class="modal" style="max-width:440px;">
      <h2>Machine Settings</h2>
      <input type="hidden" id="msettMachineId">

      <label>MAC Address (for Wake-on-LAN)</label>
      <input type="text" id="msettMac" placeholder="AA-BB-CC-DD-EE-FF">

      <label>Tailscale IP</label>
      <input type="text" id="msettTailscaleIp" placeholder="100.x.x.x">

      <label>SSH User</label>
      <input type="text" id="msettSshUser" placeholder="User">

      <label>SSH Port</label>
      <input type="number" id="msettSshPort" value="22">

      <label>PIA Install Path</label>
      <input type="text" id="msettPiaPath" placeholder="C:\Users\User\Downloads\pia-system">

      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeMachineSettings()">Cancel</button>
        <button class="btn purple" onclick="saveMachineSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Power Progress Toast -->
  <div class="power-progress-toast" id="powerProgressToast">
    <span class="ppt-close" onclick="closePowerToast()">&times;</span>
    <div class="ppt-title" id="pptTitle">Waking machine...</div>
    <div class="ppt-message" id="pptMessage">Sending magic packet...</div>
    <div class="ppt-bar"><div class="ppt-bar-fill" id="pptBarFill" style="width:0%"></div></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

<script>
// ═══════════════════════════════════════════════════════════════════
// PIA Mission Control — LIVE (wired to real API + WebSocket)
// ═══════════════════════════════════════════════════════════════════

const API_BASE = '';  // same origin
const API_TOKEN = 'pia-local-dev-token-2024';
const WS_URL = `ws://${location.hostname}:3001`;

// ── STATE ──
let machines = [];        // from /api/machines
let agents = [];          // from /api/mc/agents
let prompts = [];         // from /api/mc/prompts + WebSocket
let outputBuffers = {};   // agentId -> [{type, text}]
let streamingAccum = {};  // agentId -> string (accumulates partial tokens before \n)
let selectedMachine = null;
let selectedAgent = null;
let activeAgentTab = 'terminal';
let currentView = 'single';
let ws = null;
let wsConnected = false;
let souls = [];           // from /api/souls (Change 1)
let currentBranch = 'unknown'; // from .git/HEAD (Change 6)

// ── API HELPERS ──
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    ...opts,
    headers: {
      'x-api-token': API_TOKEN,
      'Content-Type': 'application/json',
      ...(opts.headers || {}),
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`API ${res.status}: ${err}`);
  }
  return res.json();
}

// ── FETCH DATA ──
async function fetchMachines() {
  try {
    const data = await api('/api/machines');
    machines = (data.machines || data || []).map(m => ({
      id: m.id || m.name,
      name: (m.name || m.hostname || 'Unknown').toUpperCase(),
      ip: m.ip_address || m.ipAddress || 'local',
      status: m.status || 'online',
      mode: 'manual',
      capabilities: m.capabilities || {},
      powerState: m.power_state || (m.status === 'online' ? 'online' : 'unknown'),
    }));
  } catch (e) {
    // If no machines registered, show local machine
    machines = [];
  }
  // Always include local machine
  if (!machines.find(m => m.ip === 'local' || m.name === location.hostname.toUpperCase())) {
    machines.unshift({ id: 'local', name: 'LOCAL', ip: location.hostname, status: 'online', mode: 'manual' });
  }
}

async function fetchAgents() {
  try {
    const data = await api('/api/mc/agents');
    agents = (data.agents || []).map(a => ({
      id: a.id,
      name: a.id.substring(0, 8),
      status: mapStatus(a.status),
      task: a.task || '',
      cwd: a.cwd || '',
      mode: a.approvalMode || 'manual',
      machineId: a.machineId || 'local',
      cost: a.cost || 0,
      tokensIn: a.tokensIn || 0,
      tokensOut: a.tokensOut || 0,
      toolCalls: a.toolCalls || 0,
      createdAt: a.createdAt || Date.now(),
      errorMessage: a.errorMessage,
      soulId: a.soulId || null,
      contextUsed: a.contextUsed || a.context_used || 0,
      contextWindow: a.contextWindow || a.context_window || 0,
      model: a.model || '',
      hasAllowlist: a.hasAllowlist || false,
      hasNetworkPolicy: a.hasNetworkPolicy || false,
      restartCount: a.restartCount || 0,
    }));
  } catch (e) {
    console.error('Failed to fetch agents:', e);
  }
}

async function fetchPrompts() {
  try {
    const data = await api('/api/mc/prompts');
    prompts = (data.prompts || []).map(p => ({
      id: p.id,
      agentId: p.agentId,
      agentName: p.agentId?.substring(0, 8) || 'Agent',
      machine: 'LOCAL',
      timestamp: (p.timestamp || 0) * 1000 || Date.now(),
      question: p.question || '',
      options: p.options || ['Allow', 'Deny', 'Skip'],
      type: p.type || 'tool_approval',
      status: p.status || 'pending',
      resolved: p.status !== 'pending',
      resolvedWith: p.response,
    }));
  } catch (e) {
    console.error('Failed to fetch prompts:', e);
  }
}

async function fetchAgentDetail(agentId) {
  try {
    const data = await api(`/api/mc/agents/${agentId}`);
    if (data.buffer) {
      // Parse output buffer into lines
      const lines = data.buffer.split('\n').filter(l => l.trim());
      outputBuffers[agentId] = lines.map(l => classifyLine(l));
    }
    // Update agent in list
    if (data.agent) {
      const idx = agents.findIndex(a => a.id === agentId);
      if (idx >= 0) {
        agents[idx].cost = data.agent.cost || 0;
        agents[idx].tokensIn = data.agent.tokensIn || 0;
        agents[idx].tokensOut = data.agent.tokensOut || 0;
        agents[idx].toolCalls = data.agent.toolCalls || 0;
        agents[idx].status = mapStatus(data.agent.status);
      }
    }
  } catch (e) {
    console.error('Failed to fetch agent detail:', e);
  }
}

async function fetchJournal(agentId) {
  try {
    const data = await api(`/api/mc/agents/${agentId}/journal`);
    return data.journal || [];
  } catch (e) {
    console.error('Failed to fetch journal:', e);
    return [];
  }
}

function mapStatus(s) {
  if (s === 'working' || s === 'starting') return 'working';
  if (s === 'waiting_for_input') return 'waiting';
  if (s === 'done') return 'done';
  if (s === 'error') return 'error';
  if (s === 'idle') return 'idle';
  return s || 'idle';
}

function stripAnsi(str) {
  // Strip ANSI escape codes (colors, cursor movement, terminal control sequences)
  return str.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')
            .replace(/\x1b\][^\x07]*\x07/g, '')     // OSC sequences
            .replace(/\x1b\[\?[0-9;]*[a-zA-Z]/g, '') // Private sequences like ?25l
            .replace(/\x1b[()][A-Z0-9]/g, '')        // Character set selection
            .replace(/[\x00-\x08\x0e-\x1f]/g, '');   // Other control chars (keep \t \n \r)
}

function classifyLine(text) {
  const t = stripAnsi(text).trim();
  if (t.startsWith('Read ') || t.startsWith('Glob ') || t.startsWith('Grep ') ||
      t.startsWith('Edit ') || t.startsWith('Write ') || t.startsWith('Bash ')) {
    return { type: 'tool', text: t };
  }
  if (t.startsWith('FAIL') || t.startsWith('Error') || t.startsWith('error')) return { type: 'error', text: t };
  if (t.startsWith('PASS') || t.startsWith('Success') || t.startsWith('Applied') || t.startsWith('Created')) return { type: 'success', text: t };
  if (t.startsWith('WAITING') || t.startsWith('Agent needs')) return { type: 'prompt', text: t };
  if (t.startsWith('Agent ') || t.startsWith('Task:') || t === '────────────────────────────────────────') return { type: 'system', text: t };
  return { type: 'output', text: t };
}

// ── WEBSOCKET ──
function connectWebSocket() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    // Authenticate
    ws.send(JSON.stringify({ type: 'auth', payload: { token: API_TOKEN } }));
    // Subscribe to mission control events
    setTimeout(() => {
      ws.send(JSON.stringify({ type: 'mc:subscribe' }));
    }, 500);
    wsConnected = true;
    updateWsStatus(true);
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleWsMessage(msg);
    } catch (e) { /* ignore non-JSON */ }
  };

  ws.onclose = () => {
    wsConnected = false;
    updateWsStatus(false);
    // Reconnect after 3s
    setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => {
    wsConnected = false;
    updateWsStatus(false);
  };
}

function handleWsMessage(msg) {
  switch (msg.type) {
    case 'mc:output': {
      const { sessionId, data } = msg.payload || {};
      if (!sessionId || !data) return;
      if (!outputBuffers[sessionId]) outputBuffers[sessionId] = [];
      if (streamingAccum[sessionId] === undefined) streamingAccum[sessionId] = '';

      const buf = outputBuffers[sessionId];

      // Remove previous streaming preview line (it will be replaced with updated text)
      if (buf.length > 0 && buf[buf.length - 1]._streaming) {
        buf.pop();
      }

      // Accumulate incoming text fragment
      streamingAccum[sessionId] += data;

      // Split by newlines — everything before the last \n is a completed line
      const parts = streamingAccum[sessionId].split('\n');

      // Flush completed lines (all parts except the last)
      for (let i = 0; i < parts.length - 1; i++) {
        if (parts[i].trim()) {
          buf.push(classifyLine(parts[i]));
        }
      }

      // Keep the last part as the in-progress streaming text
      streamingAccum[sessionId] = parts[parts.length - 1];

      // Show the in-progress text as a live preview line
      if (streamingAccum[sessionId].trim()) {
        const preview = classifyLine(streamingAccum[sessionId]);
        preview._streaming = true;
        buf.push(preview);
      }

      // If this agent is selected, update the terminal live
      if (selectedAgent === sessionId && activeAgentTab === 'terminal') {
        renderTerminal(sessionId);
      }
      // Update grid view if active — only refresh the tile body to preserve input focus
      if (currentView === 'grid') updateGridTileBody(sessionId);
      break;
    }
    case 'mc:prompt': {
      const p = msg.payload;
      if (!p) return;
      // Add to prompt list if not already there
      if (!prompts.find(pp => pp.id === p.id)) {
        const isAutoApproved = p.status === 'auto_approved';
        prompts.push({
          id: p.id,
          agentId: p.agentId,
          agentName: (p.agentId || '').substring(0, 8),
          machine: 'LOCAL',
          timestamp: Date.now(),
          question: p.question || '',
          options: p.options || ['Allow', 'Deny', 'Skip'],
          type: p.type || 'tool_approval',
          resolved: isAutoApproved,
          resolvedWith: isAutoApproved ? (p.autoReason || 'Auto-approved') : undefined,
          status: p.status || 'pending',
        });
        // Cap auto-approved history at 100 entries
        if (prompts.length > 100) {
          const autoIdx = prompts.findIndex(pp => pp.status === 'auto_approved');
          if (autoIdx !== -1) prompts.splice(autoIdx, 1);
        }
        renderPrompts();
        // Only change agent status to waiting for NON-auto-approved prompts
        if (!isAutoApproved) {
          const agent = agents.find(a => a.id === p.agentId);
          if (agent) {
            agent.status = 'waiting';
            renderAll();
            if (selectedAgent === p.agentId) updateAgentStatusUI(agent);
          }
          showToast(`New prompt from ${(p.agentId || '').substring(0, 8)}`);
        }
      }
      break;
    }
    case 'mc:status': {
      const { sessionId, status, error } = msg.payload || {};
      if (!sessionId) return;
      const agent = agents.find(a => a.id === sessionId);
      if (agent) {
        agent.status = mapStatus(status);
        if (error) agent.errorMessage = error;
        renderAll();
        // Update status banner + input bar for the selected agent
        if (selectedAgent === sessionId) {
          updateAgentStatusUI(agent);
        }
        if (status === 'done' || status === 'idle' || status === 'error') {
          // Flush any remaining streaming accumulator text as a final line
          if (streamingAccum[sessionId] && streamingAccum[sessionId].trim()) {
            if (!outputBuffers[sessionId]) outputBuffers[sessionId] = [];
            const buf = outputBuffers[sessionId];
            // Remove streaming preview
            if (buf.length > 0 && buf[buf.length - 1]._streaming) buf.pop();
            buf.push(classifyLine(streamingAccum[sessionId]));
            streamingAccum[sessionId] = '';
          }
        }
        if (status === 'done') {
          showToast(`Agent ${sessionId.substring(0, 8)} completed`);
          // Fetch full output buffer from API now that agent is done
          fetchAgentDetail(sessionId).then(() => {
            if (selectedAgent === sessionId && activeAgentTab === 'terminal') {
              renderTerminal(sessionId);
            }
          });
        }
        if (status === 'error') showToast(`Agent ${sessionId.substring(0, 8)} error: ${error || 'unknown'}`);
      } else {
        // New agent we haven't seen yet — refresh
        fetchAgents().then(renderAll);
      }
      break;
    }
    case 'mc:agent_spawned':
      // Remote agent appeared — refresh agent list so it shows in the dashboard
      fetchAgents().then(renderAll);
      break;
    case 'authenticated':
      // Good, now subscribe
      break;
    case 'mc:browser_status':
      updateBcUI(msg.payload || {});
      break;
    case 'relay:message':
      // A cross-machine message arrived — refresh board if on messages tab
      if (activeAgentTab === 'messages') {
        fetchAndRenderMessages();
      } else {
        // Just update badge
        updateUnreadBadge();
      }
      break;
    case 'mc:power_event': {
      const pe = msg.payload;
      if (!pe) break;
      // Update machine power state in local state
      const pm = machines.find(m => m.id === pe.machineId);
      if (pm) {
        pm.powerState = pe.state;
        renderMachines();
      }
      // Update progress toast
      showPowerProgress(pe);
      break;
    }
  }
}

function updateWsStatus(connected) {
  const dot = document.querySelector('.ws-dot');
  const text = document.querySelector('.ws-status span');
  if (dot) dot.style.background = connected ? '#3fb950' : '#f85149';
  if (text) text.textContent = connected ? 'Connected' : 'Disconnected';
}

// ── RENDER FUNCTIONS ──

function getAgentsForMachine(machineId) {
  return agents.filter(a => a.machineId === machineId || (machineId === 'local' && (!a.machineId || a.machineId === 'local')));
}

function renderAll() {
  renderMachines();
  renderPrompts();
  renderStats();
  if (currentView === 'grid') renderGridView();
}

function renderStats() {
  const working = agents.filter(a => a.status === 'working').length;
  const waiting = agents.filter(a => a.status === 'waiting').length;
  const done = agents.filter(a => a.status === 'done').length;
  const errors = agents.filter(a => a.status === 'error').length;
  const idle = agents.filter(a => a.status === 'idle').length;
  const totalCost = agents.reduce((s, a) => s + (a.cost || 0), 0);
  const totalTokens = agents.reduce((s, a) => s + (a.tokensIn || 0) + (a.tokensOut || 0), 0);

  const statsBar = document.querySelector('.stats-bar');
  statsBar.innerHTML = `
    <div class="stat"><span class="stat-value blue">${machines.length}</span><span class="stat-label">Machines</span></div>
    <div class="stat"><span class="stat-value purple">${agents.length}</span><span class="stat-label">Agents</span></div>
    <div class="stat"><span class="stat-value green">${working}</span><span class="stat-label">Working</span></div>
    <div class="stat"><span class="stat-value orange" id="statWaiting">${waiting}</span><span class="stat-label">Waiting</span></div>
    <div class="stat"><span class="stat-value" style="color:#c9d1d9;">${idle}</span><span class="stat-label">Idle</span></div>
    <div class="stat"><span class="stat-value green">${done}</span><span class="stat-label">Done</span></div>
    <div class="stat"><span class="stat-value red">${errors}</span><span class="stat-label">Errors</span></div>
    <div class="stat" style="gap:6px;align-items:center;">
      <button class="kill-btn kill-all" onclick="killAll()" title="Kill all agents">Kill All</button>
      <button class="kill-btn kill-done" onclick="killDone()" title="Kill completed/idle agents">Kill Done</button>
      <button class="kill-btn kill-errors" onclick="killErrors()" title="Kill error agents">Kill Errors</button>
    </div>
    <div class="stat" style="margin-left:auto;"><span class="stat-label">Cost</span><span class="stat-value green" style="font-size:14px;">$${totalCost.toFixed(2)}</span></div>
    <div class="stat"><span class="stat-label">Tokens</span><span class="stat-value" style="font-size:14px;color:#bc8cff;">${totalTokens > 1000 ? (totalTokens/1000).toFixed(0) + 'K' : totalTokens}</span></div>
  `;
}

function renderMachines() {
  const list = document.getElementById('machineList');
  list.innerHTML = machines.map(m => {
    const mAgents = getAgentsForMachine(m.id);
    const hasPrompt = mAgents.some(a => a.status === 'waiting');
    const isSelected = selectedMachine === m.id;
    const ps = m.powerState || (m.status === 'online' ? 'online' : 'unknown');
    const hasMac = m.capabilities && m.capabilities.macAddress;
    const isOff = m.status !== 'online' && (ps === 'off' || ps === 'unknown');
    const isAwake = m.status !== 'online' && ps === 'awake';
    return `
      <div class="machine-tile ${isSelected ? 'selected' : ''} ${hasPrompt ? 'has-prompt' : ''}"
           onclick="selectMachine('${esc(m.id)}')">
        <div class="machine-name">
          <div class="machine-status-dot ${m.status === 'online' ? (mAgents.some(a => a.status === 'working') ? 'busy' : 'online') : m.status}"></div>
          ${esc(m.name)}
          <span class="power-dot ${ps}" title="Power: ${ps}" style="margin-left:auto;"></span>
        </div>
        <div class="machine-meta">
          <span class="machine-ip">${esc(m.ip)}</span>
          <span>${mAgents.length} agent${mAgents.length !== 1 ? 's' : ''}</span>
        </div>
        ${mAgents.length > 0 ? `
          <div class="machine-agents">
            ${mAgents.map(a => `<span class="agent-chip ${a.status}">${esc(a.name)}: ${a.status}</span>`).join('')}
          </div>
        ` : ''}
        <div class="machine-mode">
          <span class="mode-indicator ${m.mode}">${m.mode}</span>
        </div>
        <div class="power-actions" onclick="event.stopPropagation()">
          ${isOff && hasMac ? `<button class="wake-btn" onclick="wakeMachine('${esc(m.id)}')">Wake</button>` : ''}
          ${isAwake ? `<button class="boot-btn" onclick="bootstrapMachine('${esc(m.id)}')">Start PIA</button>` : ''}
          <button class="gear-btn" onclick="openMachineSettings('${esc(m.id)}')">&#9881;</button>
        </div>
      </div>
    `;
  }).join('');

  // Update machine dropdown in spawn modal
  const sel = document.getElementById('spawnMachine');
  sel.innerHTML = machines.map(m =>
    `<option value="${esc(m.id)}">${esc(m.name)} (${esc(m.ip)})</option>`
  ).join('');
  // Add change handler for project loading
  sel.onchange = () => loadProjectsForMachine(sel.value);
}

// ── PROJECT REGISTRY ──
let machineProjects = {};

async function loadProjectsForMachine(machineId) {
  const projSel = document.getElementById('spawnProject');
  if (!projSel) return;
  projSel.innerHTML = '<option value="">Loading...</option>';

  try {
    const data = await api(`/api/mc/machines/${encodeURIComponent(machineId)}/projects`);
    const projects = data.projects || [];
    machineProjects[machineId] = projects;

    let html = '';
    if (projects.length > 0) {
      for (const p of projects) {
        html += `<option value="${esc(p.path)}" title="${esc(p.path)}">${esc(p.name)} — ${esc(p.path)}</option>`;
      }
    }
    html += '<option value="__custom__">📁 Custom path...</option>';
    projSel.innerHTML = html;

    // Auto-select first project and fill CWD
    if (projects.length > 0) {
      projSel.value = projects[0].path;
      onProjectSelect();
    }
  } catch (e) {
    projSel.innerHTML = '<option value="__custom__">📁 Custom path (no projects found)</option>';
  }
}

function onProjectSelect() {
  const projSel = document.getElementById('spawnProject');
  const cwdInput = document.getElementById('spawnCwd');
  const cwdRow = document.getElementById('spawnCwdRow');
  const cwdLabel = document.getElementById('spawnCwdLabel');

  if (!projSel || !cwdInput) return;

  if (projSel.value === '__custom__') {
    // Show manual CWD input
    cwdRow.style.display = 'flex';
    cwdLabel.style.display = '';
    cwdInput.value = '';
    cwdInput.focus();
  } else if (projSel.value) {
    // Auto-fill CWD from selected project
    cwdInput.value = projSel.value;
    cwdRow.style.display = 'flex';
    cwdLabel.style.display = 'none';
    suggestAdditionalDirs(projSel.value);
  }
}

function selectMachine(machineId) {
  selectedMachine = machineId;
  const machine = machines.find(m => m.id === machineId);
  if (!machine) return;

  const mAgents = getAgentsForMachine(machineId);
  if (mAgents.length > 0) {
    selectAgent(mAgents[0].id);
  } else {
    selectedAgent = null;
    document.getElementById('centerTitle').textContent = machine.name + ' — No agents running';
    document.getElementById('centerMode').style.display = 'none';
    document.getElementById('centerActions').style.display = 'flex';
    document.getElementById('agentTabs').style.display = 'flex';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('terminalOutput').innerHTML = `
      <div class="term-line system">Machine: ${esc(machine.name)} (${esc(machine.ip)})</div>
      <div class="term-line system">Status: ${machine.status}</div>
      <div class="term-line system">No agents running. Click "+ Spawn Agent" to start one.</div>
    `;
  }
  renderMachines();
}

// ── UPDATE AGENT STATUS BANNER + INPUT BAR ──
function updateAgentStatusUI(agent) {
  if (!agent) {
    document.getElementById('agentStatusBanner').style.display = 'none';
    document.getElementById('terminalInputBar').style.display = 'none';
    return;
  }

  const banner = document.getElementById('agentStatusBanner');
  const inputBar = document.getElementById('terminalInputBar');
  const statusText = document.getElementById('statusText');
  const statusDetail = document.getElementById('statusDetail');
  const isAlive = (agent.status === 'working' || agent.status === 'waiting' || agent.status === 'idle' || agent.status === 'starting');

  // Status banner — always visible when agent selected
  banner.style.display = 'flex';
  banner.className = 'agent-status-banner ' + (agent.status || 'working');

  if (agent.status === 'working' || agent.status === 'starting') {
    statusText.textContent = 'CLAUDE IS RUNNING';
    statusDetail.textContent = agent.mode === 'auto' ? 'Auto-approve mode — agent runs autonomously' : 'Manual mode — approve each tool call';
  } else if (agent.status === 'waiting') {
    statusText.textContent = 'WAITING FOR YOUR INPUT';
    statusDetail.textContent = 'Type your response below and press Enter or click Send';
  } else if (agent.status === 'done') {
    statusText.textContent = 'COMPLETED — Session finished';
    statusDetail.textContent = `Cost: $${(agent.cost || 0).toFixed(2)} | Tools: ${agent.toolCalls || 0} — Click "+ Spawn" for a new task`;
  } else if (agent.status === 'error') {
    statusText.textContent = 'ERROR';
    statusDetail.textContent = agent.errorMessage || 'Agent encountered an error';
  } else if (agent.status === 'idle') {
    statusText.textContent = 'READY — Type a follow-up message';
    statusDetail.textContent = 'Claude finished the task. Send a message to continue the conversation.';
  }

  // Input bar — show when agent is alive
  if (isAlive) {
    inputBar.style.display = 'flex';
    document.getElementById('terminalInput').placeholder = `Type a message to agent ${agent.name || 'unknown'}...`;
  } else {
    inputBar.style.display = 'none';
  }
}

async function selectAgent(agentId) {
  const agent = agents.find(a => a.id === agentId);
  if (!agent) return;

  selectedAgent = agentId;
  selectedMachine = agent.machineId || 'local';
  const machine = machines.find(m => m.id === selectedMachine) || { name: 'LOCAL' };

  document.getElementById('centerTitle').textContent = `${machine.name} / ${agent.name} — ${agent.task.substring(0, 80)}`;
  document.getElementById('centerMode').style.display = '';
  document.getElementById('centerMode').textContent = agent.mode;
  document.getElementById('centerMode').className = 'mode-indicator ' + agent.mode;
  document.getElementById('centerActions').style.display = 'flex';
  document.getElementById('agentTabs').style.display = 'flex';
  document.getElementById('costTracker').style.display = 'flex';

  // Update status banner + input bar
  updateAgentStatusUI(agent);

  // Fetch agent detail if we don't have real output yet (startup lines don't count)
  const buf = outputBuffers[agentId] || [];
  const hasRealOutput = buf.some(l => l.type !== 'system');
  if (buf.length === 0 || (!hasRealOutput && agent.status === 'done')) {
    await fetchAgentDetail(agentId);
  }

  updateCostFooter(agent);
  switchAgentTab('terminal');
  renderTerminal(agentId);
  renderMachines();
}

function updateCostFooter(agent) {
  document.getElementById('costSession').textContent = '$' + (agent.cost || 0).toFixed(2);
  document.getElementById('costIn').textContent = (agent.tokensIn || 0) > 1000 ? ((agent.tokensIn/1000).toFixed(1) + 'K') : (agent.tokensIn || 0);
  document.getElementById('costOut').textContent = (agent.tokensOut || 0) > 1000 ? ((agent.tokensOut/1000).toFixed(1) + 'K') : (agent.tokensOut || 0);
  document.getElementById('costTools').textContent = agent.toolCalls || 0;
  const elapsed = agent.createdAt ? Math.floor((Date.now() - agent.createdAt) / 60000) : 0;
  document.getElementById('costDuration').textContent = elapsed + 'm';
}

function renderTerminal(agentId) {
  const output = document.getElementById('terminalOutput');
  const lines = outputBuffers[agentId] || [];

  if (lines.length === 0) {
    output.innerHTML = '<div class="term-line system">Waiting for agent output...</div>';
    return;
  }

  output.innerHTML = lines.map(l => {
    if (l.type === 'tool') {
      return `<div class="tool-call"><span class="tool-name">${esc(l.text)}</span></div>`;
    }
    return `<div class="term-line ${l.type}">${esc(l.text)}</div>`;
  }).join('');

  output.scrollTop = output.scrollHeight;
}

async function renderJournal(agentId) {
  const view = document.getElementById('journalView');
  const entries = await fetchJournal(agentId);

  if (entries.length === 0) {
    view.innerHTML = '<div style="color:#64748b;text-align:center;padding:40px;">No journal entries yet.</div>';
    return;
  }

  view.innerHTML = entries.map(e => {
    const time = e.createdAt ? new Date(e.createdAt * 1000).toLocaleTimeString() : '';
    return `
      <div class="journal-entry">
        <div class="journal-entry-header">
          <span class="journal-type ${esc(e.type)}">${esc((e.type || '').replace('_', ' '))}</span>
          <span class="journal-time">${esc(time)}</span>
        </div>
        <div class="journal-content">${esc(e.content || '')}</div>
      </div>
    `;
  }).join('');
}

function renderPrompts() {
  const list = document.getElementById('promptList');
  const count = document.getElementById('promptCount');
  const pending = prompts.filter(p => !p.resolved && p.status !== 'auto_approved');
  const autoCount = prompts.filter(p => p.status === 'auto_approved').length;
  count.textContent = pending.length > 0
    ? pending.length + ' pending'
    : autoCount > 0 ? autoCount + ' auto-approved' : '0 pending';

  if (prompts.length === 0) {
    list.innerHTML = '<div style="color:#64748b;text-align:center;padding:40px;font-size:13px;">No prompts. Agents running in auto mode or idle.</div>';
    return;
  }

  list.innerHTML = prompts.map(p => {
    const isAuto = p.status === 'auto_approved';
    const cardClass = isAuto ? 'auto-approved' : (!p.resolved ? 'urgent' : 'resolved');
    return `
    <div class="prompt-card ${cardClass}" id="prompt-${esc(p.id)}">
      <div class="prompt-card-header">
        <div>
          <div class="prompt-agent-name">${esc(p.agentName)}${isAuto ? '<span class="auto-badge">AUTO</span>' : ''}</div>
          <span class="prompt-machine-tag">${esc(p.machine)}</span>
        </div>
        <div class="prompt-time">${formatAgo(p.timestamp)}</div>
      </div>
      <div class="prompt-question">${esc(p.question)}</div>
      ${isAuto ? '<div style="color:#3fb950;font-size:11px;">Auto-approved</div>'
        : p.resolved ? '<div style="color:#3fb950;font-size:12px;font-weight:600;">Responded: ' + esc(p.resolvedWith || p.status) + '</div>' : `
        <div class="prompt-options">
          ${p.options.map((opt, i) => `
            <div class="prompt-option-btn" onclick="respondToPrompt('${esc(p.id)}', ${i + 1}, '${esc(p.agentId)}', this)">
              <span class="prompt-option-num">${i + 1}</span>
              <span>${esc(opt)}</span>
            </div>
          `).join('')}
        </div>
        <div class="prompt-text-input">
          <input type="text" placeholder="Or type a custom response..." id="promptInput-${esc(p.id)}"
                 onkeydown="if(event.key==='Enter')respondCustom('${esc(p.id)}','${esc(p.agentId)}')">
          <button onclick="respondCustom('${esc(p.id)}','${esc(p.agentId)}')">Send</button>
        </div>
      `}
    </div>
  `; }).join('');
}

// ── RESPOND TO PROMPT (REAL API) ──
async function respondToPrompt(promptId, choice, agentId, el) {
  if (el) el.classList.add('selected');

  try {
    // Send via REST API
    await api(`/api/mc/agents/${agentId}/respond`, {
      method: 'POST',
      body: { promptId, choice },
    });

    // Also send via WebSocket for faster delivery
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'mc:respond', payload: { promptId, choice } }));
    }

    // Update local state
    const prompt = prompts.find(p => p.id === promptId);
    if (prompt) {
      prompt.resolved = true;
      prompt.resolvedWith = prompt.options[choice - 1] || `Option ${choice}`;
    }

    showToast(`Responded: Option ${choice}`);
    renderPrompts();

    // Refresh agent status
    await fetchAgents();
    renderAll();
  } catch (e) {
    showToast(`Failed to respond: ${e.message}`);
  }
}

async function respondCustom(promptId, agentId) {
  const input = document.getElementById('promptInput-' + promptId);
  const text = input?.value?.trim();
  if (!text) return;

  try {
    await api(`/api/mc/agents/${agentId}/respond`, {
      method: 'POST',
      body: { promptId, choice: text },
    });

    const prompt = prompts.find(p => p.id === promptId);
    if (prompt) {
      prompt.resolved = true;
      prompt.resolvedWith = text;
    }

    showToast(`Responded: "${text}"`);
    renderPrompts();
    await fetchAgents();
    renderAll();
  } catch (e) {
    showToast(`Failed to respond: ${e.message}`);
  }
}

// ── SPAWN AGENT (REAL API) ──
async function spawnAgent() {
  const machineId = document.getElementById('spawnMachine').value;
  const mode = document.getElementById('spawnMode').value;
  const task = document.getElementById('spawnTask').value.trim();
  const approvalMode = document.getElementById('spawnInitMode').value;
  const cwd = document.getElementById('spawnCwd').value.trim();
  const model = document.getElementById('spawnModel').value;
  const effort = document.getElementById('spawnEffort').value || undefined;
  const maxBudget = parseFloat(document.getElementById('spawnBudget').value) || 5;
  const systemPrompt = document.getElementById('spawnSystemPrompt').value.trim() || undefined;
  const maxTurns = parseInt(document.getElementById('spawnMaxTurns').value) || undefined;
  const disallowedToolsRaw = document.getElementById('spawnDisallowedTools').value.trim();
  const disallowedTools = disallowedToolsRaw ? disallowedToolsRaw.split(',').map(t => t.trim()).filter(Boolean) : undefined;
  const allowedToolsRaw = document.getElementById('spawnAllowedTools').value.trim();
  const allowedTools = allowedToolsRaw ? allowedToolsRaw.split(',').map(t => t.trim()).filter(Boolean) : undefined;
  const addDirsRaw = document.getElementById('spawnAdditionalDirs').value.trim();
  const additionalDirectories = addDirsRaw ? addDirsRaw.split(',').map(d => d.trim()).filter(Boolean) : undefined;
  const enableCheckpointing = document.getElementById('spawnCheckpointing').checked;
  const loadProjectSettings = document.getElementById('spawnProjectSettings').checked;
  const autoRestart = document.getElementById('spawnAutoRestart').checked;
  const fallbackModel = document.getElementById('spawnFallbackModel').value || undefined;

  // MCP servers
  const mcpServersRaw = document.getElementById('spawnMcpServers').value.trim();
  let mcpServers;
  if (mcpServersRaw) {
    try {
      mcpServers = JSON.parse(mcpServersRaw);
      if (!Array.isArray(mcpServers)) { showToast('MCP Servers must be a JSON array'); return; }
    } catch (e) { showToast('Invalid MCP Servers JSON: ' + e.message); return; }
  }

  // Network policy — ecosystems + custom domains
  const ecosystems = [];
  if (document.getElementById('ecoNpm').checked) ecosystems.push('npm');
  if (document.getElementById('ecoPip').checked) ecosystems.push('pip');
  if (document.getElementById('ecoGithub').checked) ecosystems.push('github');
  if (document.getElementById('ecoAnthropic').checked) ecosystems.push('anthropic');
  const allowedDomainsRaw = document.getElementById('spawnAllowedDomains').value.trim();
  const allowedDomains = allowedDomainsRaw ? allowedDomainsRaw.split(',').map(d => d.trim()).filter(Boolean) : undefined;
  const blockedDomainsRaw = document.getElementById('spawnBlockedDomains').value.trim();
  const blockedDomains = blockedDomainsRaw ? blockedDomainsRaw.split(',').map(d => d.trim()).filter(Boolean) : undefined;
  const networkPolicy = (ecosystems.length || allowedDomains || blockedDomains)
    ? { ecosystems, allowedDomains, blockedDomains } : undefined;

  const soulId = document.getElementById('soul-select').value || undefined;

  if (!cwd) { showToast('Please enter a working directory'); return; }

  closeSpawnModal();
  showToast('Spawning agent...');

  try {
    const data = await api('/api/mc/agents', {
      method: 'POST',
      body: { machineId, mode, task, cwd, approvalMode, model, maxBudget,
              effort, systemPrompt, maxTurns, disallowedTools, allowedTools,
              additionalDirectories, networkPolicy, mcpServers,
              enableCheckpointing, loadProjectSettings, autoRestart, fallbackModel,
              soulId },
    });

    showToast(`Agent spawned: ${data.id?.substring(0, 8)}`);

    // Refresh agents and select the new one
    await fetchAgents();
    renderAll();
    if (data.id) {
      outputBuffers[data.id] = [
        { type: 'system', text: `Agent ${data.id.substring(0, 8)} started (${mode} mode, ${approvalMode})` },
        { type: 'system', text: task ? `Task: ${task}` : `Ready — type a message to start` },
        { type: 'system', text: '────────────────────────────────────────' },
      ];
      selectAgent(data.id);
    }
  } catch (e) {
    showToast(`Failed to spawn: ${e.message}`);
  }
}

// ── SEND INPUT TO PTY AGENT ──
async function sendTerminalInput() {
  if (!selectedAgent) return;
  const input = document.getElementById('terminalInput');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';

  // Show what we sent in the terminal
  if (!outputBuffers[selectedAgent]) outputBuffers[selectedAgent] = [];
  outputBuffers[selectedAgent].push({ type: 'prompt', text: '> ' + text });
  renderTerminal(selectedAgent);

  try {
    await api(`/api/mc/agents/${selectedAgent}/respond`, {
      method: 'POST',
      body: { choice: text },
    });
  } catch (e) {
    outputBuffers[selectedAgent].push({ type: 'error', text: 'Failed to send: ' + e.message });
    renderTerminal(selectedAgent);
  }
}

// ── TOGGLE MODE (REAL API) ──
async function toggleMode() {
  if (!selectedAgent) return;
  const agent = agents.find(a => a.id === selectedAgent);
  if (!agent) return;

  const modeOrder = ['manual', 'auto', 'yolo', 'plan'];
  const currentIdx = modeOrder.indexOf(agent.mode);
  const newMode = modeOrder[(currentIdx + 1) % modeOrder.length];

  try {
    await api(`/api/mc/agents/${selectedAgent}/mode`, {
      method: 'POST',
      body: { mode: newMode },
    });

    agent.mode = newMode;
    document.getElementById('centerMode').textContent = newMode;
    document.getElementById('centerMode').className = 'mode-indicator ' + newMode;
    showToast(`Switched to ${newMode} mode`);
    renderMachines();
  } catch (e) {
    showToast(`Failed to toggle mode: ${e.message}`);
  }
}

// ── KILL AGENT (REAL API) ──
async function killAgent() {
  if (!selectedAgent) return;
  if (!confirm('Kill this agent session?')) return;

  try {
    await api(`/api/mc/agents/${selectedAgent}`, { method: 'DELETE' });
    showToast('Agent killed');

    await fetchAgents();
    selectedAgent = null;
    renderAll();

    document.getElementById('centerTitle').textContent = 'Agent killed';
    document.getElementById('centerActions').style.display = 'none';
    document.getElementById('agentTabs').style.display = 'none';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Agent session terminated.</div>';
  } catch (e) {
    showToast(`Failed to kill: ${e.message}`);
  }
}

// ── GLOBAL MODE ──
function setGlobalMode(mode) {
  document.querySelectorAll('.mode-btn.manual').forEach(b => b.classList.toggle('active', mode === 'manual'));
  document.querySelectorAll('.mode-btn.auto').forEach(b => b.classList.toggle('active', mode === 'auto'));
  // Toggle all agents
  agents.forEach(a => {
    api(`/api/mc/agents/${a.id}/mode`, { method: 'POST', body: { mode } }).catch(() => {});
    a.mode = mode;
  });
  machines.forEach(m => m.mode = mode);
  showToast(`Global mode: ${mode}`);
  renderAll();
}

// ── SWITCH AGENT TAB ──
function switchAgentTab(tab) {
  activeAgentTab = tab;
  document.querySelectorAll('.agent-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));

  document.getElementById('terminalView').style.display = tab === 'terminal' || tab === 'cost' ? 'flex' : 'none';
  document.getElementById('journalView').style.display = tab === 'journal' ? 'block' : 'none';
  document.getElementById('journalView').classList.toggle('active', tab === 'journal');
  document.getElementById('messagesView').style.display = tab === 'messages' ? 'flex' : 'none';
  document.getElementById('messagesView').classList.toggle('active', tab === 'messages');

  if (tab === 'journal' && selectedAgent) {
    renderJournal(selectedAgent);
  }

  if (tab === 'messages') {
    fetchAndRenderMessages();
  }

  if (tab === 'cost' && selectedAgent) {
    const agent = agents.find(a => a.id === selectedAgent);
    if (agent) {
      const elapsed = agent.createdAt ? Math.floor((Date.now() - agent.createdAt) / 60000) : 0;
      document.getElementById('terminalOutput').innerHTML = `
        <div class="term-line system">Cost Breakdown for ${esc(agent.name)}</div>
        <div class="term-line system">────────────────────────────────────────</div>
        <div class="term-line output">  Total Cost:     $${(agent.cost || 0).toFixed(4)}</div>
        <div class="term-line output">  Tokens In:      ${(agent.tokensIn || 0).toLocaleString()}</div>
        <div class="term-line output">  Tokens Out:     ${(agent.tokensOut || 0).toLocaleString()}</div>
        <div class="term-line output">  Tool Calls:     ${agent.toolCalls || 0}</div>
        <div class="term-line output">  Duration:       ${elapsed}m</div>
        <div class="term-line system">────────────────────────────────────────</div>
        <div class="term-line output">  Avg cost/tool:  $${((agent.cost || 0) / Math.max(agent.toolCalls || 1, 1)).toFixed(4)}</div>
      `;
    }
  }
}

// ── WHATSAPP INTEGRATION ──
let waConnected = false;
let waPolling = null;

async function fetchWhatsAppStatus() {
  try {
    const data = await api('/api/whatsapp/status');
    waConnected = data.ready;
    const dot = document.getElementById('waDot');
    const label = document.getElementById('waLabel');
    if (data.ready) {
      dot.style.background = '#25D366';
      label.textContent = 'WA: ' + (data.phone || 'Connected');
    } else if (data.qrPending) {
      dot.style.background = '#d29922';
      label.textContent = 'WA: Scan QR';
    } else if (data.enabled) {
      dot.style.background = '#f85149';
      label.textContent = 'WA: Starting...';
    } else {
      dot.style.background = '#484f58';
      label.textContent = 'WhatsApp';
    }
    return data;
  } catch (e) {
    return { enabled: false, ready: false };
  }
}

async function toggleWhatsApp() {
  const status = await fetchWhatsAppStatus();
  if (status.ready) {
    // Already connected — offer to disconnect
    if (confirm('WhatsApp is connected. Disconnect?')) {
      await api('/api/whatsapp/stop', { method: 'POST' });
      fetchWhatsAppStatus();
      if (waPolling) { clearInterval(waPolling); waPolling = null; }
    }
    return;
  }

  // Start WhatsApp
  try {
    await api('/api/whatsapp/start', { method: 'POST' });
    document.getElementById('waModal').classList.add('visible');
    // Start polling for QR code and connection status
    startWaPolling();
  } catch (e) {
    showToast('Failed to start WhatsApp');
  }
}

function startWaPolling() {
  if (waPolling) clearInterval(waPolling);
  waPolling = setInterval(async () => {
    const status = await fetchWhatsAppStatus();
    if (status.ready) {
      // Connected! Close modal, stop polling
      document.getElementById('waModal').classList.remove('visible');
      document.getElementById('waQrDisplay').innerHTML = '<span style="color:#25D366;font-size:14px;font-weight:700;">Connected!</span>';
      showToast('WhatsApp connected as ' + (status.phone || 'unknown'));
      clearInterval(waPolling);
      waPolling = null;
      return;
    }
    // Try to fetch QR
    try {
      const qrData = await api('/api/whatsapp/qr');
      if (qrData.qr) {
        // Render QR code as a simple text block (the actual QR displays in server terminal)
        document.getElementById('waQrDisplay').innerHTML =
          '<div style="font-family:monospace;font-size:8px;line-height:8px;color:#000;white-space:pre;">' +
          'QR ready in server terminal' +
          '</div><p style="color:#25D366;font-size:12px;margin-top:8px;">Scan the QR code shown in the PIA server terminal</p>';
      }
    } catch { /* ignore */ }
  }, 3000);
}

// Check WhatsApp status on page load
setTimeout(fetchWhatsAppStatus, 2000);

// ── MACHINE MESSAGE BOARD ──
let boardMessages = [];

async function fetchAndRenderMessages() {
  try {
    const data = await api('/api/machine-board?limit=100');
    boardMessages = data.messages || [];
  } catch (e) {
    console.warn('Failed to fetch board messages:', e);
  }
  renderBoardMessages();
  updateMsgTargetDropdown();
  updateUnreadBadge();
}

function renderBoardMessages() {
  const container = document.getElementById('messagesListContainer');
  if (!boardMessages.length) {
    container.innerHTML = '<div class="messages-empty">No messages yet. Send a message to another machine.</div>';
    return;
  }
  container.innerHTML = boardMessages.map(m => {
    const time = new Date(m.created_at * 1000).toLocaleTimeString();
    const date = new Date(m.created_at * 1000).toLocaleDateString();
    const isUnread = !m.read;
    const toLabel = m.to_machine_id === '*' ? 'All' : esc(m.to_machine_name || m.to_machine_id);
    return `
      <div class="msg-card ${isUnread ? 'unread' : ''}">
        <div class="msg-card-header">
          <span>
            <span class="msg-from">${esc(m.from_machine_name || m.from_machine_id)}</span>
            <span style="color:#484f58;font-size:11px;"> &rarr; ${toLabel}</span>
            <span class="msg-type-badge ${m.type}">${m.type}</span>
          </span>
          <span class="msg-time">${date} ${time}</span>
        </div>
        <div class="msg-content">${esc(m.content)}</div>
        ${isUnread ? `<span class="msg-mark-read" onclick="markBoardMsgRead('${esc(m.id)}')">Mark read</span>` : ''}
      </div>
    `;
  }).join('');
}

function updateMsgTargetDropdown() {
  const sel = document.getElementById('msgTargetMachine');
  const opts = ['<option value="*">All Machines</option>'];
  machines.forEach(m => {
    opts.push(`<option value="${esc(m.id)}">${esc(m.name)}</option>`);
  });
  sel.innerHTML = opts.join('');
}

async function sendBoardMessage() {
  const to = document.getElementById('msgTargetMachine').value;
  const content = document.getElementById('msgContent').value.trim();
  if (!content) return;
  try {
    await api('/api/machine-board/send', { method: 'POST', body: { to, content, type: 'chat' } });
    document.getElementById('msgContent').value = '';
    fetchAndRenderMessages();
  } catch (e) {
    console.error('Failed to send board message:', e);
    showToast('Failed to send message');
  }
}

async function markBoardMsgRead(messageId) {
  try {
    await api(`/api/machine-board/${messageId}/read`, { method: 'POST' });
    const msg = boardMessages.find(m => m.id === messageId);
    if (msg) msg.read = true;
    renderBoardMessages();
    updateUnreadBadge();
  } catch (e) {
    console.error('Failed to mark read:', e);
  }
}

function updateUnreadBadge() {
  const unread = boardMessages.filter(m => !m.read).length;
  const badge = document.getElementById('msgUnreadBadge');
  if (unread > 0) {
    badge.textContent = unread;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

// ── MODAL ──
let loadedTemplates = [];

// ── SOULS (Change 1 & 3) ──
async function fetchSouls() {
  try {
    const data = await api('/api/souls');
    souls = Array.isArray(data) ? data : (data.souls || []);
  } catch (e) {
    souls = [];
  }
}

function formatSoulId(soulId) {
  if (!soulId) return '';
  // "fisher2050" -> "Fisher2050", "tim_buc" -> "Tim Buc"
  return soulId.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function getSoulName(soulId) {
  if (!soulId) return '';
  const soul = souls.find(s => s.id === soulId);
  return soul ? soul.name : formatSoulId(soulId);
}

function onSoulSelect() {
  const soulId = document.getElementById('soul-select').value;
  const preview = document.getElementById('soul-preview');
  if (!soulId) {
    preview.textContent = '';
    return;
  }
  const soul = souls.find(s => s.id === soulId);
  if (soul) {
    preview.textContent = (soul.role ? soul.role : '') + (soul.personality ? ' — ' + soul.personality.substring(0, 80) : '');
  } else {
    preview.textContent = soulId;
  }
}

// ── GIT BRANCH (Change 6) ──
async function fetchGitBranch() {
  try {
    const data = await api('/api/files/read?path=.git/HEAD');
    const content = (data.content || data || '').toString().trim();
    // "ref: refs/heads/master" -> "master"
    const match = content.match(/^ref:\s*refs\/heads\/(.+)$/);
    if (match) {
      currentBranch = match[1].trim();
    } else if (content.length === 40) {
      // Detached HEAD — show short hash
      currentBranch = content.substring(0, 7);
    }
  } catch (e) {
    currentBranch = 'unknown';
  }
}

// ── KILL ALL / KILL DONE / KILL ERRORS (Change 4) ──
async function killAll() {
  if (!agents.length) { showToast('No agents to kill'); return; }
  if (!confirm(`Kill all ${agents.length} agent(s)?`)) return;
  let killed = 0;
  for (const a of [...agents]) {
    try {
      await api(`/api/mc/agents/${a.id}`, { method: 'DELETE' });
      killed++;
    } catch (e) { /* ignore individual failures */ }
  }
  showToast(`Killed ${killed} agent(s)`);
  await fetchAgents();
  selectedAgent = null;
  renderAll();
}

async function killDone() {
  const targets = agents.filter(a => a.status === 'done' || a.status === 'idle' || a.status === 'completed');
  if (!targets.length) { showToast('No completed/idle agents'); return; }
  let killed = 0;
  for (const a of targets) {
    try {
      await api(`/api/mc/agents/${a.id}`, { method: 'DELETE' });
      killed++;
    } catch (e) { /* ignore */ }
  }
  showToast(`Killed ${killed} done agent(s)`);
  await fetchAgents();
  if (selectedAgent && !agents.find(a => a.id === selectedAgent)) selectedAgent = null;
  renderAll();
}

async function killErrors() {
  const targets = agents.filter(a => a.status === 'error' || a.status === 'failed');
  if (!targets.length) { showToast('No error agents'); return; }
  let killed = 0;
  for (const a of targets) {
    try {
      await api(`/api/mc/agents/${a.id}`, { method: 'DELETE' });
      killed++;
    } catch (e) { /* ignore */ }
  }
  showToast(`Killed ${killed} error agent(s)`);
  await fetchAgents();
  if (selectedAgent && !agents.find(a => a.id === selectedAgent)) selectedAgent = null;
  renderAll();
}

async function openSpawnModal() {
  document.getElementById('spawnModal').classList.add('visible');
  if (selectedMachine) {
    document.getElementById('spawnMachine').value = selectedMachine;
  }
  // Populate soul dropdown (Change 1)
  await fetchSouls();
  const soulSel = document.getElementById('soul-select');
  soulSel.innerHTML = '<option value="">No soul (vanilla)</option>';
  for (const s of souls) {
    soulSel.innerHTML += `<option value="${esc(s.id)}">${esc(s.name || s.id)}${s.role ? ' — ' + esc(s.role) : ''}</option>`;
  }
  document.getElementById('soul-preview').textContent = '';
  // Load templates
  try {
    const data = await api('/api/mc/templates');
    loadedTemplates = data.templates || [];
    const sel = document.getElementById('spawnTemplate');
    sel.innerHTML = '<option value="">— No template (manual config) —</option>';
    for (const t of loadedTemplates) {
      sel.innerHTML += `<option value="${t.id}">${t.name}${t.description ? ' — ' + t.description : ''}</option>`;
    }
  } catch { /* templates not available yet */ }
  // Load projects for the selected machine
  const machineId = document.getElementById('spawnMachine').value || 'local';
  loadProjectsForMachine(machineId);
}

function applyTemplate() {
  const id = document.getElementById('spawnTemplate').value;
  if (!id) return;
  const tmpl = loadedTemplates.find(t => t.id === id);
  if (!tmpl || !tmpl.config) return;
  const c = tmpl.config;
  if (c.cwd) document.getElementById('spawnCwd').value = c.cwd;
  if (c.approvalMode) document.getElementById('spawnInitMode').value = c.approvalMode;
  if (c.model) document.getElementById('spawnModel').value = c.model;
  if (c.effort) document.getElementById('spawnEffort').value = c.effort;
  if (c.maxBudgetUsd) document.getElementById('spawnBudget').value = c.maxBudgetUsd;
  if (c.systemPrompt) document.getElementById('spawnSystemPrompt').value = c.systemPrompt;
  if (c.maxTurns) document.getElementById('spawnMaxTurns').value = c.maxTurns;
  if (c.disallowedTools) document.getElementById('spawnDisallowedTools').value = c.disallowedTools.join(', ');
  if (c.allowedTools) document.getElementById('spawnAllowedTools').value = c.allowedTools.join(', ');
  if (c.mode) document.getElementById('spawnMode').value = c.mode;
  // Network policy
  if (c.networkPolicy) {
    const eco = c.networkPolicy.ecosystems || [];
    document.getElementById('ecoNpm').checked = eco.includes('npm');
    document.getElementById('ecoPip').checked = eco.includes('pip');
    document.getElementById('ecoGithub').checked = eco.includes('github');
    document.getElementById('ecoAnthropic').checked = eco.includes('anthropic');
    if (c.networkPolicy.allowedDomains) document.getElementById('spawnAllowedDomains').value = c.networkPolicy.allowedDomains.join(', ');
    if (c.networkPolicy.blockedDomains) document.getElementById('spawnBlockedDomains').value = c.networkPolicy.blockedDomains.join(', ');
  }
  showToast(`Template "${tmpl.name}" applied`);
}

function closeSpawnModal() {
  document.getElementById('spawnModal').classList.remove('visible');
  document.getElementById('folderBrowser').style.display = 'none';
  document.getElementById('addDirBrowser').style.display = 'none';
}

let folderSort = 'name';
let folderCurrentPath = '';
let folderCachedItems = [];

function getSelectedMachineId() {
  const sel = document.getElementById('spawnMachine');
  return sel ? sel.value : 'local';
}

function getSelectedMachinePlatform() {
  const machineId = getSelectedMachineId();
  const machine = machines.find(m => m.id === machineId);
  const caps = machine?.capabilities || {};
  const plat = caps.platform || caps.resources?.platform || '';
  return (typeof plat === 'string' && plat.includes('win')) ? 'win32' : 'linux';
}

function getDefaultBrowsePath() {
  const plat = getSelectedMachinePlatform();
  return plat === 'win32' ? 'C:\\Users' : '/home';
}

async function openFolderBrowser() {
  const browser = document.getElementById('folderBrowser');
  const cwdInput = document.getElementById('spawnCwd');
  const currentPath = cwdInput.value.trim() || getDefaultBrowsePath();

  browser.style.display = 'block';
  await loadFolderList(currentPath);
}

function setFolderSort(sort) {
  folderSort = sort;
  document.querySelectorAll('.fb-sort').forEach(b => {
    b.style.background = '#0a0a14';
    b.style.color = '#64748b';
  });
  const btn = document.getElementById('sort' + sort.charAt(0).toUpperCase() + sort.slice(1));
  if (btn) { btn.style.background = '#1a1a2e'; btn.style.color = '#9b4dca'; }
  renderFolderItems();
}

function reloadFolderList() {
  if (folderCurrentPath) loadFolderList(folderCurrentPath);
}

async function loadFolderList(dirPath) {
  folderCurrentPath = dirPath;
  const list = document.getElementById('folderList');
  list.innerHTML = '<div style="padding:8px;color:#64748b;">Loading...</div>';

  // Build breadcrumb nav
  const nav = document.getElementById('folderNav');
  const parts = dirPath.split(/[\\/]/).filter(Boolean);
  let navHtml = '';
  let accumulated = '';
  parts.forEach((part, i) => {
    if (i === 0 && /^[A-Za-z]:$/.test(part)) {
      accumulated = part + '\\'; // C: → C:\ (bare C: means CWD on Windows)
    } else if (i === 0 && dirPath.startsWith('/')) {
      accumulated = '/' + part;
    } else {
      accumulated += '\\' + part;
    }
    const pathForClick = accumulated.replace(/\\/g, '\\\\');
    const isLast = i === parts.length - 1;
    if (isLast) {
      navHtml += `<span style="color:#9b4dca;font-size:11px;font-weight:600;">${esc(part)}</span>`;
    } else {
      navHtml += `<span onclick="loadFolderList('${esc(pathForClick)}')" style="color:#58a6ff;font-size:11px;cursor:pointer;">${esc(part)}</span><span style="color:#484f58;font-size:11px;">/</span>`;
    }
  });
  navHtml += `<button onclick="selectFolder('${esc(dirPath).replace(/\\/g, '\\\\')}')" style="background:#3fb950;color:#000;border:none;border-radius:4px;padding:2px 10px;font-size:10px;font-weight:700;cursor:pointer;margin-left:auto;">Select This</button>`;
  nav.innerHTML = navHtml;

  try {
    const machineId = getSelectedMachineId();
    const data = await api(`/api/mc/machines/${encodeURIComponent(machineId)}/files/list?path=${encodeURIComponent(dirPath)}`);
    folderCachedItems = data.items || [];
    renderFolderItems();
  } catch (e) {
    list.innerHTML = `<div style="padding:8px;color:#f85149;">Failed to load: ${e.message}</div>`;
  }
}

function renderFolderItems() {
  const list = document.getElementById('folderList');
  const showHidden = document.getElementById('folderShowHidden')?.checked;
  const dirPath = folderCurrentPath;

  let items = folderCachedItems.filter(i => {
    if (!showHidden && i.name.startsWith('.')) return false;
    return true;
  });

  // Separate dirs and files
  let dirs = items.filter(i => i.type === 'directory');
  let files = items.filter(i => i.type === 'file');

  // Sort
  const sortFn = (a, b) => {
    if (folderSort === 'date') return (b.mtime || 0) - (a.mtime || 0);
    if (folderSort === 'type') return (a.name.split('.').pop() || '').localeCompare(b.name.split('.').pop() || '');
    return a.name.localeCompare(b.name);
  };
  dirs.sort(sortFn);
  files.sort(sortFn);

  // Parent directory link
  const parentPath = dirPath.replace(/[\\/][^\\/]+$/, '') || dirPath;
  let html = '';
  if (parentPath !== dirPath) {
    html += `<div onclick="loadFolderList('${esc(parentPath).replace(/\\/g, '\\\\')}')" style="padding:4px 8px;cursor:pointer;color:#58a6ff;border-bottom:1px solid #0d0d18;font-weight:600;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">..</div>`;
  }

  // Directories
  dirs.forEach(d => {
    const fullPath = dirPath + '\\' + d.name;
    const dateStr = d.mtime ? new Date(d.mtime).toLocaleDateString() : '';
    html += `<div onclick="loadFolderList('${esc(fullPath).replace(/\\/g, '\\\\')}')" style="padding:4px 8px;cursor:pointer;color:#e2e8f0;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">
      <span>📁 ${esc(d.name)}</span>
      <span style="color:#484f58;font-size:10px;">${dateStr}</span>
    </div>`;
  });

  // Files (dimmed, not clickable for selection but shown for context)
  files.forEach(f => {
    const dateStr = f.mtime ? new Date(f.mtime).toLocaleDateString() : '';
    const sizeStr = f.size ? (f.size > 1048576 ? (f.size/1048576).toFixed(1)+'MB' : f.size > 1024 ? (f.size/1024).toFixed(0)+'KB' : f.size+'B') : '';
    html += `<div style="padding:4px 8px;color:#484f58;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;font-size:11px;">
      <span>  ${esc(f.name)}</span>
      <span style="font-size:10px;">${sizeStr} ${dateStr}</span>
    </div>`;
  });

  if (dirs.length === 0 && files.length === 0) {
    html += '<div style="padding:8px;color:#64748b;font-style:italic;">Empty folder</div>';
  }

  list.innerHTML = html;
}

function selectFolder(path) {
  document.getElementById('spawnCwd').value = path;
  document.getElementById('folderBrowser').style.display = 'none';
  document.getElementById('folderSearchInput').value = '';
  document.getElementById('folderSearchClear').style.display = 'none';
  suggestAdditionalDirs(path);
}

// ── FOLDER SEARCH (Working Directory) ──
async function searchFolders() {
  const query = document.getElementById('folderSearchInput').value.trim();
  if (!query || query.length < 2) return;

  const list = document.getElementById('folderList');
  list.innerHTML = '<div style="padding:8px;color:#64748b;">Searching...</div>';
  document.getElementById('folderSearchClear').style.display = 'inline-block';

  // Hide sort/breadcrumbs during search
  document.getElementById('folderNav').innerHTML = `<span style="color:#9b4dca;font-size:11px;font-weight:600;">Search results for "${esc(query)}"</span>`;

  try {
    const root = document.getElementById('spawnCwd').value.trim().replace(/[\\/][^\\/]+$/, '') || getDefaultBrowsePath();
    const machineId = getSelectedMachineId();
    const data = await api(`/api/mc/machines/${encodeURIComponent(machineId)}/files/search?q=${encodeURIComponent(query)}&root=${encodeURIComponent(root)}&maxDepth=5&maxResults=25`);
    const results = data.results || [];

    if (results.length === 0) {
      list.innerHTML = '<div style="padding:8px;color:#64748b;font-style:italic;">No folders found matching "' + esc(query) + '"</div>';
      return;
    }

    let html = '';
    results.forEach(r => {
      const escapedPath = esc(r.path).replace(/\\/g, '\\\\');
      html += `<div style="padding:5px 8px;cursor:pointer;color:#e2e8f0;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">
        <span onclick="loadFolderList('${escapedPath}')" style="flex:1;cursor:pointer;display:flex;flex-direction:column;">
          <span>📁 <strong>${esc(r.name)}</strong></span>
          <span style="font-size:10px;color:#64748b;margin-top:1px;">${esc(r.path)}</span>
        </span>
        <button onclick="event.stopPropagation();selectFolder('${escapedPath}')" style="background:#3fb950;color:#000;border:none;border-radius:4px;padding:2px 10px;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap;">Select</button>
      </div>`;
    });

    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div style="padding:8px;color:#f85149;">Search failed: ${e.message}</div>`;
  }
}

function clearFolderSearch() {
  document.getElementById('folderSearchInput').value = '';
  document.getElementById('folderSearchClear').style.display = 'none';
  if (folderCurrentPath) loadFolderList(folderCurrentPath);
}

function suggestAdditionalDirs(cwdPath) {
  const addDirsInput = document.getElementById('spawnAdditionalDirs');
  // Only suggest if the field is empty (don't overwrite user entries)
  if (addDirsInput.value.trim()) return;
  // Suggest the parent directory so agent can access sibling files
  const normalized = cwdPath.replace(/\\/g, '/').replace(/\/+$/, '');
  const parent = normalized.substring(0, normalized.lastIndexOf('/'));
  if (parent && parent !== normalized) {
    addDirsInput.value = parent;
  }
}

// ── ADDITIONAL DIRECTORIES BROWSER ──
let addDirSort = 'name';
let addDirCurrentPath = '';
let addDirCachedItems = [];

async function openAddDirBrowser() {
  const browser = document.getElementById('addDirBrowser');
  const cwdInput = document.getElementById('spawnCwd');
  const startPath = cwdInput.value.trim() || 'C:\\Users\\mic';
  // Start from parent of cwd so user can pick sibling folders
  const parentPath = startPath.replace(/[\\/][^\\/]+$/, '') || startPath;
  browser.style.display = 'block';
  await loadAddDirList(parentPath);
}

function setAddDirSort(sort) {
  addDirSort = sort;
  document.querySelectorAll('.adb-sort').forEach(b => {
    b.style.background = '#0a0a14';
    b.style.color = '#64748b';
  });
  const btn = document.getElementById('addSort' + sort.charAt(0).toUpperCase() + sort.slice(1));
  if (btn) { btn.style.background = '#1a1a2e'; btn.style.color = '#9b4dca'; }
  renderAddDirItems();
}

function reloadAddDirList() {
  if (addDirCurrentPath) loadAddDirList(addDirCurrentPath);
}

async function loadAddDirList(dirPath) {
  addDirCurrentPath = dirPath;
  const list = document.getElementById('addDirList');
  list.innerHTML = '<div style="padding:8px;color:#64748b;">Loading...</div>';

  // Breadcrumb nav
  const nav = document.getElementById('addDirNav');
  const parts = dirPath.split(/[\\/]/).filter(Boolean);
  let navHtml = '';
  let accumulated = '';
  parts.forEach((part, i) => {
    if (i === 0 && /^[A-Za-z]:$/.test(part)) {
      accumulated = part + '\\';
    } else if (i === 0 && dirPath.startsWith('/')) {
      accumulated = '/' + part;
    } else {
      accumulated += '\\' + part;
    }
    const pathForClick = accumulated.replace(/\\/g, '\\\\');
    const isLast = i === parts.length - 1;
    if (isLast) {
      navHtml += `<span style="color:#9b4dca;font-size:11px;font-weight:600;">${esc(part)}</span>`;
    } else {
      navHtml += `<span onclick="loadAddDirList('${esc(pathForClick)}')" style="color:#58a6ff;font-size:11px;cursor:pointer;">${esc(part)}</span><span style="color:#484f58;font-size:11px;">/</span>`;
    }
  });
  navHtml += `<button onclick="selectAddDir('${esc(dirPath).replace(/\\/g, '\\\\')}')" style="background:#3fb950;color:#000;border:none;border-radius:4px;padding:2px 10px;font-size:10px;font-weight:700;cursor:pointer;margin-left:auto;">+ Add This</button>`;
  nav.innerHTML = navHtml;

  try {
    const machineId = getSelectedMachineId();
    const data = await api(`/api/mc/machines/${encodeURIComponent(machineId)}/files/list?path=${encodeURIComponent(dirPath)}`);
    addDirCachedItems = data.items || [];
    renderAddDirItems();
  } catch (e) {
    list.innerHTML = `<div style="padding:8px;color:#f85149;">Failed to load: ${e.message}</div>`;
  }
}

function renderAddDirItems() {
  const list = document.getElementById('addDirList');
  const showHidden = document.getElementById('addDirShowHidden')?.checked;
  const dirPath = addDirCurrentPath;

  let items = addDirCachedItems.filter(i => {
    if (!showHidden && i.name.startsWith('.')) return false;
    return true;
  });

  let dirs = items.filter(i => i.type === 'directory');
  let files = items.filter(i => i.type === 'file');

  const sortFn = (a, b) => {
    if (addDirSort === 'date') return (b.mtime || 0) - (a.mtime || 0);
    if (addDirSort === 'type') return (a.name.split('.').pop() || '').localeCompare(b.name.split('.').pop() || '');
    return a.name.localeCompare(b.name);
  };
  dirs.sort(sortFn);
  files.sort(sortFn);

  const parentPath = dirPath.replace(/[\\/][^\\/]+$/, '') || dirPath;
  let html = '';
  if (parentPath !== dirPath) {
    html += `<div onclick="loadAddDirList('${esc(parentPath).replace(/\\/g, '\\\\')}')" style="padding:4px 8px;cursor:pointer;color:#58a6ff;border-bottom:1px solid #0d0d18;font-weight:600;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">..</div>`;
  }

  dirs.forEach(d => {
    const fullPath = dirPath + '\\' + d.name;
    const escapedPath = esc(fullPath).replace(/\\/g, '\\\\');
    const dateStr = d.mtime ? new Date(d.mtime).toLocaleDateString() : '';
    html += `<div style="padding:4px 8px;cursor:pointer;color:#e2e8f0;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">
      <span onclick="loadAddDirList('${escapedPath}')" style="flex:1;cursor:pointer;">📁 ${esc(d.name)}</span>
      <span style="display:flex;align-items:center;gap:8px;">
        <span style="color:#484f58;font-size:10px;">${dateStr}</span>
        <button onclick="event.stopPropagation();selectAddDir('${escapedPath}')" style="background:#1a1a2e;color:#9b4dca;border:1px solid #2a2a3a;border-radius:3px;padding:1px 6px;font-size:10px;cursor:pointer;">+ Add</button>
      </span>
    </div>`;
  });

  files.forEach(f => {
    const dateStr = f.mtime ? new Date(f.mtime).toLocaleDateString() : '';
    const sizeStr = f.size ? (f.size > 1048576 ? (f.size/1048576).toFixed(1)+'MB' : f.size > 1024 ? (f.size/1024).toFixed(0)+'KB' : f.size+'B') : '';
    html += `<div style="padding:4px 8px;color:#484f58;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;font-size:11px;">
      <span>  ${esc(f.name)}</span>
      <span style="font-size:10px;">${sizeStr} ${dateStr}</span>
    </div>`;
  });

  if (dirs.length === 0 && files.length === 0) {
    html += '<div style="padding:8px;color:#64748b;font-style:italic;">Empty folder</div>';
  }

  list.innerHTML = html;
}

function selectAddDir(path) {
  const input = document.getElementById('spawnAdditionalDirs');
  const existing = input.value.trim();
  const currentPaths = existing ? existing.split(',').map(p => p.trim()) : [];
  if (!currentPaths.includes(path)) {
    input.value = existing ? existing + ', ' + path : path;
  }
  document.getElementById('addDirBrowser').style.display = 'none';
  document.getElementById('addDirSearchInput').value = '';
  document.getElementById('addDirSearchClear').style.display = 'none';
}

// ── FOLDER SEARCH (Additional Directories) ──
async function searchAddDirs() {
  const query = document.getElementById('addDirSearchInput').value.trim();
  if (!query || query.length < 2) return;

  const list = document.getElementById('addDirList');
  list.innerHTML = '<div style="padding:8px;color:#64748b;">Searching...</div>';
  document.getElementById('addDirSearchClear').style.display = 'inline-block';

  document.getElementById('addDirNav').innerHTML = `<span style="color:#9b4dca;font-size:11px;font-weight:600;">Search results for "${esc(query)}"</span>`;

  try {
    const root = document.getElementById('spawnCwd').value.trim().replace(/[\\/][^\\/]+$/, '') || getDefaultBrowsePath();
    const machineId = getSelectedMachineId();
    const data = await api(`/api/mc/machines/${encodeURIComponent(machineId)}/files/search?q=${encodeURIComponent(query)}&root=${encodeURIComponent(root)}&maxDepth=5&maxResults=25`);
    const results = data.results || [];

    if (results.length === 0) {
      list.innerHTML = '<div style="padding:8px;color:#64748b;font-style:italic;">No folders found matching "' + esc(query) + '"</div>';
      return;
    }

    let html = '';
    results.forEach(r => {
      const escapedPath = esc(r.path).replace(/\\/g, '\\\\');
      html += `<div style="padding:5px 8px;cursor:pointer;color:#e2e8f0;border-bottom:1px solid #0d0d18;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#1a1a2a'" onmouseout="this.style.background='transparent'">
        <span onclick="loadAddDirList('${escapedPath}')" style="flex:1;cursor:pointer;display:flex;flex-direction:column;">
          <span>📁 <strong>${esc(r.name)}</strong></span>
          <span style="font-size:10px;color:#64748b;margin-top:1px;">${esc(r.path)}</span>
        </span>
        <button onclick="event.stopPropagation();selectAddDir('${escapedPath}')" style="background:#3fb950;color:#000;border:none;border-radius:4px;padding:2px 10px;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap;">+ Add</button>
      </div>`;
    });

    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div style="padding:8px;color:#f85149;">Search failed: ${e.message}</div>`;
  }
}

function clearAddDirSearch() {
  document.getElementById('addDirSearchInput').value = '';
  document.getElementById('addDirSearchClear').style.display = 'none';
  if (addDirCurrentPath) loadAddDirList(addDirCurrentPath);
}

// ── VIEW TOGGLE ──
function setView(view) {
  currentView = view;
  document.getElementById('viewSingle').classList.toggle('active', view === 'single');
  document.getElementById('viewGrid').classList.toggle('active', view === 'grid');

  if (view === 'grid') {
    document.getElementById('terminalView').style.display = 'none';
    document.getElementById('journalView').style.display = 'none';
    document.getElementById('costTracker').style.display = 'none';
    document.getElementById('agentTabs').style.display = 'none';
    document.getElementById('gridView').classList.add('active');
    document.getElementById('centerTitle').textContent = 'All Active Agents';
    document.getElementById('centerMode').style.display = 'none';
    document.getElementById('centerActions').style.display = 'none';
    renderGridView();
  } else {
    document.getElementById('gridView').classList.remove('active');
    if (selectedAgent) {
      selectAgent(selectedAgent);
    } else if (selectedMachine) {
      selectMachine(selectedMachine);
    } else {
      document.getElementById('terminalView').style.display = 'flex';
      document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Select a machine or spawn an agent.</div>';
    }
  }
}

function renderGridView() {
  const grid = document.getElementById('gridView');

  if (agents.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#64748b;padding:60px;font-size:14px;">No active agents. Click "+ Spawn Agent" to start one.</div>';
    return;
  }

  grid.innerHTML = agents.map(a => {
    const machine = machines.find(m => m.id === a.machineId) || { name: 'LOCAL' };
    const lines = (outputBuffers[a.id] || []).slice(-20);
    const elapsed = a.createdAt ? Math.floor((Date.now() - a.createdAt) / 60000) : 0;
    const folderName = (a.cwd || a.config?.cwd || '').split(/[\\/]/).filter(Boolean).pop() || 'unknown';
    // Change 3: soul name display
    const soulName = a.soulId ? getSoulName(a.soulId) : null;
    const titleText = soulName ? soulName : folderName;
    const subtitleText = soulName ? `<span style="font-size:9px;color:#64748b;margin-left:4px;">${esc(folderName)}</span>` : '';
    // Change 2: context bar
    const ctxUsed = a.contextUsed || 0;
    const ctxWin = a.contextWindow || 0;
    const ctxPct = ctxWin > 0 ? Math.min(100, Math.round((ctxUsed / ctxWin) * 100)) : 0;
    const ctxClass = ctxPct >= 90 ? 'ctx-high' : ctxPct >= 70 ? 'ctx-med' : 'ctx-low';
    const ctxBarHtml = ctxPct > 0 ? `
      <div class="ctx-bar"><div class="ctx-bar-fill ${ctxClass}" style="width:${ctxPct}%"></div></div>
      <div class="ctx-label">${ctxPct}% ctx</div>` : '';
    // Change 6: branch badge
    const branchHtml = currentBranch !== 'unknown' ? `<span class="branch-badge">&#8903; ${esc(currentBranch)}</span>` : '';
    return `
      <div class="grid-tile ${a.status === 'waiting' ? 'waiting' : ''} ${selectedAgent === a.id ? 'selected' : ''}"
           onclick="gridTileClick('${esc(a.id)}')">
        <div class="grid-tile-header">
          <div class="grid-tile-title">
            <div class="dot ${a.status}"></div>
            <span title="${esc(a.cwd || '')}">${esc(titleText)}${subtitleText}</span>
          </div>
          <div class="grid-tile-badges">
            ${branchHtml}
            <span class="badge mode-${a.mode[0]}">${a.mode}</span>
            <span class="badge cost">$${(a.cost || 0).toFixed(2)}</span>
          </div>
        </div>
        <div class="grid-tile-body" id="gridBody-${esc(a.id)}">
          ${a.task ? `<div class="gl system" style="color:#64748b;margin-bottom:4px;">${esc(a.task.substring(0, 100))}</div>` : ''}
          ${lines.map(l => `<div class="gl ${l.type}">${l.type === 'tool' ? '<span style="color:#bc8cff;">' + esc(l.text) + '</span>' : esc(l.text)}</div>`).join('')}
          ${ctxBarHtml}
        </div>
        <div class="grid-tile-input" onclick="event.stopPropagation()">
          <input type="text" id="gridInput-${esc(a.id)}" placeholder="Message..." onkeydown="if(event.key==='Enter')gridSend('${esc(a.id)}')">
          <button onclick="gridSend('${esc(a.id)}')">Send</button>
        </div>
        <div class="grid-tile-footer">
          <span>${a.status.toUpperCase()}${a.restartCount ? ' (R' + a.restartCount + ')' : ''}</span>
          <span>${a.hasAllowlist ? '[AL]' : ''}${a.hasNetworkPolicy ? '[NP]' : ''}</span>
          <span>${a.model ? a.model.replace('claude-','').replace(/-\d{8}$/,'').substring(0,10) : 'opus'}</span>
          <span>${(a.tokensIn/1000).toFixed(0)}K in</span>
          <span>${elapsed}m</span>
        </div>
      </div>
    `;
  }).join('');

  // Auto-scroll each tile body to bottom
  agents.forEach(a => {
    const body = document.getElementById('gridBody-' + a.id);
    if (body) body.scrollTop = body.scrollHeight;
  });
}

function updateGridTileBody(sessionId) {
  const body = document.getElementById('gridBody-' + sessionId);
  if (!body) return;
  const agent = agents.find(a => a.id === sessionId);
  const lines = (outputBuffers[sessionId] || []).slice(-20);
  let html = '';
  if (agent && agent.task) {
    html += `<div class="gl system" style="color:#64748b;margin-bottom:4px;">${esc(agent.task.substring(0, 100))}</div>`;
  }
  html += lines.map(l => `<div class="gl ${l.type}">${l.type === 'tool' ? '<span style="color:#bc8cff;">' + esc(l.text) + '</span>' : esc(l.text)}</div>`).join('');
  body.innerHTML = html;
  body.scrollTop = body.scrollHeight;
}

function gridTileClick(agentId) {
  if (selectedAgent === agentId && currentView === 'grid') {
    setView('single');
    return;
  }
  selectedAgent = agentId;
  const agent = agents.find(a => a.id === agentId);
  if (agent) selectedMachine = agent.machineId || 'local';
  renderGridView();
  renderMachines();
}

async function gridSend(agentId) {
  const input = document.getElementById('gridInput-' + agentId);
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  if (!outputBuffers[agentId]) outputBuffers[agentId] = [];
  outputBuffers[agentId].push({ type: 'prompt', text: '> ' + text });
  renderGridView();

  try {
    await api(`/api/mc/agents/${agentId}/respond`, {
      method: 'POST',
      body: { choice: text },
    });
  } catch (e) {
    outputBuffers[agentId].push({ type: 'error', text: 'Failed: ' + e.message });
    renderGridView();
  }
}

// ── UTILITIES ──
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatAgo(ts) {
  const seconds = Math.floor((Date.now() - ts) / 1000);
  if (seconds < 0) return 'just now';
  if (seconds < 60) return seconds + 's ago';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  return Math.floor(seconds / 3600) + 'h ago';
}

function showToast(text) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = text;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// ── POWER MANAGEMENT ──

async function wakeMachine(machineId) {
  try {
    showToast('Sending Wake-on-LAN...');
    await api(`/api/machines/${encodeURIComponent(machineId)}/wake`, { method: 'POST' });
  } catch (err) {
    showToast('Wake failed: ' + (err.message || err));
  }
}

async function bootstrapMachine(machineId) {
  try {
    showToast('Starting PIA via SSH...');
    await api(`/api/machines/${encodeURIComponent(machineId)}/bootstrap`, { method: 'POST' });
  } catch (err) {
    showToast('Bootstrap failed: ' + (err.message || err));
  }
}

function showPowerProgress(event) {
  const toast = document.getElementById('powerProgressToast');
  document.getElementById('pptTitle').textContent = event.machineName + ' — ' + event.step.replace(/_/g, ' ');
  document.getElementById('pptMessage').textContent = event.message;
  document.getElementById('pptBarFill').style.width = event.progress + '%';
  toast.classList.add('visible');

  // Auto-hide on completion or error
  if (event.progress >= 100 || event.error) {
    setTimeout(() => toast.classList.remove('visible'), 5000);
  }
}

function closePowerToast() {
  document.getElementById('powerProgressToast').classList.remove('visible');
}

function openMachineSettings(machineId) {
  const m = machines.find(mm => mm.id === machineId);
  if (!m) return;
  const caps = m.capabilities || {};
  document.getElementById('msettMachineId').value = machineId;
  document.getElementById('msettMac').value = caps.macAddress || '';
  document.getElementById('msettTailscaleIp').value = caps.tailscaleIp || m.ip || '';
  document.getElementById('msettSshUser').value = caps.sshUser || '';
  document.getElementById('msettSshPort').value = caps.sshPort || 22;
  document.getElementById('msettPiaPath').value = caps.piaPath || '';
  document.getElementById('machineSettingsModal').classList.add('visible');
}

function closeMachineSettings() {
  document.getElementById('machineSettingsModal').classList.remove('visible');
}

async function saveMachineSettings() {
  const machineId = document.getElementById('msettMachineId').value;
  const capabilities = {
    macAddress: document.getElementById('msettMac').value.trim(),
    tailscaleIp: document.getElementById('msettTailscaleIp').value.trim(),
    sshUser: document.getElementById('msettSshUser').value.trim(),
    sshPort: parseInt(document.getElementById('msettSshPort').value) || 22,
    piaPath: document.getElementById('msettPiaPath').value.trim(),
  };
  try {
    const updated = await api(`/api/machines/${encodeURIComponent(machineId)}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ capabilities }),
    });
    // Update local state
    const idx = machines.findIndex(m => m.id === machineId);
    if (idx >= 0) {
      machines[idx] = { ...machines[idx], ...updated, capabilities: { ...(machines[idx].capabilities || {}), ...capabilities } };
    }
    closeMachineSettings();
    renderMachines();
    showToast('Machine settings saved');
  } catch (err) {
    showToast('Save failed: ' + (err.message || err));
  }
}

// Periodically check power state for offline machines
setInterval(async () => {
  for (const m of machines) {
    if (m.status !== 'online' && m.capabilities && m.capabilities.tailscaleIp) {
      try {
        const result = await api(`/api/machines/${encodeURIComponent(m.id)}/power-state`);
        if (result.powerState && result.powerState !== m.powerState) {
          m.powerState = result.powerState;
          renderMachines();
        }
      } catch { /* ignore */ }
    }
  }
}, 30000);

// ── KEYBOARD SHORTCUTS ──
document.addEventListener('keydown', (e) => {
  if (['1','2','3'].includes(e.key) && !e.ctrlKey && !e.altKey &&
      document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const pending = prompts.find(p => !p.resolved);
    if (pending && pending.options[parseInt(e.key) - 1]) {
      const btn = document.querySelector(`#prompt-${pending.id} .prompt-option-btn:nth-child(${e.key})`);
      respondToPrompt(pending.id, parseInt(e.key), pending.agentId, btn);
    }
  }
  // Escape to close modal
  if (e.key === 'Escape') closeSpawnModal();
});

// ── INIT ──
// ── BROWSER CONTROLLER ──

async function startBrowserController() {
  try {
    await api('/api/browser/controller/start', { method: 'POST' });
    showToast('Browser controller started');
    pollBcStatus();
  } catch (e) {
    showToast('Failed to start: ' + (e.message || e));
  }
}

async function stopBrowserController() {
  try {
    await api('/api/browser/controller/stop', { method: 'POST' });
    updateBcUI({ status: 'stopped', currentUrl: null, commandsExecuted: 0, geminiCallsCount: 0 });
    showToast('Browser controller stopped');
  } catch (e) {
    showToast('Failed to stop: ' + (e.message || e));
  }
}

function updateBcUI(state) {
  const statusEl = document.getElementById('bcStatus');
  const urlEl = document.getElementById('bcUrl');
  const cmdsEl = document.getElementById('bcCommands');
  const geminiEl = document.getElementById('bcGemini');
  const dot = document.getElementById('bcDot');
  const startBtn = document.getElementById('bcStartBtn');
  const stopBtn = document.getElementById('bcStopBtn');
  const ssEl = document.getElementById('bcScreenshot');

  if (statusEl) statusEl.textContent = state.status || 'stopped';
  if (urlEl) { urlEl.textContent = state.currentUrl || '-'; urlEl.title = state.currentUrl || ''; }
  if (cmdsEl) cmdsEl.textContent = state.commandsExecuted || state.commands || 0;
  if (geminiEl) geminiEl.textContent = (state.geminiCallsCount || state.geminiCalls || 0) + ' calls';

  if (dot) {
    const colors = { stopped: '#484f58', idle: '#3fb950', busy: '#d29922', starting: '#d29922', error: '#f85149' };
    dot.style.background = colors[state.status] || '#484f58';
    if (state.status === 'busy') dot.style.animation = 'pulse 1s infinite';
    else dot.style.animation = '';
  }

  if (startBtn) startBtn.disabled = state.status !== 'stopped';
  if (stopBtn) { stopBtn.disabled = state.status === 'stopped'; stopBtn.style.opacity = state.status === 'stopped' ? '0.4' : '1'; }

  if (ssEl && state.screenshotDataUrl) {
    ssEl.innerHTML = '<img src="' + state.screenshotDataUrl + '" style="max-width:100%;max-height:150px;border-radius:4px;border:1px solid #1a1a2a;">';
  }
}

async function pollBcStatus() {
  try {
    const state = await api('/api/browser/controller/status');
    updateBcUI(state);
    if (state.status !== 'stopped') setTimeout(pollBcStatus, 5000);
  } catch { /* controller not running */ }
}

async function init() {
  // Show loading
  document.getElementById('terminalOutput').innerHTML = '<div class="term-line system">Connecting to PIA...</div>';

  // Connect WebSocket
  connectWebSocket();

  // Fetch initial data (including git branch and souls)
  await Promise.all([fetchMachines(), fetchAgents(), fetchPrompts(), fetchGitBranch(), fetchSouls()]);
  renderAll();

  // Check browser controller status
  pollBcStatus();

  document.getElementById('terminalOutput').innerHTML = `
    <div class="term-line system">PIA Mission Control connected.</div>
    <div class="term-line system">${machines.length} machine(s), ${agents.length} agent(s) active.</div>
    <div class="term-line system">────────────────────────────────────────</div>
    <div class="term-line system">Click a machine or "+ Spawn Agent" to begin.</div>
  `;

  // Refresh agents every 5s
  setInterval(async () => {
    await fetchAgents();
    await fetchPrompts();
    renderStats();
    // Refresh selected agent detail
    if (selectedAgent) {
      const agent = agents.find(a => a.id === selectedAgent);
      if (agent) updateCostFooter(agent);
    }
  }, 5000);

  // Refresh timestamps
  setInterval(() => renderPrompts(), 10000);
}

init();
</script>

</body>
</html>
